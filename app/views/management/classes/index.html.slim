- content_for :page_title, t('management.classes.title')

section aria-label=t('management.classes.list_label')
  header.schools-page__header
    .schools-page__title-group
      h1 = t('management.classes.title')
      .academic-year-selector
        select#academic-year-selector.academic-year-select
          - @academic_years.each do |year|
            option value=year selected=(year == @current_academic_year) = year
    .schools-page__actions
      span.classes-count = @current_year_classes.count

  .classes-panel
    - if @current_year_classes.any?
      .classes-grid
        - @current_year_classes.each do |school_class|
          .class-card
            .class-card__header
              h3.class-card__name = school_class.name
              .class-card__actions
                button.class-card__edit type="button" data-action="edit-class" data-class-id=school_class.id data-class-name=school_class.name
                  i.bi.bi-pencil aria-hidden="true"
                  span.visually-hidden = t('management.classes.edit')
            .class-card__content
              - main_teacher = TeacherClassAssignment.joins(:teacher).where(school_class: school_class, role: 'main').first&.teacher
              - if main_teacher
                .class-card__teacher
                  span.class-card__label = "#{t('management.classes.homeroom_teacher')}:"
                  span.class-card__value = [main_teacher.first_name, main_teacher.last_name].compact.join(' ')
              - else
                .class-card__teacher
                  span.class-card__label = "#{t('management.classes.homeroom_teacher')}:"
                  span.class-card__value.class-card__value--empty = t('management.classes.not_assigned')
              - students_count = StudentClassEnrollment.joins(:school_class).where(school_classes: { id: school_class.id, year: @current_academic_year }).count
              .class-card__students
                span.class-card__label = "#{t('management.classes.students_count')}:"
                span.class-card__value = students_count
        .class-card.class-card--add
          button.class-card__add-button type="button" data-open-modal="add-class-modal"
            i.bi.bi-plus-lg aria-hidden="true"
            span = t('management.classes.add')
    - else
      .classes-empty
        p = t('management.classes.empty', year: @current_academic_year)
        button.schools-page__add type="button" data-open-modal="add-class-modal" = t('management.classes.add_first')

/ Add Class Modal
#add-class-modal.schools-modal aria-hidden="true"
  .schools-modal__overlay
  .schools-modal__dialog role="dialog" aria-modal="true" aria-labelledby="add-class-title"
    header.schools-modal__header
      h3#add-class-title = t('management.classes.add_title')
      button.schools-modal__close type="button" aria-label=t('actions.close') data-close-modal="add-class-modal"
        = image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true
    form#add-class-form.schools-modal__form
      input type="hidden" name="school_class[school_id]" value=@school&.id
      input type="hidden" name="school_class[year]" value=@current_academic_year
      label
        span
          = t('management.classes.class_name')
          sup style="color: var(--content-secondary);" *
        input#add-class-name type="text" name="school_class[name]" placeholder="4A" required=""
      label
        span = t('management.classes.homeroom_teacher_optional')
        .teacher-select-wrapper
          input#add-class-teacher-search type="text" placeholder=t('management.classes.search_homeroom') autocomplete="off"
          #add-class-teacher-dropdown.teacher-select-dropdown style="display: none;"
        #add-class-selected-teachers.selected-teachers
        input#add-class-teacher-id type="hidden" name="school_class[teacher_id]"
      label
        span = t('management.classes.teaching_staff')
        .teacher-select-wrapper
          input#add-class-staff-search type="text" placeholder=t('management.classes.search_teacher') autocomplete="off"
          #add-class-staff-dropdown.teacher-select-dropdown style="display: none;"
        #add-class-selected-staff.selected-teachers
      .schools-modal__actions
        button.schools-modal__primary type="submit" = t('common.save')
        button.schools-modal__secondary type="button" data-close-modal="add-class-modal" = t('common.cancel')

/ Edit Class Modal
#edit-class-modal.schools-modal aria-hidden="true"
  .schools-modal__overlay
  .schools-modal__dialog role="dialog" aria-modal="true" aria-labelledby="edit-class-title"
    header.schools-modal__header
      h3#edit-class-title = t('management.classes.edit_title')
      button.schools-modal__close type="button" aria-label=t('actions.close') data-close-modal="edit-class-modal"
        = image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true
    form#edit-class-form.schools-modal__form
      input#edit-class-id type="hidden" value=""
      input type="hidden" name="school_class[school_id]" value=@school&.id
      input type="hidden" name="school_class[year]" value=@current_academic_year
      label
        span
          = t('management.classes.class_name')
          sup style="color: var(--content-secondary);" *
        input#edit-class-name type="text" name="school_class[name]" placeholder="4A" required=""
      label
        span = t('management.classes.homeroom_teacher_optional')
        .teacher-select-wrapper
          input#edit-class-teacher-search type="text" placeholder=t('management.classes.search_homeroom') autocomplete="off"
          #edit-class-teacher-dropdown.teacher-select-dropdown style="display: none;"
        #edit-class-selected-teachers.selected-teachers
        input#edit-class-teacher-id type="hidden" name="school_class[teacher_id]"
      label
        span = t('management.classes.teaching_staff')
        .teacher-select-wrapper
          input#edit-class-staff-search type="text" placeholder=t('management.classes.search_teacher') autocomplete="off"
          #edit-class-staff-dropdown.teacher-select-dropdown style="display: none;"
        #edit-class-selected-staff.selected-teachers
      .schools-modal__actions
        button.schools-modal__primary type="submit" = t('common.save')
        button.schools-modal__secondary type="button" data-close-modal="edit-class-modal" = t('common.cancel')

javascript:
  document.addEventListener('DOMContentLoaded', function() {
    const CURRENT_YEAR = '#{@current_academic_year}';
    const API_BASE = '/management/classes';
    const api = typeof window.ApiClient !== 'undefined' ? new window.ApiClient() : null;
    const teachers = #{@teachers.map { |t| { id: t.id.to_s, name: [t.first_name, t.last_name].compact.join(' ') } }.to_json};

    if (!api) return;

    function setupTeacherSearch(searchInputId, dropdownId, selectedContainerId, hiddenInputId, isMultiSelect = false) {
      const searchInput = document.getElementById(searchInputId);
      const dropdown = document.getElementById(dropdownId);
      const selectedContainer = document.getElementById(selectedContainerId);
      const hiddenInput = hiddenInputId ? document.getElementById(hiddenInputId) : null;
      let selectedTeachers = [];

      if (!searchInput || !dropdown) return null;

      if (selectedContainer && selectedContainer.dataset.initialTeachers) {
        try {
          selectedTeachers = JSON.parse(selectedContainer.dataset.initialTeachers);
          renderSelectedTeachers();
        } catch (e) {}
      }

      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        if (searchTerm.length < 1) {
          dropdown.style.display = 'none';
          return;
        }

        const filtered = teachers.filter(t => 
          t.name.toLowerCase().includes(searchTerm) &&
          !selectedTeachers.some(st => String(st.id) === String(t.id))
        );

        if (filtered.length > 0) {
          dropdown.innerHTML = filtered.map(t => `
            <div class="teacher-option" data-teacher-id="${t.id}" data-teacher-name="${t.name}">${t.name}</div>
          `).join('');
          dropdown.style.display = 'block';
        } else {
          dropdown.style.display = 'none';
        }
      });

      dropdown.addEventListener('click', function(e) {
        const option = e.target.closest('.teacher-option');
        if (!option) return;

        const teacherId = option.getAttribute('data-teacher-id');
        const teacherName = option.getAttribute('data-teacher-name');
        const teacher = { id: String(teacherId), name: teacherName };

        if (isMultiSelect) {
          if (!selectedTeachers.some(st => String(st.id) === String(teacherId))) {
            selectedTeachers.push(teacher);
            renderSelectedTeachers();
          }
        } else {
          selectedTeachers = [teacher];
          if (hiddenInput) hiddenInput.value = teacherId;
          renderSelectedTeachers();
        }
        dropdown.style.display = 'none';
        searchInput.value = '';
      });

      function renderSelectedTeachers() {
        let container = selectedContainer || document.getElementById(selectedContainerId);
        if (!container) {
          setTimeout(() => {
            container = document.getElementById(selectedContainerId);
            if (container && selectedTeachers.length > 0) renderSelectedTeachers();
          }, 50);
          return;
        }

        if (isMultiSelect) {
          container.innerHTML = selectedTeachers.map(t => `
            <span class="selected-teacher" style="white-space: nowrap;">
              ${t.name}<button type="button" class="remove-teacher" data-teacher-id="${t.id}" aria-label="Remove ${t.name}">×</button>
            </span>
          `).join('');
        } else {
          container.innerHTML = selectedTeachers.length > 0 ? `
            <span class="selected-teacher" style="white-space: nowrap;">
              ${selectedTeachers[0].name}<button type="button" class="remove-teacher" data-teacher-id="${selectedTeachers[0].id}" aria-label="Remove ${selectedTeachers[0].name}">×</button>
            </span>
          ` : '';
          if (hiddenInput) hiddenInput.value = selectedTeachers.length > 0 ? selectedTeachers[0].id : '';
        }
      }

      selectedContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-teacher')) {
          const teacherId = e.target.getAttribute('data-teacher-id');
          selectedTeachers = selectedTeachers.filter(t => String(t.id) !== String(teacherId));
          if (hiddenInput && !isMultiSelect) hiddenInput.value = '';
          renderSelectedTeachers();
        }
      });

      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
        }
      });

      return {
        getSelected: () => [...selectedTeachers],
        setSelected: (teachers) => {
          selectedTeachers = teachers ? [...teachers] : [];
          setTimeout(() => renderSelectedTeachers(), 0);
        }
      };
    }

    const addTeacherSearch = setupTeacherSearch('add-class-teacher-search', 'add-class-teacher-dropdown', 'add-class-selected-teachers', 'add-class-teacher-id', false);
    const addStaffSearch = setupTeacherSearch('add-class-staff-search', 'add-class-staff-dropdown', 'add-class-selected-staff', null, true);
    const editTeacherSearch = setupTeacherSearch('edit-class-teacher-search', 'edit-class-teacher-dropdown', 'edit-class-selected-teachers', 'edit-class-teacher-id', false);
    const editStaffSearch = setupTeacherSearch('edit-class-staff-search', 'edit-class-staff-dropdown', 'edit-class-selected-staff', null, true);

    const yearSelector = document.getElementById('academic-year-selector');
    if (yearSelector) {
      yearSelector.addEventListener('change', function() {
        const selectedYear = this.value;
        if (selectedYear === CURRENT_YEAR) {
          window.location.href = '#{management_classes_path}';
        } else {
          window.location.href = '#{management_years_path}?year=' + encodeURIComponent(selectedYear);
        }
      });
    }

    // Modal handlers
    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modal = document.getElementById(btn.getAttribute('data-open-modal'));
        if (modal) {
          modal.setAttribute('aria-hidden', 'false');
          modal.classList.add('is-open');
        }
      });
    });

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const modal = document.getElementById(this.getAttribute('data-close-modal'));
        if (modal) {
          if (document.activeElement === this) this.blur();
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    document.querySelectorAll('.schools-modal__overlay').forEach(overlay => {
      overlay.addEventListener('click', function() {
        const modal = this.closest('.schools-modal');
        if (modal) {
          const focused = modal.querySelector(':focus');
          if (focused) focused.blur();
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Edit class handler
    document.querySelectorAll('[data-action="edit-class"]').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.stopPropagation();
        const classId = this.getAttribute('data-class-id');
        const className = this.getAttribute('data-class-name');
        
        document.getElementById('edit-class-id').value = classId;
        document.getElementById('edit-class-name').value = className;
        
        const editModal = document.getElementById('edit-class-modal');
        if (editModal) {
          editModal.setAttribute('aria-hidden', 'false');
          editModal.classList.add('is-open');
        }
        
        try {
          const result = await api.get(`${API_BASE}/${classId}`);
          if (result.success && result.data) {
            let attributes = result.data.data?.data?.attributes;
            if (!attributes && result.data.data?.data) attributes = result.data.data.data;
            if (!attributes) return;
            
            setTimeout(() => {
              if (attributes.main_teacher) {
                const mainTeacher = { id: attributes.main_teacher.id.toString(), name: attributes.main_teacher.name };
                if (editTeacherSearch) {
                  editTeacherSearch.setSelected([mainTeacher]);
                  const hiddenInput = document.getElementById('edit-class-teacher-id');
                  if (hiddenInput) hiddenInput.value = mainTeacher.id;
                }
              } else if (editTeacherSearch) {
                editTeacherSearch.setSelected([]);
              }
              
              if (attributes.teaching_staff && attributes.teaching_staff.length > 0) {
                const teachingStaff = attributes.teaching_staff.map(t => ({ id: t.id.toString(), name: t.name }));
                if (editStaffSearch) editStaffSearch.setSelected(teachingStaff);
              } else if (editStaffSearch) {
                editStaffSearch.setSelected([]);
              }
            }, 100);
          }
        } catch (error) {
          console.error('Error loading class data:', error);
        }
      });
    });

    // Form submissions
    const addForm = document.getElementById('add-class-form');
    if (addForm) {
      addForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(addForm);
        const selectedMainTeacher = addTeacherSearch.getSelected();
        const selectedStaff = addStaffSearch.getSelected();
        
        const data = {
          school_class: {
            school_id: formData.get('school_class[school_id]'),
            name: formData.get('school_class[name]'),
            year: formData.get('school_class[year]'),
            teacher_id: selectedMainTeacher.length > 0 ? selectedMainTeacher[0].id : null,
            teaching_staff_ids: selectedStaff.map(t => t.id)
          }
        };

        try {
          const result = await api.post(API_BASE, data);
          if (result.success) {
            window.location.reload();
          } else {
            alert('Error: ' + (result.error || 'Failed to create class'));
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      });
    }

    const editForm = document.getElementById('edit-class-form');
    if (editForm) {
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const classId = document.getElementById('edit-class-id').value;
        const formData = new FormData(editForm);
        const selectedMainTeacher = editTeacherSearch ? editTeacherSearch.getSelected() : [];
        const selectedStaff = editStaffSearch ? editStaffSearch.getSelected() : [];
        
        const data = {
          school_class: {
            school_id: formData.get('school_class[school_id]'),
            name: formData.get('school_class[name]'),
            year: formData.get('school_class[year]'),
            teacher_id: selectedMainTeacher.length > 0 ? selectedMainTeacher[0].id : null,
            teaching_staff_ids: selectedStaff.map(t => t.id)
          }
        };

        try {
          const result = await api.patch(`${API_BASE}/${classId}`, data);
          if (result.success) {
            window.location.reload();
          } else {
            alert('Error: ' + (result.error || 'Failed to update class'));
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      });
    }
  });

