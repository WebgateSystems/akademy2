<% content_for :page_title, "Teachers" %>
<%# Store asset path for JavaScript in a script tag %>
<script>
  window.TEACHERS_ASSET_PATHS = {
    buttonIcon: '<%= asset_path("icons/social/S/button-3.svg") %>',
    approveIcon: '<%= asset_path("icons/social/S/done.svg") %>',
    declineIcon: '<%= asset_path("icons/social/S/close_red.svg") %>'
  };
  window.MANAGEMENT_SCHOOL_ID = '<%= @school&.id %>';
</script>

<section aria-label="Teachers list">
  <header class="schools-page__header">
    <label class="schools-search schools-search--half">
      <span class="visually-hidden">Search teachers</span>
      <input type="search" placeholder="Search teacher" id="teachers-search-input">
      <%= image_tag "icons/social/S/search.svg", alt: "", "aria-hidden": "true", "data-theme-icon": true %>
    </label>
    <button class="schools-page__add" type="button" data-open-modal="add-teacher-modal">Add teacher</button>
  </header>
  <div class="schools-page__controls"></div>

  <div class="teachers-panel">
    <table class="teachers-table">
      <thead class="teachers-table__head">
        <tr>
          <th scope="col" class="teachers-table__heading">Teacher name</th>
          <th scope="col" class="teachers-table__heading">Birth date</th>
          <th scope="col" class="teachers-table__heading">Email</th>
          <th scope="col" class="teachers-table__heading">Phone</th>
          <th scope="col" class="teachers-table__heading">Status</th>
          <th scope="col" class="teachers-table__heading teachers-table__heading--actions">Actions</th>
        </tr>
      </thead>
      <tbody class="teachers-table__body" id="teachers-table-body">
        <!-- Teachers will be loaded via API -->
      </tbody>
    </table>
    <div id="teachers-loading-indicator" class="teachers-loading" style="display: none; padding: 20px; text-align: center;">
      <div class="spinner" style="display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--content-primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
      <span style="margin-left: 12px; color: var(--content-secondary);">Loading teachers...</span>
    </div>
    <div id="teachers-empty-message" class="text-center" style="padding: 40px; color: var(--content-secondary); display: none;">
      No teachers yet
    </div>
  </div>
</section>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<div class="schools-modal" id="add-teacher-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="add-teacher-title">
    <header class="schools-modal__header">
      <h3 id="add-teacher-title">Add teacher</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="add-teacher-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <form class="schools-modal__form headmaster-form" id="add-teacher-form">
      <input type="hidden" name="teacher[school_id]" id="add-teacher-school" value="<%= @school&.id %>">
      <label>
        <span>Teacher name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="teacher[first_name]" id="add-teacher-first-name" placeholder="First name" required>
      </label>
      <label>
        <span>Last name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="teacher[last_name]" id="add-teacher-last-name" placeholder="Last name" required>
      </label>
      <label>
        <span>Email<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="email" name="teacher[email]" id="add-teacher-email" placeholder="teacher@school.pl" required>
      </label>
      <label>
        <span>Phone</span>
        <input type="text" name="teacher[metadata][phone]" id="add-teacher-phone" placeholder="+48 XXX XXX XXX">
      </label>
      <label>
        <span>Birth date</span>
        <input type="date" name="teacher[metadata][birth_date]" id="add-teacher-birth-date">
      </label>
      <div class="schools-modal__actions">
        <button type="submit" class="schools-modal__primary">Add</button>
        <button type="button" class="schools-modal__secondary" data-close-modal="add-teacher-modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="schools-modal" id="edit-teacher-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="edit-teacher-title">
    <header class="schools-modal__header">
      <h3 id="edit-teacher-title">Edit teacher</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="edit-teacher-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <form class="schools-modal__form headmaster-form" id="edit-teacher-form">
      <input type="hidden" id="edit-teacher-id" value="">
      <input type="hidden" name="teacher[school_id]" id="edit-teacher-school" value="<%= @school&.id %>">
      <label>
        <span>Teacher name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="teacher[first_name]" id="edit-teacher-first-name" placeholder="First name" required>
      </label>
      <label>
        <span>Last name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="teacher[last_name]" id="edit-teacher-last-name" placeholder="Last name" required>
      </label>
      <label>
        <span>Email<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="email" name="teacher[email]" id="edit-teacher-email" placeholder="teacher@school.pl" required>
      </label>
      <label>
        <span>Phone</span>
        <input type="text" name="teacher[metadata][phone]" id="edit-teacher-phone" placeholder="+48 XXX XXX XXX">
      </label>
      <label>
        <span>Birth date</span>
        <input type="date" name="teacher[metadata][birth_date]" id="edit-teacher-birth-date">
      </label>
      <div class="schools-modal__actions">
        <button type="submit" class="schools-modal__primary" id="edit-teacher-save-btn">Save</button>
        <button type="button" class="schools-modal__secondary" data-close-modal="edit-teacher-modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="schools-modal" id="deactivate-teacher-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="deactivate-teacher-title">
    <header class="schools-modal__header">
      <h3 id="deactivate-teacher-title">Deactivate teacher</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="deactivate-teacher-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <div class="schools-modal__body">
      <p id="deactivate-teacher-message">Are you sure you want to deactivate <strong data-deactivate-name>this teacher</strong>? They will lose access immediately.</p>
    </div>
    <div class="schools-modal__actions">
      <button type="button" id="deactivate-teacher-confirm-btn" class="schools-modal__primary schools-modal__primary--danger">Deactivate</button>
      <button type="button" class="schools-modal__secondary" data-close-modal="deactivate-teacher-modal">Cancel</button>
    </div>
  </div>
</div>

<div class="schools-modal" id="approve-teacher-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="approve-teacher-title">
    <header class="schools-modal__header">
      <h3 id="approve-teacher-title">Approve teacher</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="approve-teacher-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <div class="schools-modal__body">
      <p id="approve-teacher-message">Are you sure you want to approve this teacher?</p>
    </div>
    <div class="schools-modal__actions">
      <button type="button" id="approve-teacher-confirm-btn" class="schools-modal__primary">Approve</button>
      <button type="button" class="schools-modal__secondary" data-close-modal="approve-teacher-modal">Cancel</button>
    </div>
  </div>
</div>

<div class="schools-modal" id="decline-teacher-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="decline-teacher-title">
    <header class="schools-modal__header">
      <h3 id="decline-teacher-title">Decline teacher</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="decline-teacher-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <div class="schools-modal__body">
      <p id="decline-teacher-message">Are you sure you want to decline and remove this teacher? This action cannot be undone.</p>
    </div>
    <div class="schools-modal__actions">
      <button type="button" id="decline-teacher-confirm-btn" class="schools-modal__primary schools-modal__primary--danger">Decline</button>
      <button type="button" class="schools-modal__secondary" data-close-modal="decline-teacher-modal">Cancel</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Infinite scroll implementation
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let allTeachers = [];
    let filteredTeachers = [];
    let isSearching = false;
    let currentSearchTerm = '';
    let searchTimeout = null;
    const perPage = 20;
    const SEARCH_MIN_LENGTH = 3;
    const tbody = document.getElementById('teachers-table-body');
    const loadingIndicator = document.getElementById('teachers-loading-indicator');
    const emptyMessage = document.getElementById('teachers-empty-message');
    const searchInput = document.getElementById('teachers-search-input');

    if (typeof window.ApiClient === 'undefined') {
      console.error('ApiClient not available. Make sure api_client.js is loaded.');
      return;
    }

    const api = new window.ApiClient();
    const API_BASE = '/management/teachers';

    // Function to render a teacher row
    function renderTeacherRow(teacher) {
      const attrs = teacher.attributes || teacher;
      const name = [attrs.first_name, attrs.last_name].filter(Boolean).join(' ') || attrs.email;
      const birthDate = attrs.birth_date || '—';
      const email = attrs.email || '—';
      const phone = attrs.phone || '—';
      const teacherId = teacher.id || attrs.id;

      const row = document.createElement('tr');
      row.className = 'teachers-table__row';
      
      const isLocked = attrs.is_locked || attrs.locked_at;
      const isConfirmed = attrs.is_confirmed || attrs.confirmed_at;
      const isAwaitingApproval = !isConfirmed;
      
      // Create cells
      const cells = [
        name, birthDate, email, phone
      ].map(text => {
        const cell = document.createElement('td');
        cell.className = 'teachers-table__cell';
        cell.textContent = text;
        return cell;
      });
      
      // Status cell
      const statusCell = document.createElement('td');
      statusCell.className = 'teachers-table__cell';
      const statusBadge = document.createElement('span');
      if (isAwaitingApproval) {
        statusBadge.textContent = 'Awaiting approval';
        statusBadge.style.color = 'var(--content-secondary)';
        statusBadge.style.fontWeight = '500';
      } else if (isLocked) {
        statusBadge.textContent = 'Inactive';
        statusBadge.style.color = 'var(--state-error)';
        statusBadge.style.fontWeight = '500';
      } else {
        statusBadge.textContent = 'Active';
        statusBadge.style.color = 'var(--state-success)';
        statusBadge.style.fontWeight = '500';
      }
      statusCell.appendChild(statusBadge);
      
      // Actions cell
      const actionsCell = document.createElement('td');
      actionsCell.className = 'teachers-table__cell teachers-table__cell--actions';
      
      const teachersActionsDiv = document.createElement('div');
      teachersActionsDiv.className = 'teachers-actions';
      
      if (isAwaitingApproval) {
        // Show approve/decline buttons for unconfirmed teachers
        const approveBtn = document.createElement('button');
        approveBtn.className = 'teacher-action teacher-action--approve js-approve-teacher';
        approveBtn.type = 'button';
        approveBtn.setAttribute('aria-label', 'Approve teacher');
        approveBtn.setAttribute('data-teacher-id', teacherId);
        approveBtn.setAttribute('data-teacher-name', name);
        const approveImg = document.createElement('img');
        approveImg.src = (typeof window.TEACHERS_ASSET_PATHS !== 'undefined' && window.TEACHERS_ASSET_PATHS.approveIcon) || '/assets/icons/social/S/done.svg';
        approveImg.alt = '';
        approveBtn.appendChild(approveImg);
        
        const declineBtn = document.createElement('button');
        declineBtn.className = 'teacher-action teacher-action--reject js-decline-teacher';
        declineBtn.type = 'button';
        declineBtn.setAttribute('aria-label', 'Decline teacher');
        declineBtn.setAttribute('data-teacher-id', teacherId);
        declineBtn.setAttribute('data-teacher-name', name);
        const declineImg = document.createElement('img');
        declineImg.src = (typeof window.TEACHERS_ASSET_PATHS !== 'undefined' && window.TEACHERS_ASSET_PATHS.declineIcon) || '/assets/icons/social/S/close_red.svg';
        declineImg.alt = '';
        declineBtn.appendChild(declineImg);
        
        teachersActionsDiv.appendChild(approveBtn);
        teachersActionsDiv.appendChild(declineBtn);
      } else {
        // Show regular menu for confirmed teachers
        const headmastersActionsDiv = document.createElement('div');
        headmastersActionsDiv.className = 'headmasters-actions';
        
        const details = document.createElement('details');
        details.className = 'headmasters-menu';
        
        const summary = document.createElement('summary');
        summary.setAttribute('aria-label', 'Open actions menu');
        const img = document.createElement('img');
        const buttonIconPath = (typeof window.TEACHERS_ASSET_PATHS !== 'undefined' && window.TEACHERS_ASSET_PATHS.buttonIcon) || '/assets/icons/social/S/button-3.svg';
        img.src = buttonIconPath;
        img.alt = '';
        img.setAttribute('data-theme-icon', 'true');
        summary.appendChild(img);
        
        const ul = document.createElement('ul');
        
        // Edit button
        const editLi = document.createElement('li');
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.setAttribute('data-action', 'edit-teacher');
        editBtn.setAttribute('data-teacher-id', teacherId);
        editBtn.setAttribute('data-teacher-first-name', attrs.first_name || '');
        editBtn.setAttribute('data-teacher-last-name', attrs.last_name || '');
        editBtn.setAttribute('data-teacher-email', attrs.email || '');
        editBtn.setAttribute('data-teacher-phone', attrs.phone || '');
        editBtn.setAttribute('data-teacher-birth-date', attrs.birth_date || '');
        editBtn.textContent = 'Edit';
        editLi.appendChild(editBtn);
        
        // Resend invite button
        const resendLi = document.createElement('li');
        const resendBtn = document.createElement('button');
        resendBtn.type = 'button';
        resendBtn.setAttribute('data-action', 'resend-invite');
        resendBtn.setAttribute('data-teacher-id', teacherId);
        resendBtn.setAttribute('data-teacher-email', attrs.email || '');
        resendBtn.textContent = 'Resend invite';
        resendLi.appendChild(resendBtn);
        
        // Deactivate/Activate button
        const deactivateLi = document.createElement('li');
        const deactivateBtn = document.createElement('button');
        deactivateBtn.type = 'button';
        deactivateBtn.setAttribute('data-action', 'deactivate-teacher');
        deactivateBtn.setAttribute('data-teacher-id', teacherId);
        deactivateBtn.setAttribute('data-teacher-name', name);
        deactivateBtn.setAttribute('data-teacher-is-locked', isLocked ? 'true' : 'false');
        deactivateBtn.textContent = isLocked ? 'Activate' : 'Deactivate';
        deactivateLi.appendChild(deactivateBtn);
        
        ul.appendChild(editLi);
        ul.appendChild(resendLi);
        ul.appendChild(deactivateLi);
        
        details.appendChild(summary);
        details.appendChild(ul);
        headmastersActionsDiv.appendChild(details);
        teachersActionsDiv.appendChild(headmastersActionsDiv);
      }
      
      actionsCell.appendChild(teachersActionsDiv);
      
      cells.forEach(cell => row.appendChild(cell));
      row.appendChild(statusCell);
      row.appendChild(actionsCell);
      
      return row;
    }

    // Function to load teachers from API
    async function loadTeachers(page = 1, searchTerm = '') {
      if (isLoading || (!hasMore && page > 1)) return;

      isLoading = true;
      loadingIndicator.style.display = 'block';

      try {
        let url = `${API_BASE}?page=${page}&per_page=${perPage}`;
        if (searchTerm && searchTerm.length >= SEARCH_MIN_LENGTH) {
          url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        const result = await api.get(url);
        
        if (result.success && result.data) {
          const responseData = result.data;
          let teachers = [];
          
          // JSON:API format: result.data.data.data (nested structure)
          // HandleStatusCode wraps: { success: true, data: { data: [...], pagination: {...} } }
          if (responseData.data?.data && Array.isArray(responseData.data.data)) {
            teachers = responseData.data.data;
          } else if (responseData.data && Array.isArray(responseData.data)) {
            teachers = responseData.data;
          } else if (Array.isArray(responseData)) {
            teachers = responseData;
          }
          
          const pagination = responseData.data?.pagination || responseData.pagination || {};

          if (page === 1) {
            allTeachers = [];
            tbody.innerHTML = '';
          }

          allTeachers = allTeachers.concat(teachers);
          filteredTeachers = allTeachers;

          teachers.forEach(teacher => {
            tbody.appendChild(renderTeacherRow(teacher));
          });

          hasMore = pagination.has_more || false;
          currentPage = page;

          if (allTeachers.length === 0) {
            emptyMessage.style.display = 'block';
          } else {
            emptyMessage.style.display = 'none';
          }

          setupTeacherMenus();
          setupEditTeacherHandler();
          setupResendInviteHandler();
          setupDeactivateTeacherHandler();
          setupApproveTeacherHandler();
          setupDeclineTeacherHandler();
        } else {
          console.error('Failed to load teachers:', result);
          if (result.error) {
            alert('Error loading teachers: ' + result.error);
          }
          emptyMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading teachers:', error);
        alert('Error loading teachers: ' + error.message);
        emptyMessage.style.display = 'block';
      } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // Infinite scroll handler
    function handleScroll() {
      if (isLoading || !hasMore) return;
      
      if (isSearching && currentSearchTerm.length < SEARCH_MIN_LENGTH) {
        return;
      }

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      if (scrollTop + windowHeight >= documentHeight - 200) {
        loadTeachers(currentPage + 1, currentSearchTerm);
      }
    }

    let scrollTimeout;
    window.addEventListener('scroll', function() {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = setTimeout(handleScroll, 100);
    });

    // Search/filter functionality
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        currentSearchTerm = searchTerm;
        
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        if (!searchTerm) {
          isSearching = false;
          currentPage = 1;
          hasMore = true;
          allTeachers = [];
          tbody.innerHTML = '';
          loadTeachers(1);
          return;
        }

        if (searchTerm.length >= SEARCH_MIN_LENGTH) {
          isSearching = true;
          searchTimeout = setTimeout(() => {
            currentPage = 1;
            hasMore = true;
            allTeachers = [];
            tbody.innerHTML = '';
            loadTeachers(1, searchTerm);
          }, 300);
        } else {
          isSearching = true;
          const searchTermLower = searchTerm.toLowerCase();
          
          filteredTeachers = allTeachers.filter(teacher => {
            const attrs = teacher.attributes || teacher;
            const name = [attrs.first_name, attrs.last_name].filter(Boolean).join(' ').toLowerCase() || (attrs.email || '').toLowerCase();
            const birthDate = (attrs.birth_date || '').toLowerCase();
            const email = (attrs.email || '').toLowerCase();
            const phone = (attrs.phone || '').toLowerCase();
            const isLocked = attrs.is_locked || attrs.locked_at;
            const status = isLocked ? 'inactive' : 'active';

            return name.includes(searchTermLower) ||
                   birthDate.includes(searchTermLower) ||
                   email.includes(searchTermLower) ||
                   phone.includes(searchTermLower) ||
                   status.includes(searchTermLower);
          });

          tbody.innerHTML = '';
          filteredTeachers.forEach(teacher => {
            tbody.appendChild(renderTeacherRow(teacher));
          });

          if (filteredTeachers.length === 0) {
            emptyMessage.style.display = 'block';
          } else {
            emptyMessage.style.display = 'none';
          }

          setupTeacherMenus();
        }
      });
    }

    // Load initial teachers
    loadTeachers(1);

    // Handle teacher menu positioning (same as admin)
    function setupTeacherMenus() {
      const menus = document.querySelectorAll('.headmasters-menu');
      const tbody = document.querySelector('.teachers-table__body');
      if (!tbody) return;

      menus.forEach((menu) => {
        const summary = menu.querySelector('summary');
        if (!summary) return;

        menu.addEventListener('toggle', function() {
          if (menu.open) {
            menus.forEach(m => {
              if (m !== menu && m.open) {
                m.open = false;
              }
            });

            requestAnimationFrame(() => {
              const summaryRect = summary.getBoundingClientRect();
              const ul = menu.querySelector('ul');
              if (!ul) return;

              const ulHeight = ul.offsetHeight || 150;
              const spaceBelow = window.innerHeight - summaryRect.bottom;
              const spaceAbove = summaryRect.top;
              const row = menu.closest('tr');
              const rows = Array.from(tbody.querySelectorAll('tr'));
              const rowIndex = rows.indexOf(row);
              const totalRows = rows.length;

              ul.style.position = 'fixed';
              ul.style.zIndex = '999999';
              ul.style.isolation = 'isolate';
              ul.style.transform = 'translateZ(0)';
              ul.style.willChange = 'transform';
              
              if (totalRows === 1) {
                menu.removeAttribute('data-menu-align');
                ul.style.top = (summaryRect.bottom + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.bottom = 'auto';
              } else if (spaceBelow < ulHeight + 20 && spaceAbove > ulHeight + 20 && rowIndex >= totalRows - 2) {
                menu.setAttribute('data-menu-align', 'top');
                ul.style.bottom = (window.innerHeight - summaryRect.top + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.top = 'auto';
              } else {
                menu.removeAttribute('data-menu-align');
                ul.style.top = (summaryRect.bottom + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.bottom = 'auto';
              }
            });
          } else {
            const ul = menu.querySelector('ul');
            if (ul) {
              ul.style.position = '';
              ul.style.top = '';
              ul.style.bottom = '';
              ul.style.right = '';
              ul.style.zIndex = '';
              ul.style.transform = '';
              ul.style.willChange = '';
            }
          }
        });

        const ul = menu.querySelector('ul');
        if (ul) {
          ul.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      });

      let clickHandler = function(e) {
        if (!e.target.closest('.headmasters-menu')) {
          menus.forEach(m => {
            if (m.open) {
              m.open = false;
            }
          });
        }
      };
      
      document.addEventListener('click', clickHandler, true);
    }

    setupTeacherMenus();

    // Modal handlers
    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-open-modal');
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.setAttribute('aria-hidden', 'false');
          modal.classList.add('is-open');
        }
      });
    });

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-close-modal');
        const modal = document.getElementById(modalId);
        if (modal) {
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) {
            focusedElement.blur();
          }
          
          if (modalId === 'deactivate-teacher-modal') {
            const confirmBtn = document.getElementById('deactivate-teacher-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Deactivate';
            }
            deactivateTeacherId = null;
          } else if (modalId === 'approve-teacher-modal') {
            const confirmBtn = document.getElementById('approve-teacher-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Approve';
            }
            approveTeacherId = null;
          } else if (modalId === 'decline-teacher-modal') {
            const confirmBtn = document.getElementById('decline-teacher-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Decline';
            }
            declineTeacherId = null;
          }
          
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    document.querySelectorAll('.schools-modal__overlay').forEach(overlay => {
      overlay.addEventListener('click', function() {
        const modal = this.closest('.schools-modal');
        if (modal) {
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) {
            focusedElement.blur();
          }
          
          if (modal.id === 'deactivate-teacher-modal' || modal.id === 'approve-teacher-modal' || modal.id === 'decline-teacher-modal') {
            const confirmBtn = document.getElementById('deactivate-teacher-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Deactivate';
            }
            deactivateTeacherId = null;
          }
          
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Edit teacher button handler
    function setupEditTeacherHandler() {
      if (tbody) {
        tbody.removeEventListener('click', handleEditTeacherClick, true);
        tbody.addEventListener('click', handleEditTeacherClick, true);
      }
    }

    async function handleEditTeacherClick(e) {
      const btn = e.target.closest('[data-action="edit-teacher"]');
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const modal = document.getElementById('edit-teacher-modal');
      if (!modal) {
        console.error('Edit teacher modal not found');
        return;
      }

      const teacherId = btn.getAttribute('data-teacher-id');
      if (!teacherId) {
        console.error('Teacher ID not found');
        return;
      }

      const firstName = btn.getAttribute('data-teacher-first-name') || '';
      const lastName = btn.getAttribute('data-teacher-last-name') || '';
      const email = btn.getAttribute('data-teacher-email') || '';
      const phone = btn.getAttribute('data-teacher-phone') || '';
      const birthDate = btn.getAttribute('data-teacher-birth-date') || '';

      const idField = document.getElementById('edit-teacher-id');
      if (idField) idField.value = teacherId || '';

      const firstNameField = document.getElementById('edit-teacher-first-name');
      if (firstNameField) firstNameField.value = firstName;

      const lastNameField = document.getElementById('edit-teacher-last-name');
      if (lastNameField) lastNameField.value = lastName;

      const emailField = document.getElementById('edit-teacher-email');
      if (emailField) emailField.value = email;

      const phoneField = document.getElementById('edit-teacher-phone');
      if (phoneField) phoneField.value = phone;

      const birthDateField = document.getElementById('edit-teacher-birth-date');
      if (birthDateField && birthDate && birthDate.trim() !== '') {
        const parts = birthDate.split('.');
        if (parts.length === 3) {
          const [day, month, year] = parts;
          birthDateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
      }

      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('is-open');

      // Fetch full teacher data from API
      try {
        const result = await api.get(`${API_BASE}/${teacherId}`);
        const birthDateField = document.getElementById('edit-teacher-birth-date');
        
        if (result.success && result.data && birthDateField) {
          let teacherData = null;
          
          if (result.data.data && result.data.data.attributes) {
            teacherData = result.data.data.attributes;
          } else if (result.data.attributes) {
            teacherData = result.data.attributes;
          } else if (result.data.birth_date !== undefined) {
            teacherData = result.data;
          }
          
          if (teacherData && teacherData.birth_date) {
            const parts = teacherData.birth_date.split('.');
            if (parts.length === 3) {
              const [day, month, year] = parts;
              birthDateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
          }
        }
      } catch (error) {
        console.error('Error fetching teacher data:', error);
      }

      const saveBtn = document.getElementById('edit-teacher-save-btn');
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.removeAttribute('aria-disabled');
        saveBtn.classList.remove('is-disabled');
      }

      const form = document.getElementById('edit-teacher-form');
      if (form) {
        const formInputs = form.querySelectorAll('input, select');
        const enableSaveBtn = () => {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.removeAttribute('aria-disabled');
            saveBtn.classList.remove('is-disabled');
          }
        };
        
        formInputs.forEach(input => {
          const newInput = input.cloneNode(true);
          input.parentNode.replaceChild(newInput, input);
          newInput.addEventListener('input', enableSaveBtn);
          newInput.addEventListener('change', enableSaveBtn);
        });
      }

      const menu = btn.closest('.headmasters-menu');
      if (menu) menu.open = false;
    }

    setupEditTeacherHandler();

    // Form submission handlers
    if (typeof window.ApiClient === 'undefined') {
      console.error('ApiClient not available. Make sure api_client.js is loaded.');
    } else {
      const api = new window.ApiClient();

      // Add teacher form submission
      const addForm = document.getElementById('add-teacher-form');
      if (addForm) {
        addForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = addForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Adding...';

          try {
            const formData = new FormData(addForm);
            
            const birthDateRaw = formData.get('teacher[metadata][birth_date]') || '';
            let birthDate = '';
            if (birthDateRaw) {
              const dateParts = birthDateRaw.split('-');
              if (dateParts.length === 3) {
                const [year, month, day] = dateParts;
                birthDate = `${day}.${month}.${year}`;
              }
            }
            
            const data = {
              teacher: {
                school_id: window.MANAGEMENT_SCHOOL_ID || formData.get('teacher[school_id]'),
                first_name: formData.get('teacher[first_name]'),
                last_name: formData.get('teacher[last_name]'),
                email: formData.get('teacher[email]'),
                metadata: {
                  phone: formData.get('teacher[metadata][phone]') || '',
                  birth_date: birthDate
                }
              }
            };

            const result = await api.post(API_BASE, data);
            
            if (result.success) {
              const modal = document.getElementById('add-teacher-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
                addForm.reset();
              }
              currentPage = 1;
              hasMore = true;
              allTeachers = [];
              currentSearchTerm = '';
              searchInput.value = '';
              loadTeachers(1);
            } else {
              console.error('API error:', result.error);
              alert('Error: ' + String(result.error || 'Failed to create teacher'));
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Edit teacher form submission
      const editForm = document.getElementById('edit-teacher-form');
      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = editForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          const teacherIdField = document.getElementById('edit-teacher-id');
          
          if (!teacherIdField || !teacherIdField.value) {
            alert('Error: Teacher ID is missing');
            return;
          }
          
          const teacherId = teacherIdField.value;
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';

          try {
            const formData = new FormData(editForm);
            
            const birthDateRaw = formData.get('teacher[metadata][birth_date]') || '';
            let birthDate = '';
            if (birthDateRaw) {
              const dateParts = birthDateRaw.split('-');
              if (dateParts.length === 3) {
                const [year, month, day] = dateParts;
                birthDate = `${day}.${month}.${year}`;
              }
            }
            
            const data = {
              teacher: {
                school_id: window.MANAGEMENT_SCHOOL_ID || formData.get('teacher[school_id]'),
                first_name: formData.get('teacher[first_name]'),
                last_name: formData.get('teacher[last_name]'),
                email: formData.get('teacher[email]'),
                metadata: {
                  phone: formData.get('teacher[metadata][phone]') || '',
                  birth_date: birthDate
                }
              }
            };

            const result = await api.patch(`${API_BASE}/${teacherId}`, data);
            
            if (result.success) {
              const modal = document.getElementById('edit-teacher-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              currentPage = 1;
              hasMore = true;
              allTeachers = [];
              currentSearchTerm = '';
              searchInput.value = '';
              loadTeachers(1);
            } else {
              console.error('API error:', result.error);
              alert('Error: ' + String(result.error || 'Failed to update teacher'));
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Resend invite handler
      function setupResendInviteHandler() {
        tbody.removeEventListener('click', handleResendInviteClick, true);
        tbody.addEventListener('click', handleResendInviteClick, true);
      }

      async function handleResendInviteClick(e) {
        const btn = e.target.closest('[data-action="resend-invite"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        const teacherId = btn.getAttribute('data-teacher-id');
        
        if (!teacherId) {
          console.error('Error: Teacher ID is missing');
          return;
        }
        
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        
        try {
          const result = await api.post(`${API_BASE}/${teacherId}/resend_invite`, {});
          
          if (result.success) {
            btn.textContent = 'Sent!';
            btn.style.color = 'var(--state-success)';
            
            const menu = btn.closest('.headmasters-menu');
            if (menu) menu.open = false;
            
            setTimeout(() => {
              btn.disabled = false;
              btn.textContent = originalText;
              btn.style.color = '';
            }, 2000);
          } else {
            console.error('Error:', result.error || 'Failed to resend invite');
            btn.disabled = false;
            btn.textContent = originalText;
          }
        } catch (error) {
          console.error('Resend invite error:', error);
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      setupResendInviteHandler();

      // Deactivate teacher handler
      let deactivateTeacherId = null;
      
      function setupDeactivateTeacherHandler() {
        tbody.removeEventListener('click', handleDeactivateTeacherClick, true);
        tbody.addEventListener('click', handleDeactivateTeacherClick, true);
      }

      function handleDeactivateTeacherClick(e) {
        const btn = e.target.closest('[data-action="deactivate-teacher"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        deactivateTeacherId = btn.getAttribute('data-teacher-id');
        const name = btn.getAttribute('data-teacher-name') || '';
        const isLocked = btn.getAttribute('data-teacher-is-locked') === 'true';
        
        const deactivateNameEl = document.querySelector('[data-deactivate-name]');
        if (deactivateNameEl) {
          deactivateNameEl.textContent = name;
        }
        
        const modalTitle = document.getElementById('deactivate-teacher-title');
        const modalMessage = document.getElementById('deactivate-teacher-message');
        const confirmBtn = document.getElementById('deactivate-teacher-confirm-btn');
        
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.removeAttribute('aria-disabled');
        }
        
        if (isLocked) {
          if (modalTitle) modalTitle.textContent = 'Activate teacher';
          if (modalMessage) modalMessage.textContent = `Are you sure you want to activate ${name}? They will regain access immediately.`;
          if (confirmBtn) {
            confirmBtn.textContent = 'Activate';
            confirmBtn.classList.remove('schools-modal__primary--danger');
          }
        } else {
          if (modalTitle) modalTitle.textContent = 'Deactivate teacher';
          if (modalMessage) modalMessage.textContent = `Are you sure you want to deactivate ${name}? They will lose access immediately.`;
          if (confirmBtn) {
            confirmBtn.textContent = 'Deactivate';
            confirmBtn.classList.add('schools-modal__primary--danger');
          }
        }
        
        const menu = btn.closest('.headmasters-menu');
        if (menu) menu.open = false;
        
        const deactivateModal = document.getElementById('deactivate-teacher-modal');
        if (deactivateModal) {
          deactivateModal.setAttribute('aria-hidden', 'false');
          deactivateModal.classList.add('is-open');
        }
      }

      setupDeactivateTeacherHandler();

      // Deactivate teacher confirm
      const deactivateBtn = document.getElementById('deactivate-teacher-confirm-btn');
      if (deactivateBtn) {
        deactivateBtn.addEventListener('click', async () => {
          if (!deactivateTeacherId) return;
          
          const originalText = deactivateBtn.textContent;
          deactivateBtn.disabled = true;
          deactivateBtn.textContent = 'Processing...';

          try {
            const result = await api.post(`${API_BASE}/${deactivateTeacherId}/lock`, {});
            
            if (result.success) {
              const modal = document.getElementById('deactivate-teacher-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              
              const triggerBtn = Array.from(document.querySelectorAll('[data-action="deactivate-teacher"]'))
                .find(btn => btn.getAttribute('data-teacher-id') === deactivateTeacherId);
              
              if (triggerBtn) {
                const wasLocked = triggerBtn.getAttribute('data-teacher-is-locked') === 'true';
                const newLockedStatus = !wasLocked;
                
                const row = triggerBtn.closest('tr');
                if (row) {
                  const statusCell = row.querySelector('td:nth-child(6)');
                  if (statusCell) {
                    const statusBadge = statusCell.querySelector('span');
                    if (statusBadge) {
                      if (newLockedStatus) {
                        statusBadge.textContent = 'Inactive';
                        statusBadge.style.color = 'var(--state-error)';
                      } else {
                        statusBadge.textContent = 'Active';
                        statusBadge.style.color = 'var(--state-success)';
                      }
                    }
                  }
                  
                  triggerBtn.textContent = newLockedStatus ? 'Activate' : 'Deactivate';
                  triggerBtn.setAttribute('data-teacher-is-locked', newLockedStatus ? 'true' : 'false');
                }
                
                const teacherIndex = allTeachers.findIndex(t => {
                  const attrs = t.attributes || t;
                  const id = t.id || attrs.id;
                  return id === deactivateTeacherId;
                });
                
                if (teacherIndex !== -1) {
                  const teacher = allTeachers[teacherIndex];
                  const attrs = teacher.attributes || teacher;
                  
                  if (teacher.attributes) {
                    teacher.attributes.is_locked = newLockedStatus;
                    teacher.attributes.locked_at = newLockedStatus ? new Date().toISOString() : null;
                  } else if (attrs) {
                    attrs.is_locked = newLockedStatus;
                    attrs.locked_at = newLockedStatus ? new Date().toISOString() : null;
                  }
                }
              } else {
                currentPage = 1;
                hasMore = true;
                allTeachers = [];
                currentSearchTerm = '';
                if (searchInput) searchInput.value = '';
                loadTeachers(1);
              }
            } else {
              alert('Error: ' + String(result.error || 'Failed to update teacher status'));
              deactivateBtn.disabled = false;
              deactivateBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Deactivate error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            deactivateBtn.disabled = false;
            deactivateBtn.textContent = originalText;
          }
        });
      }

      // Approve teacher handler
      let approveTeacherId = null;
      
      function setupApproveTeacherHandler() {
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.js-approve-teacher')) return;
          
          const btn = e.target.closest('.js-approve-teacher');
          approveTeacherId = btn.getAttribute('data-teacher-id');
          const name = btn.getAttribute('data-teacher-name') || 'this teacher';
          
          const modalTitle = document.getElementById('approve-teacher-title');
          const modalMessage = document.getElementById('approve-teacher-message');
          const confirmBtn = document.getElementById('approve-teacher-confirm-btn');
          
          if (modalTitle) modalTitle.textContent = 'Approve teacher';
          if (modalMessage) modalMessage.textContent = `Are you sure you want to approve ${name}?`;
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.removeAttribute('aria-disabled');
          }
          
          const modal = document.getElementById('approve-teacher-modal');
          if (modal) {
            modal.setAttribute('aria-hidden', 'false');
            modal.classList.add('is-open');
          }
        });
      }
      setupApproveTeacherHandler();

      // Function to update notification counters
      function updateNotificationCounters() {
        // Update header counter
        const headerCounter = document.querySelector('.dashboard-top-actions .notification-counter');
        if (headerCounter) {
          const currentCount = parseInt(headerCounter.textContent) || 0;
          const newCount = Math.max(0, currentCount - 1);
          if (newCount > 0) {
            headerCounter.textContent = newCount;
            headerCounter.style.display = '';
          } else {
            headerCounter.style.display = 'none';
          }
        }

        // Update sidebar counter
        const sidebarCounter = document.querySelector('.dashboard-nav__button[href*="teachers"] .notification-counter');
        if (sidebarCounter) {
          const currentCount = parseInt(sidebarCounter.textContent) || 0;
          const newCount = Math.max(0, currentCount - 1);
          if (newCount > 0) {
            sidebarCounter.textContent = newCount;
            sidebarCounter.style.display = '';
          } else {
            sidebarCounter.style.display = 'none';
          }
        }
      }

      // Approve teacher confirm
      const approveBtn = document.getElementById('approve-teacher-confirm-btn');
      if (approveBtn) {
        approveBtn.addEventListener('click', async () => {
          if (!approveTeacherId) return;
          
          const originalText = approveBtn.textContent;
          approveBtn.disabled = true;
          approveBtn.textContent = 'Processing...';

          try {
            const result = await api.post(`${API_BASE}/${approveTeacherId}/approve`, {});
            
            if (result.success) {
              const modal = document.getElementById('approve-teacher-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              
              // Update notification counters
              updateNotificationCounters();
              
              // Reload teachers list
              allTeachers = [];
              currentPage = 1;
              hasMore = true;
              await loadTeachers(1, currentSearchTerm);
            } else {
              alert('Error: ' + String(result.error || 'Failed to approve teacher'));
              approveBtn.disabled = false;
              approveBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Approve error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            approveBtn.disabled = false;
            approveBtn.textContent = originalText;
          }
        });
      }

      // Decline teacher handler
      let declineTeacherId = null;
      
      function setupDeclineTeacherHandler() {
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.js-decline-teacher')) return;
          
          const btn = e.target.closest('.js-decline-teacher');
          declineTeacherId = btn.getAttribute('data-teacher-id');
          const name = btn.getAttribute('data-teacher-name') || 'this teacher';
          
          const modalTitle = document.getElementById('decline-teacher-title');
          const modalMessage = document.getElementById('decline-teacher-message');
          const confirmBtn = document.getElementById('decline-teacher-confirm-btn');
          
          if (modalTitle) modalTitle.textContent = 'Decline teacher';
          if (modalMessage) modalMessage.textContent = `Are you sure you want to decline and remove ${name}? This action cannot be undone.`;
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.removeAttribute('aria-disabled');
          }
          
          const modal = document.getElementById('decline-teacher-modal');
          if (modal) {
            modal.setAttribute('aria-hidden', 'false');
            modal.classList.add('is-open');
          }
        });
      }
      setupDeclineTeacherHandler();

      // Decline teacher confirm
      const declineBtn = document.getElementById('decline-teacher-confirm-btn');
      if (declineBtn) {
        declineBtn.addEventListener('click', async () => {
          if (!declineTeacherId) return;
          
          const originalText = declineBtn.textContent;
          declineBtn.disabled = true;
          declineBtn.textContent = 'Processing...';

          try {
            const result = await api.post(`${API_BASE}/${declineTeacherId}/decline`, {});
            
            if (result.success) {
              const modal = document.getElementById('decline-teacher-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              
              // Reload teachers list
              allTeachers = [];
              currentPage = 1;
              hasMore = true;
              await loadTeachers(1, currentSearchTerm);
            } else {
              alert('Error: ' + String(result.error || 'Failed to decline teacher'));
              declineBtn.disabled = false;
              declineBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Decline error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            declineBtn.disabled = false;
            declineBtn.textContent = originalText;
          }
        });
      }
    }
  });
</script>

