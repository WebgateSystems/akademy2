<div class="dashboard-app" data-dashboard-app>
  <%= render 'dashboard/sidebar', nav_path_helper: ->(school_class) { dashboard_path(class_id: school_class.id) } %>

  <main class="dashboard-main">
    <%= render 'dashboard/top_bar' %>

    <% if @classes.any? %>
      <div class="school-profile" data-state="filled">
        <section class="school-profile-hero" aria-label="Invite students to your class">
          <div class="school-profile-hero__text">
            <h2>Let's build your class together!</h2>
            <p>Download the QR code or share the school code so your students can join your class.</p>
            <div class="school-profile-hero__actions">
              <button class="school-profile-hero__button school-profile-hero__button--primary" type="button" id="download-qr-btn">Download</button>
              <button class="school-profile-hero__button" type="button" id="copy-code-btn">Copy code</button>
            </div>
          </div>

          <div class="school-profile-hero__visuals">
            <div class="school-profile-hero__qr" id="qr-code-container">
              <%= image_tag "icons/social/L/QR-code.svg",
                width: 250,
                height: 250,
                alt: "",
                id: "qr-code-image",
                data: { theme_icon: true } %>
            </div>

            <div class="school-profile-hero__stats" aria-labelledby="teacher-stats-heading">
              <h3 id="teacher-stats-heading" class="visually-hidden">Teacher and pupil counters</h3>

              <article class="school-profile-hero__stat-card" data-entity="pupils">
                <div class="school-profile-hero__stat-label">
                  <h4 class="stat-label">Pupils</h4>
                </div>
                <div class="school-profile-hero__stat-value">
                  <span class="stat-value stat-value--empty">0</span>
                  <span class="stat-value stat-value--filled"><%= @students_count || 0 %></span>
                  <% if @students_awaiting && @students_awaiting > 0 %>
                    <span class="stat-awaiting"><%= @students_awaiting %> awaiting</span>
                  <% end %>
                </div>
              </article>

              <article class="school-profile-hero__stat-card" data-entity="videos">
                <div class="school-profile-hero__stat-label">
                  <h4 class="stat-label">Pupil videos</h4>
                </div>
                <div class="school-profile-hero__stat-value">
                  <span class="stat-value stat-value--empty">0</span>
                  <span class="stat-value stat-value--filled"><%= @videos_count || 0 %></span>
                </div>
              </article>
            </div>
          </div>
        </section>

        <section class="class-results" aria-label="Pupil results">
          <h2>Pupil results</h2>
          <div class="class-results__grid" data-subjects-grid>
            <% if @subjects.any? %>
              <% colors = %w[blue green yellow pink orange purple lime] %>
              <% @subjects.each_with_index do |subject, index| %>
                <% stats = @subject_stats&.dig(subject.id) || {} %>
                <% completion = stats[:completion_rate] || 0 %>
                <%= link_to dashboard_quiz_results_path(subject, class_id: @current_class&.id), 
                            class: "class-result class-result--#{colors[index % colors.length]}",
                            data: { subject_id: subject.id } do %>
                  <span class="class-result__progress" data-subject-progress="<%= subject.id %>"><%= completion %>%</span>
                  <div class="class-result__icon" aria-hidden="true">
                    <% icons = %w[üáµüá± üåç üîî üèÉ‚Äç‚ôÇÔ∏è ‚ù§Ô∏è‚Äçü©π üíª üõ°Ô∏è] %>
                    <%= icons[index % icons.length] %>
                  </div>
                  <h3><%= subject.title %></h3>
                <% end %>
              <% end %>
            <% else %>
              <p class="class-results__empty">Brak dostƒôpnych przedmiot√≥w</p>
            <% end %>
          </div>
        </section>
      </div>
    <% else %>
      <div class="dashboard-empty-state">
        <div class="dashboard-empty-state__content">
          <div class="dashboard-empty-state__icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <h2>Brak przypisanych klas</h2>
          <p>
            Nie masz jeszcze przypisanej ≈ºadnej klasy do prowadzenia.
            <br>
            Popro≈õ administracjƒô szko≈Çy o przypisanie Ciƒô do klasy, aby m√≥c korzystaƒá z pe≈Çnych funkcji dashboardu.
          </p>
          <% if can_access_management? %>
            <div class="dashboard-empty-state__actions">
              <%= link_to "Przejd≈∫ do panelu zarzƒÖdzania", management_classes_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </main>
</div>

<script>
  // QR Code URL for students
  const qrCodeUrl = '<%= register_student_url(school_slug: @school&.slug) rescue "#" %>';
  const schoolSlug = '<%= @school&.slug %>';

  // Load QR code based on theme
  function loadQRCode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark' ||
                   (document.documentElement.getAttribute('data-theme') === 'auto' &&
                    window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    const qrImage = document.getElementById('qr-code-image');
    if (qrImage && schoolSlug) {
      // Generate QR code URL with theme and cache-busting timestamp
      const theme = isDark ? 'dark' : 'light';
      const qrSvgUrl = '<%= management_qr_code_svg_path %>' + '?theme=' + theme + '&t=' + Date.now();
      qrImage.src = qrSvgUrl;
      qrImage.style.display = 'block';
    }
  }

  // Download QR code
  document.getElementById('download-qr-btn')?.addEventListener('click', function() {
    if (!schoolSlug) return;
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark' ||
                   (document.documentElement.getAttribute('data-theme') === 'auto' &&
                    window.matchMedia('(prefers-color-scheme: dark)').matches);
    const qrPngUrl = '<%= management_qr_code_png_path %>' + '?theme=' + (isDark ? 'dark' : 'light');
    const link = document.createElement('a');
    link.href = qrPngUrl;
    link.download = 'qr-code-' + schoolSlug + '.png';
    link.click();
  });

  // Copy code
  document.getElementById('copy-code-btn')?.addEventListener('click', function() {
    navigator.clipboard.writeText(qrCodeUrl).then(() => {
      const btn = this;
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => {
        btn.textContent = originalText;
      }, 2000);
    });
  });

  // Load QR code on page load
  loadQRCode();

  // Reload QR code on theme change
  const themeObserver = new MutationObserver(() => {
    loadQRCode();
  });
  themeObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme', 'class']
  });
</script>
