.dashboard-app data-dashboard-app="" data-student-dashboard="true" data-i18n-default-class-name=t('student_dashboard.index.default_class_name') data-i18n-cancel-confirmation-message=t('student_dashboard.index.cancel_confirmation_message_with_class') data-i18n-canceling=t('student_dashboard.index.canceling') data-i18n-error-occurred=t('student_dashboard.index.error_occurred') data-i18n-connection-error=t('student_dashboard.index.connection_error') data-i18n-sending=t('student_dashboard.index.sending') data-i18n-sent=t('student_dashboard.index.sent') data-i18n-enrollment-sent=t('student_dashboard.index.enrollment_sent') data-i18n-enrollment-sent-suffix=t('student_dashboard.index.enrollment_sent_suffix') data-i18n-enrollment-error=t('student_dashboard.index.enrollment_error') data-i18n-connection-error-retry=t('student_dashboard.index.connection_error_retry') data-i18n-valid-format=t('student_dashboard.index.valid_format') data-i18n-invalid-format=t('student_dashboard.index.invalid_format')
  = render 'student_dashboard/sidebar'

  main.dashboard-main
    = render 'student_dashboard/top_bar'

    - if @classes.any?
      / Student has approved classes - show learning content
      section.class-results aria-label=t('student_dashboard.index.subjects_section')
        h2 = t('student_dashboard.index.subjects_section')
        .class-results__grid data-subjects-grid=""
          - if @subjects.any?
            - @subjects.each do |subject|
              - stats = @subject_results&.dig(subject.id) || {}
              - best_score = stats[:best_score] || 0
              - is_passed = stats[:passed] || false
              - subject_color_light = subject.color_light.presence || '#6366f1'
              - subject_color_dark = subject.color_dark.presence || '#4f46e5'
              / Card turns grey only if quiz passed (score >= threshold from quiz JSON)
              - card_style = is_passed ? '' : "background: #{subject_color_light};"
              - card_class = is_passed ? 'class-result--completed' : ''
              = link_to student_subject_path(subject), class: "class-result #{card_class}", data: { subject_id: subject.id }, style: card_style
                - if is_passed
                  / Show score only if passed
                  span.class-result__progress.class-result__progress--colored data-subject-progress=subject.id style="background: #{subject_color_light}; border-color: #{subject_color_light};"
                    = "#{best_score}%"
                .class-result__icon aria-hidden="true"
                  - if subject.icon.present? && subject.icon.url.present?
                    img src=subject.icon.url alt=subject.title style="width: 32px; height: 32px; object-fit: contain;"
                  - else
                    / Fallback icon if subject has no icon
                    span style="font-size: 32px;" ðŸ“š
                h3 = subject.title
          - else
            p.class-results__empty = t('student_dashboard.index.no_subjects')

    - elsif @pending_enrollments.any?
      / Student has pending enrollment - waiting for approval
      .dashboard-empty-state
        .dashboard-empty-state__content
          .dashboard-empty-state__icon
            svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
              circle cx="12" cy="12" r="10"
              polyline points="12 6 12 12 16 14"
          h2 = t('student_dashboard.index.waiting_for_approval')
          p
            = t('student_dashboard.index.waiting_message')

          .pending-enrollments-list
            - @pending_enrollments.each do |enrollment|
              .pending-enrollment-card data-enrollment-id=enrollment.id
                .pending-enrollment-info
                  strong = enrollment.school_class.name
                  span.pending-enrollment-school = enrollment.school_class.school.name
                  span.pending-enrollment-date = "#{t('student_dashboard.index.sent_at')} #{enrollment.created_at.strftime('%d.%m.%Y %H:%M')}"
                button.btn.btn-danger.btn-sm.cancel-enrollment-btn type="button" data-enrollment-id=enrollment.id data-class-name=enrollment.school_class.name
                  = t('student_dashboard.index.cancel')

    - else
      / No classes and no pending enrollments - show join form
      .dashboard-empty-state#student-join-state
        .dashboard-empty-state__content
          .dashboard-empty-state__icon
            svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
              path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
              circle cx="9" cy="7" r="4"
              path d="M23 21v-2a4 4 0 0 0-3-3.87"
              path d="M16 3.13a4 4 0 0 1 0 7.75"
          h2 = t('student_dashboard.index.no_classes')
          p
            = t('student_dashboard.index.no_classes_message')
            br
            = t('student_dashboard.index.no_classes_hint_1')
            br
            = t('student_dashboard.index.no_classes_hint_2')

          .join-class-form
            .join-class-input-wrapper
              input#join-token-input.form-control.join-token-input type="text" placeholder=t('student_dashboard.index.join_token_placeholder') autocomplete="off" value="#{@join_token}" data-auto-submit="#{@join_token.present?}"
              .join-token-status
                span#join-status-icon
                span#join-status-text

          #join-error-message.join-error-message style="display: none"
          #join-success-message.join-success-message style="display: none"

    = render 'shared/app_version'

css:
  .join-class-form {
    margin-top: 24px;
    max-width: 500px;
    margin-inline: auto;
  }

  .join-class-input-wrapper {
    position: relative;
  }

  .join-token-input {
    padding: 16px 20px;
    font-size: 16px;
    border-radius: 12px;
    border: 2px solid var(--border-muted);
    background: var(--surface-primary);
    color: var(--content-primary);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .join-token-input:focus {
    border-color: var(--button-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    outline: none;
  }

  .join-token-input.is-valid {
    border-color: var(--state-success);
  }

  .join-token-input.is-invalid {
    border-color: var(--state-error);
  }

  .join-token-input.is-loading {
    border-color: var(--button-primary);
  }

  .join-token-status {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--content-secondary);
  }

  #join-status-icon {
    font-size: 18px;
  }

  .join-error-message {
    margin-top: 12px;
    padding: 12px 16px;
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.3);
    border-radius: 8px;
    color: var(--state-error);
    font-size: 14px;
  }

  .join-success-message {
    margin-top: 12px;
    padding: 12px 16px;
    background: rgba(22, 163, 74, 0.1);
    border: 1px solid rgba(22, 163, 74, 0.3);
    border-radius: 8px;
    color: var(--state-success);
    font-size: 14px;
  }

  .pending-enrollments-list {
    margin-top: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .pending-enrollment-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: var(--surface-primary);
    border: 1px solid var(--border-muted);
    border-radius: 12px;
    gap: 16px;
  }

  .pending-enrollment-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .pending-enrollment-info strong {
    font-size: 16px;
    color: var(--content-primary);
  }

  .pending-enrollment-school {
    font-size: 14px;
    color: var(--content-secondary);
  }

  .pending-enrollment-date {
    font-size: 12px;
    color: var(--content-tertiary);
  }

/ Cancel enrollment modal
.schools-modal#cancel-enrollment-modal aria-hidden="true"
  .schools-modal__overlay
  .schools-modal__dialog role="dialog" aria-modal="true" aria-labelledby="cancel-enrollment-title"
    button.schools-modal__close type="button" aria-label=t('student_dashboard.index.close') data-close-modal="cancel-enrollment-modal" style="position: absolute; top: 16px; right: 16px;"
      svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        line x1="18" y1="6" x2="6" y2="18"
        line x1="6" y1="6" x2="18" y2="18"
    .schools-modal__body
      h3#cancel-enrollment-title style="margin: 0 0 16px; font-size: 24px; font-weight: 500; text-align: center;" = t('student_dashboard.index.cancel_confirmation_title')
      p#cancel-enrollment-message style="text-align: center; color: var(--content-secondary);" = t('student_dashboard.index.cancel_confirmation_message')
      p style="margin-top: 8px; font-size: 14px; text-align: center; color: var(--content-tertiary);" = t('student_dashboard.index.cancel_confirmation_hint')
    .schools-modal__actions
      button.schools-modal__primary.schools-modal__primary--danger#confirm-cancel-btn type="button" = t('student_dashboard.index.confirm_cancel')
      button.schools-modal__secondary type="button" data-close-modal="cancel-enrollment-modal" = t('student_dashboard.index.cancel_action')

javascript:
  (function() {
    // ==========================================
    // i18n translations from data attributes
    // ==========================================
    const dashboardApp = document.querySelector('.dashboard-app');
    const i18n = {
      defaultClassName: dashboardApp?.dataset.i18nDefaultClassName || 'this class',
      cancelConfirmationMessage: dashboardApp?.dataset.i18nCancelConfirmationMessage || 'Are you sure you want to cancel your enrollment request for class',
      canceling: dashboardApp?.dataset.i18nCanceling || 'Canceling...',
      errorOccurred: dashboardApp?.dataset.i18nErrorOccurred || 'An error occurred',
      connectionError: dashboardApp?.dataset.i18nConnectionError || 'Connection error',
      sending: dashboardApp?.dataset.i18nSending || 'Sending...',
      sent: dashboardApp?.dataset.i18nSent || 'Sent!',
      enrollmentSent: dashboardApp?.dataset.i18nEnrollmentSent || 'Enrollment request for class',
      enrollmentSentSuffix: dashboardApp?.dataset.i18nEnrollmentSentSuffix || 'has been sent. Please wait for teacher approval.',
      enrollmentError: dashboardApp?.dataset.i18nEnrollmentError || 'An error occurred while sending the request',
      connectionErrorRetry: dashboardApp?.dataset.i18nConnectionErrorRetry || 'Connection error. Please try again.',
      validFormat: dashboardApp?.dataset.i18nValidFormat || 'Valid format',
      invalidFormat: dashboardApp?.dataset.i18nInvalidFormat || 'Invalid format'
    };

    // ==========================================
    // Modal helpers
    // ==========================================
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('is-open');
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.setAttribute('aria-hidden', 'true');
        modal.classList.remove('is-open');
      }
    }

    // Close modal on overlay click
    document.querySelectorAll('.schools-modal__overlay').forEach(overlay => {
      overlay.addEventListener('click', function() {
        const modal = this.closest('.schools-modal');
        if (modal) {
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Close modal on close button click
    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-close-modal');
        closeModal(modalId);
      });
    });

    // ==========================================
    // Cancel enrollment handlers
    // ==========================================
    let enrollmentToCancel = null;
    const cancelModal = document.getElementById('cancel-enrollment-modal');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    const cancelMessage = document.getElementById('cancel-enrollment-message');

    document.querySelectorAll('.cancel-enrollment-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        enrollmentToCancel = this.dataset.enrollmentId;
        const className = this.dataset.className || i18n.defaultClassName;
        
        if (cancelMessage) {
          cancelMessage.innerHTML = `${i18n.cancelConfirmationMessage} <strong>${className}</strong>?`;
        }
        
        openModal('cancel-enrollment-modal');
      });
    });

    if (confirmCancelBtn) {
      confirmCancelBtn.addEventListener('click', async function() {
        if (!enrollmentToCancel) return;

        const originalText = this.textContent;
        this.disabled = true;
        this.textContent = i18n.canceling;

        try {
          const response = await fetch(`/api/v1/student/enrollments/${enrollmentToCancel}/cancel`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            }
          });

          if (response.ok) {
            closeModal('cancel-enrollment-modal');
            window.location.reload();
          } else {
            const data = await response.json();
            alert(data.error || i18n.errorOccurred);
            this.disabled = false;
            this.textContent = originalText;
          }
        } catch (error) {
          alert(i18n.connectionError);
          this.disabled = false;
          this.textContent = originalText;
        }
      });
    }

    // ==========================================
    // Join class form handlers (only if form exists)
    // ==========================================
    const tokenInput = document.getElementById('join-token-input');
    const statusIcon = document.getElementById('join-status-icon');
    const statusText = document.getElementById('join-status-text');
    const errorMessage = document.getElementById('join-error-message');
    const successMessage = document.getElementById('join-success-message');
    const joinState = document.getElementById('student-join-state');

    if (!tokenInput) return;

    // Token format: xxxxxxxx-xxxx-xxxx (first 3 sections of UUID)
    const TOKEN_REGEX = /^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}$/i;
    const URL_REGEX = /\/join\/class\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4})/i;

    let debounceTimer = null;
    let isSubmitting = false; // Prevent duplicate submissions
    let lastSubmittedToken = null; // Track last submitted token

    function extractToken(input) {
      const trimmed = input.trim();

      // Check if it's a URL
      const urlMatch = trimmed.match(URL_REGEX);
      if (urlMatch) {
        return urlMatch[1].toLowerCase();
      }

      // Check if it's a direct token
      if (TOKEN_REGEX.test(trimmed)) {
        return trimmed.toLowerCase();
      }

      return null;
    }

    function setStatus(type, icon, text) {
      tokenInput.classList.remove('is-valid', 'is-invalid', 'is-loading');
      
      if (type) {
        tokenInput.classList.add(type);
      }
      
      statusIcon.textContent = icon;
      statusText.textContent = text;
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    async function joinClass(token) {
      // Prevent duplicate submissions
      if (isSubmitting || token === lastSubmittedToken) {
        return;
      }
      
      isSubmitting = true;
      lastSubmittedToken = token;
      setStatus('is-loading', 'â³', i18n.sending);
      hideError();

      try {
        const response = await fetch('/api/v1/student/enrollments/join', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ token: token })
        });

        const data = await response.json();

        if (response.ok) {
          setStatus('is-valid', 'âœ…', i18n.sent);
          showSuccess(`${i18n.enrollmentSent} "${data.class_name}" ${i18n.enrollmentSentSuffix}`);
          
          // Reload page after 2 seconds to show pending state
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          setStatus('is-invalid', 'âŒ', 'Error');
          showError(data.error || i18n.enrollmentError);
          isSubmitting = false; // Allow retry on error
        }
      } catch (error) {
        setStatus('is-invalid', 'âŒ', 'Error');
        showError(i18n.connectionErrorRetry);
        isSubmitting = false; // Allow retry on error
      }
    }

    tokenInput.addEventListener('input', function() {
      const value = this.value;
      
      clearTimeout(debounceTimer);
      hideError();

      if (!value.trim()) {
        setStatus(null, '', '');
        return;
      }

      const token = extractToken(value);

      if (token) {
        setStatus('is-valid', 'âœ“', i18n.validFormat);
        
        // Auto-submit after short delay
        debounceTimer = setTimeout(() => {
          joinClass(token);
        }, 500);
      } else {
        // Check if user is still typing
        if (value.length > 5) {
          setStatus('is-invalid', 'âœ—', i18n.invalidFormat);
        } else {
          setStatus(null, '', '');
        }
      }
    });

    // Paste handler - immediate validation
    tokenInput.addEventListener('paste', function(e) {
      setTimeout(() => {
        const token = extractToken(this.value);
        if (token) {
          joinClass(token);
        }
      }, 100);
    });

    // Auto-submit if token is pre-filled from URL
    if (tokenInput.dataset.autoSubmit === 'true' && tokenInput.value) {
      const token = extractToken(tokenInput.value);
      if (token) {
        setTimeout(() => joinClass(token), 500);
      }
    }

  })();

