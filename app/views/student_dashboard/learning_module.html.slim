.dashboard-app data-dashboard-app="" data-student-dashboard="true"
  = render 'student_dashboard/sidebar'

  main.dashboard-main
    header.dashboard-top-bar
      button.dashboard-sidebar-toggle type="button" aria-label="Przełącz nawigację" data-sidebar-toggle=""
        = image_tag 'icons/social/M/burger.svg', width: 24, height: 24, data: { theme_icon: true }
      .dashboard-top-heading
        = link_to public_home_path, class: 'dashboard-back-link', aria: { label: 'Powrót do kursów' }
          = image_tag 'icons/social/M/back.svg', width: 24, height: 24, data: { theme_icon: true }
        .dashboard-top-title-block
          h1 = @subject.title
          - if @subject.description.present?
            p.dashboard-top-description = @subject.description
      .dashboard-top-actions
        - if @certificate
          = link_to download_api_v1_certificate_path(@certificate.id), class: 'certificate-download-btn', target: '_blank', title: 'Pobierz certyfikat'
            i.bi.bi-file-earmark-pdf-fill
            span Certyfikat
        = render 'student_dashboard/top_actions'

    section.module-content-section
      / Progress indicator
      - if @total_steps > 1
        .module-progress
          span.module-progress__text Materiał #{@current_step} z #{@total_steps}
          .module-progress__bar
            .module-progress__fill style="width: #{(@current_step.to_f / @total_steps * 100).round}%"

      - if @content
        - case @content.content_type
        - when 'video'
          .module-content-item.module-content-item--video data-content-id=@content.id
            h2.module-content-title = @content.title
            .video-player-container
              - if @content.youtube_url.present?
                - youtube_id = @content.youtube_url.match(/(?:v=|\/embed\/|youtu\.be\/)([a-zA-Z0-9_-]+)/i)&.[](1)
                - if youtube_id
                  iframe.video-player src="https://www.youtube.com/embed/#{youtube_id}" title=@content.title allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""
              - elsif @content.file&.url.present?
                video.video-player#module-video-player controls="" poster=(@content.poster&.url) data-subtitles-url=(@content.subtitles&.url)
                  source src=@content.file.url type="video/mp4"
                - if @content.subtitles&.url.present?
                  button.video-subtitles-btn#subtitles-toggle type="button" title="Napisy (C)" aria-label="Włącz/wyłącz napisy" data-subtitles-enabled="true"
                    i.bi.bi-badge-cc-fill
              - else
                .video-placeholder
                  = image_tag 'icons/social/L/video.svg', width: 120, height: 120
                  p Wideo niedostępne
            .content-like-bar
              button.content-like-btn.js-content-like type="button" data-content-id=@content.id data-liked="#{@content.liked_by?(current_user)}" data-icon-liked="#{image_path('icons/social/S/like.svg')}" data-icon-unliked="#{image_path('icons/social/S/no-like.svg')}"
                = image_tag @content.liked_by?(current_user) ? 'icons/social/S/like.svg' : 'icons/social/S/no-like.svg', alt: '', class: 'content-like-icon'
                span.content-like-count = @content.likes_count
                span.content-like-text Podoba mi się

        - when 'infographic'
          .module-content-item.module-content-item--infographic data-content-id=@content.id
            h2.module-content-title = @content.title
            .infographic-container
              - if @content.file&.url.present?
                = image_tag @content.file.url, alt: @content.title, class: 'infographic-image'
              - else
                .infographic-placeholder
                  p Infografika niedostępna
            .content-like-bar
              button.content-like-btn.js-content-like type="button" data-content-id=@content.id data-liked="#{@content.liked_by?(current_user)}" data-icon-liked="#{image_path('icons/social/S/like.svg')}" data-icon-unliked="#{image_path('icons/social/S/no-like.svg')}"
                = image_tag @content.liked_by?(current_user) ? 'icons/social/S/like.svg' : 'icons/social/S/no-like.svg', alt: '', class: 'content-like-icon'
                span.content-like-count = @content.likes_count
                span.content-like-text Podoba mi się

      - else
        .module-empty
          p Brak materiałów w tym module

      / Navigation buttons
      .module-actions
        - if @prev_step > 0
          = link_to student_module_path(@learning_module, step: @prev_step), class: 'module-nav-btn module-nav-btn--prev'
            span.module-nav-icon ←
            | Poprzedni

        - if @is_last_content && @has_quiz
          = link_to student_quiz_path(@learning_module), class: 'quiz-start-btn'
            | Rozpocznij Quiz
            span.quiz-start-icon →
        - elsif @is_last_content && !@has_quiz
          = link_to student_subject_path(@subject), class: 'module-nav-btn module-nav-btn--finish'
            | Zakończ moduł
            span.module-nav-icon ✓
        - elsif !@is_last_content
          = link_to student_module_path(@learning_module, step: @next_step), class: 'module-nav-btn module-nav-btn--next'
            | Następny
            span.module-nav-icon →

    = render 'shared/app_version'

css:
  .module-content-section {
    padding: 24px;
    max-width: 900px;
    margin: 0 auto;
  }

  .module-progress {
    margin-bottom: 24px;
    text-align: center;
  }

  .module-progress__text {
    display: block;
    font-size: 14px;
    color: var(--content-secondary);
    margin-bottom: 8px;
  }

  .module-progress__bar {
    height: 4px;
    background: var(--surface-tertiary);
    border-radius: 2px;
    overflow: hidden;
  }

  .module-progress__fill {
    height: 100%;
    background: var(--surface-accent);
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .module-content-item {
    margin-bottom: 24px;
  }

  .module-content-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 16px;
    color: var(--content-primary);
  }

  .video-player-container {
    position: relative;
    aspect-ratio: 16/9;
    background: var(--surface-secondary);
    border-radius: 16px;
    overflow: hidden;
  }

  .video-player {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Subtitles toggle button - top left corner */
  .video-subtitles-btn {
    position: absolute;
    top: 16px;
    left: 16px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.75);
    border: 2px solid transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    z-index: 10;
    color: rgba(255, 255, 255, 0.7);
    font-size: 18px;
  }

  .video-subtitles-btn:hover {
    background: rgba(0, 0, 0, 0.9);
    color: white;
    transform: scale(1.05);
  }

  .video-subtitles-btn[data-subtitles-enabled="true"] {
    color: #ffcc00;
    background: rgba(0, 0, 0, 0.85);
    border-color: rgba(255, 204, 0, 0.5);
  }

  .video-subtitles-btn[data-subtitles-enabled="true"]:hover {
    color: #ffe066;
    border-color: rgba(255, 224, 102, 0.7);
  }

  .video-subtitles-btn[data-subtitles-enabled="false"] {
    color: rgba(255, 255, 255, 0.4);
  }

  /* Custom subtitle styling via ::cue */
  video::cue {
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 18px;
    line-height: 1.4;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .video-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--content-tertiary);
  }

  .video-placeholder img {
    opacity: 0.3;
    margin-bottom: 16px;
  }

  .infographic-container {
    background: var(--surface-secondary);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
  }

  .infographic-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }

  .infographic-placeholder {
    padding: 48px;
    color: var(--content-tertiary);
  }

  .module-empty {
    text-align: center;
    padding: 60px 24px;
    color: var(--content-secondary);
  }

  .module-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 40px;
    flex-wrap: wrap;
  }

  .module-nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 14px 28px;
    background: var(--surface-tertiary);
    color: var(--content-primary);
    font-size: 16px;
    font-weight: 500;
    border-radius: 12px;
    text-decoration: none;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .module-nav-btn:hover {
    background: var(--surface-secondary);
    transform: translateY(-2px);
  }

  .module-nav-btn--next {
    background: var(--surface-accent);
    color: white;
  }

  .module-nav-btn--next:hover {
    opacity: 0.9;
  }

  .module-nav-btn--finish {
    background: var(--state-success, #22c55e);
    color: white;
  }

  .module-nav-btn--finish:hover {
    opacity: 0.9;
  }

  .module-nav-icon {
    font-size: 18px;
  }

  .quiz-start-btn {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    padding: 16px 32px;
    background: var(--button-primary);
    color: white;
    font-size: 16px;
    font-weight: 600;
    border-radius: 12px;
    text-decoration: none;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .quiz-start-btn:hover {
    background: var(--button-primary-hover);
    transform: translateY(-2px);
  }

  .quiz-start-icon {
    font-size: 20px;
  }

  .content-like-bar {
    display: flex;
    justify-content: flex-start;
    margin-top: 12px;
  }

  .content-like-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--surface-tertiary);
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--content-secondary);
    font-size: 14px;
  }

  .content-like-btn:hover {
    background: var(--surface-secondary);
  }

  .content-like-icon {
    width: 18px;
    height: 18px;
  }

  .content-like-count {
    font-weight: 600;
  }

  .content-like-text {
    font-weight: 400;
  }

  .dashboard-top-title-block {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .dashboard-top-title-block h1 {
    margin: 0;
    font-family: var(--font-display);
    font-size: 20px;
    font-weight: 500;
  }

  .dashboard-top-description {
    margin: 0;
    font-size: 14px;
    color: var(--content-secondary);
    font-weight: 400;
    line-height: 1.4;
  }

  .certificate-download-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--state-success);
    color: white;
    font-size: 14px;
    font-weight: 500;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
    margin-right: 12px;
  }

  .certificate-download-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .certificate-download-btn i {
    font-size: 16px;
  }

javascript:
  // Track video viewing and handle likes
  document.addEventListener('DOMContentLoaded', () => {
    const videos = document.querySelectorAll('.video-player');
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

    // ========================================
    // Subtitles handling (SRT to VTT conversion)
    // ========================================
    const subtitlesBtn = document.getElementById('subtitles-toggle');
    const videoPlayer = document.getElementById('module-video-player');
    
    // Expose toggle function for hotkeys
    let toggleSubtitles = null;
    
    if (subtitlesBtn && videoPlayer) {
      const subtitlesUrl = videoPlayer.dataset.subtitlesUrl;
      
      // Initialize: Load preference from localStorage (default: enabled)
      const savedPref = localStorage.getItem('akademy-subtitles-enabled');
      let subtitlesEnabled = savedPref !== 'false'; // default true
      let trackElement = null;
      
      // Convert SRT to WebVTT format
      function srtToVtt(srtContent) {
        // Add WEBVTT header and convert timestamps (comma → dot)
        let vtt = 'WEBVTT\n\n';
        
        // Replace SRT timestamps: 00:00:01,000 → 00:00:01.000
        const converted = srtContent
          .replace(/\r\n/g, '\n')
          .replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
        
        vtt += converted;
        return vtt;
      }
      
      // Load subtitles from URL
      async function loadSubtitles() {
        if (!subtitlesUrl) return;
        
        try {
          const response = await fetch(subtitlesUrl);
          if (!response.ok) throw new Error('Failed to load subtitles');
          
          let content = await response.text();
          
          // Check if it's SRT format (no WEBVTT header)
          if (!content.trim().startsWith('WEBVTT')) {
            content = srtToVtt(content);
          }
          
          // Create blob URL for VTT content
          const blob = new Blob([content], { type: 'text/vtt' });
          const blobUrl = URL.createObjectURL(blob);
          
          // Create and add track element
          trackElement = document.createElement('track');
          trackElement.kind = 'subtitles';
          trackElement.label = 'Polski';
          trackElement.srclang = 'pl';
          trackElement.src = blobUrl;
          trackElement.default = true;
          
          videoPlayer.appendChild(trackElement);
          
          // Wait a bit for track to be ready, then set state
          setTimeout(() => {
            updateSubtitlesState();
          }, 100);
          
        } catch (error) {
          console.error('Error loading subtitles:', error);
          subtitlesBtn.style.display = 'none';
        }
      }
      
      function updateSubtitlesState() {
        if (videoPlayer.textTracks && videoPlayer.textTracks.length > 0) {
          for (let i = 0; i < videoPlayer.textTracks.length; i++) {
            videoPlayer.textTracks[i].mode = subtitlesEnabled ? 'showing' : 'disabled';
          }
        }
        subtitlesBtn.dataset.subtitlesEnabled = subtitlesEnabled;
        subtitlesBtn.title = subtitlesEnabled ? 'Napisy włączone (C)' : 'Napisy wyłączone (C)';
        subtitlesBtn.setAttribute('aria-label', subtitlesEnabled ? 'Wyłącz napisy' : 'Włącz napisy');
      }
      
      toggleSubtitles = function() {
        subtitlesEnabled = !subtitlesEnabled;
        localStorage.setItem('akademy-subtitles-enabled', subtitlesEnabled);
        updateSubtitlesState();
      };
      
      // Load subtitles when video metadata is ready
      videoPlayer.addEventListener('loadedmetadata', loadSubtitles);
      
      // Also try immediately if already loaded
      if (videoPlayer.readyState >= 1) {
        loadSubtitles();
      }
      
      // Button click
      subtitlesBtn.addEventListener('click', toggleSubtitles);
      
    }
    
    // ========================================
    // Video hotkeys (YouTube-style)
    // ========================================
    const videoEl = document.getElementById('module-video-player');
    
    if (videoEl) {
      const container = videoEl.closest('.video-player-container');
      
      
      document.addEventListener('keydown', (e) => {
        // Skip if typing in form fields
        const tag = e.target.tagName.toLowerCase();
        if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
        // Skip if modifier keys (allow normal shortcuts)
        if (e.ctrlKey || e.altKey || e.metaKey) return;
        
        const key = e.key.toLowerCase();
        
        // C - toggle subtitles
        if (key === 'c' && toggleSubtitles) {
          e.preventDefault();
          toggleSubtitles();
          return;
        }
        
        // F - fullscreen
        if (key === 'f') {
          e.preventDefault();
          try {
            if (document.fullscreenElement || document.webkitFullscreenElement) {
              if (document.exitFullscreen) document.exitFullscreen();
              else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            } else {
              const target = container || videoEl;
              if (target.requestFullscreen) target.requestFullscreen();
              else if (target.webkitRequestFullscreen) target.webkitRequestFullscreen();
              else if (videoEl.webkitEnterFullscreen) videoEl.webkitEnterFullscreen();
            }
          } catch (err) { console.log('Fullscreen error:', err); }
          return;
        }
        
        // Space or K - play/pause
        if (key === ' ' || key === 'k') {
          e.preventDefault();
          if (videoEl.paused) videoEl.play().catch(() => {});
          else videoEl.pause();
          return;
        }
        
        // M - mute/unmute
        if (key === 'm') {
          e.preventDefault();
          videoEl.muted = !videoEl.muted;
          return;
        }
        
        // Arrow keys
        if (key === 'arrowleft') {
          e.preventDefault();
          videoEl.currentTime = Math.max(0, videoEl.currentTime - 5);
          return;
        }
        if (key === 'arrowright') {
          e.preventDefault();
          videoEl.currentTime = Math.min(videoEl.duration || 0, videoEl.currentTime + 5);
          return;
        }
        if (key === 'arrowup') {
          e.preventDefault();
          videoEl.volume = Math.min(1, videoEl.volume + 0.1);
          return;
        }
        if (key === 'arrowdown') {
          e.preventDefault();
          videoEl.volume = Math.max(0, videoEl.volume - 0.1);
          return;
        }
        
        // 0 or Home - beginning
        if (key === '0' || key === 'home') {
          e.preventDefault();
          videoEl.currentTime = 0;
          return;
        }
        
        // End - end of video
        if (key === 'end') {
          e.preventDefault();
          if (videoEl.duration) videoEl.currentTime = videoEl.duration;
          return;
        }
      });
    }

    // Video tracking
    videos.forEach(video => {
      const contentId = video.closest('[data-content-id]')?.dataset.contentId;

      video.addEventListener('play', () => {
        if (contentId && csrfToken) {
          fetch('/api/v1/student/events', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
              event_type: 'video_started',
              content_id: contentId,
              learning_module_id: '#{@learning_module.id}'
            })
          });
        }
      });

      video.addEventListener('ended', () => {
        if (contentId && csrfToken) {
          fetch('/api/v1/student/events', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
              event_type: 'video_completed',
              content_id: contentId,
              learning_module_id: '#{@learning_module.id}'
            })
          });
        }
      });
    });

    // Like buttons
    document.querySelectorAll('.js-content-like').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const contentId = btn.dataset.contentId;
        if (!contentId || !csrfToken) return;

        try {
          const response = await fetch(`/home/contents/${contentId}/like`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken
            }
          });

          const data = await response.json();
          if (data.success) {
            // Update button state
            btn.dataset.liked = data.liked;
            
            // Update icon
            const icon = btn.querySelector('.content-like-icon');
            if (icon) {
              icon.src = data.liked ? btn.dataset.iconLiked : btn.dataset.iconUnliked;
            }
            
            // Update count
            const countEl = btn.querySelector('.content-like-count');
            if (countEl) {
              countEl.textContent = data.likes_count;
            }
          }
        } catch (error) {
          console.error('Error toggling like:', error);
        }
      });
    });
  });

