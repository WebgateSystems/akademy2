- content_for :title, 'Settings'

.dashboard-app data-dashboard-app=""
  = render 'sidebar', active: 'account'

  main.dashboard-main
    = render 'top_bar', title: 'Settings', back_path: student_account_path

    section.account-section
      = form_with model: @user, url: student_settings_path, method: :patch, class: 'account-form', id: 'settings-form', local: true do |f|
        - if @user.errors.any?
          .account-form__errors
            - @user.errors.full_messages.each do |msg|
              p.account-form__error = msg

        - # New PIN - 4 separate digit inputs
        .account-form__pin-section
          label.account-form__label
            span New PIN
          .account-form__pin-inputs role="group" aria-label="New PIN code"
            = password_field_tag 'new_pin_1', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "New PIN digit 1" }, data: { pin_group: "new", pin_index: "0" }, autocomplete: "off", pattern: "[0-9]*"
            = password_field_tag 'new_pin_2', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "New PIN digit 2" }, data: { pin_group: "new", pin_index: "1" }, autocomplete: "off", pattern: "[0-9]*"
            = password_field_tag 'new_pin_3', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "New PIN digit 3" }, data: { pin_group: "new", pin_index: "2" }, autocomplete: "off", pattern: "[0-9]*"
            = password_field_tag 'new_pin_4', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "New PIN digit 4" }, data: { pin_group: "new", pin_index: "3" }, autocomplete: "off", pattern: "[0-9]*"
          = hidden_field_tag 'user[new_pin]', '', id: 'new-pin-hidden'

        - # Confirm PIN - 4 separate digit inputs  
        .account-form__pin-section
          label.account-form__label
            span Confirm PIN
          .account-form__pin-inputs role="group" aria-label="Confirm PIN code"
            = password_field_tag 'confirm_pin_1', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "Confirm PIN digit 1" }, data: { pin_group: "confirm", pin_index: "0" }, autocomplete: "off", pattern: "[0-9]*"
            = password_field_tag 'confirm_pin_2', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "Confirm PIN digit 2" }, data: { pin_group: "confirm", pin_index: "1" }, autocomplete: "off", pattern: "[0-9]*"
            = password_field_tag 'confirm_pin_3', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "Confirm PIN digit 3" }, data: { pin_group: "confirm", pin_index: "2" }, autocomplete: "off", pattern: "[0-9]*"
            = password_field_tag 'confirm_pin_4', nil, maxlength: 1, inputmode: "numeric", class: 'account-form__pin-digit', aria: { label: "Confirm PIN digit 4" }, data: { pin_group: "confirm", pin_index: "3" }, autocomplete: "off", pattern: "[0-9]*"
          = hidden_field_tag 'user[pin_confirmation]', '', id: 'confirm-pin-hidden'

        label.account-form__label
          span Theme
          = f.select :theme, [['Light', 'light'], ['Dark', 'dark']], {}, class: 'account-form__input account-form__select', id: 'theme-select'

        label.account-form__label
          span Language
          = f.select :locale, [['English', 'en'], ['Polski', 'pl']], { selected: @user.locale || 'en' }, class: 'account-form__input account-form__select'

        = f.submit 'SAVE CHANGES', class: 'account-form__save', id: 'save-btn', style: 'display: none;'

      button.account-form__delete type="button" id="delete-account-btn"
        | DELETE ACCOUNT

/ Delete account modal - requests deletion approval from school administration
#delete-modal.schools-modal aria-hidden="true"
  .schools-modal__overlay data-modal-overlay="delete"
  .schools-modal__dialog.schools-modal__dialog--small role="dialog" aria-modal="true" aria-labelledby="delete-modal-title"
    .schools-modal__body
      h3#delete-modal-title.schools-modal__title Delete account
      p.schools-modal__text
        | Are you sure you want to request account deletion? 
        br
        | Your request will be sent to the school administration for approval.
    .schools-modal__actions
      button.schools-modal__secondary type="button" id="delete-cancel-btn"
        | CANCEL
      = form_with url: request_student_account_deletion_path, method: :post, local: true, class: 'schools-modal__form-inline' do
        button.schools-modal__primary.schools-modal__primary--danger type="submit"
          | DELETE

javascript:
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('settings-form');
    const saveBtn = document.getElementById('save-btn');
    const newPinHidden = document.getElementById('new-pin-hidden');
    const confirmPinHidden = document.getElementById('confirm-pin-hidden');

    // PIN digit input handling
    const setupPinInputs = (group, hiddenField) => {
      const inputs = document.querySelectorAll(`[data-pin-group="${group}"]`);
      
      inputs.forEach((input, idx) => {
        // Only allow digits
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/[^0-9]/g, '');
          e.target.value = value;
          
          // Update hidden field with combined PIN
          let combinedPin = '';
          inputs.forEach(inp => { combinedPin += inp.value; });
          hiddenField.value = combinedPin;
          
          // Auto-focus next input
          if (value && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          }
          
          checkChanges();
        });

        // Handle backspace
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !input.value && idx > 0) {
            inputs[idx - 1].focus();
          }
        });

        // Handle paste
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 4);
          
          pastedData.split('').forEach((char, i) => {
            if (inputs[i]) {
              inputs[i].value = char;
            }
          });
          
          let combinedPin = '';
          inputs.forEach(inp => { combinedPin += inp.value; });
          hiddenField.value = combinedPin;
          
          // Focus last filled or first empty
          const lastFilled = Math.min(pastedData.length, inputs.length) - 1;
          if (lastFilled >= 0 && lastFilled < inputs.length - 1) {
            inputs[lastFilled + 1].focus();
          } else if (lastFilled >= 0) {
            inputs[lastFilled].focus();
          }
          
          checkChanges();
        });
      });
    };

    setupPinInputs('new', newPinHidden);
    setupPinInputs('confirm', confirmPinHidden);

    // Track changes for save button
    const selects = form.querySelectorAll('select');
    const initialValues = {};

    selects.forEach(select => {
      initialValues[select.name] = select.value;
    });

    const checkChanges = () => {
      let hasChanges = false;
      
      // Check if PIN fields have any values
      const newPin = newPinHidden.value;
      const confirmPin = confirmPinHidden.value;
      
      if (newPin.length > 0 || confirmPin.length > 0) {
        hasChanges = true;
      }
      
      // Check selects
      selects.forEach(select => {
        if (select.value !== initialValues[select.name]) {
          hasChanges = true;
        }
      });
      
      saveBtn.style.display = hasChanges ? 'block' : 'none';
    };

    selects.forEach(select => {
      select.addEventListener('change', checkChanges);
    });

    // Theme switching preview
    const themeSelect = document.getElementById('theme-select');
    const THEME_STORAGE_KEY = 'ust-theme';
    const currentTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
    themeSelect.value = currentTheme;

    themeSelect.addEventListener('change', () => {
      const newTheme = themeSelect.value;
      const isDark = newTheme === 'dark';
      document.documentElement.classList.toggle('theme-dark', isDark);
      localStorage.setItem(THEME_STORAGE_KEY, newTheme);
      checkChanges();
    });

    // Delete account modal
    const deleteModal = document.getElementById('delete-modal');
    const deleteBtn = document.getElementById('delete-account-btn');
    const cancelBtn = document.getElementById('delete-cancel-btn');
    const overlay = deleteModal?.querySelector('[data-modal-overlay]');

    const openModal = () => {
      if (!deleteModal) return;
      deleteModal.classList.add('is-open');
      deleteModal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    };

    const closeModal = () => {
      if (!deleteModal) return;
      deleteModal.classList.remove('is-open');
      deleteModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    };

    deleteBtn?.addEventListener('click', openModal);
    cancelBtn?.addEventListener('click', closeModal);
    overlay?.addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && deleteModal?.classList.contains('is-open')) {
        closeModal();
      }
    });
  });

