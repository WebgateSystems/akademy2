<% content_for :page_title, "Headmasters" %>

<section aria-label="Headmasters list">
  <header class="schools-page__header">
    <label class="schools-search schools-search--half">
      <span class="visually-hidden">Search headmasters</span>
      <input type="search" placeholder="Search headmaster" id="headmasters-search-input">
      <%= image_tag "icons/social/S/search.svg", alt: "", "aria-hidden": "true", "data-theme-icon": true %>
    </label>
    <button class="schools-page__add" type="button" data-open-modal="add-headmaster-modal">Add headmaster</button>
  </header>
  <div class="schools-page__controls"></div>

  <div class="schools-card headmasters-table">
    <table class="schools-page__table">
      <thead>
        <tr>
          <th scope="col" class="left">Name</th>
          <th scope="col" class="left">School</th>
          <th scope="col" class="left">Email</th>
          <th scope="col" class="left">Phone</th>
          <th scope="col" class="left">Joined</th>
          <th scope="col" class="left">Status</th>
          <th scope="col" class="right">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @records.each do |headmaster| %>
          <tr>
            <td><%= [headmaster.first_name, headmaster.last_name].compact.join(' ') || headmaster.email %></td>
            <td><%= headmaster.school&.name || '—' %></td>
            <td><%= headmaster.email %></td>
            <td><%= headmaster.metadata['phone'] || '—' %></td>
            <td><%= headmaster.created_at.strftime('%d.%m.%Y') %></td>
            <td>
              <% if headmaster.locked_at.present? %>
                <span style="color: var(--state-error); font-weight: 500;">Inactive</span>
              <% else %>
                <span style="color: var(--state-success); font-weight: 500;">Active</span>
              <% end %>
            </td>
            <td class="schools-page__actions">
              <div class="headmasters-actions">
                <details class="headmasters-menu">
                  <summary aria-label="Open actions menu">
                    <%= image_tag "icons/social/S/button-3.svg", alt: "", "data-theme-icon": true %>
                  </summary>
                  <ul>
                    <li>
                      <button type="button" data-action="edit-headmaster" 
                              data-headmaster-id="<%= headmaster.id %>" 
                              data-headmaster-first-name="<%= h(headmaster.first_name&.to_s || '') %>" 
                              data-headmaster-last-name="<%= h(headmaster.last_name&.to_s || '') %>" 
                              data-headmaster-school-id="<%= headmaster.school_id %>" 
                              data-headmaster-email="<%= h(headmaster.email&.to_s || '') %>" 
                              data-headmaster-phone="<%= h(headmaster.metadata&.dig('phone')&.to_s || '') %>">Edit</button>
                    </li>
                    <li>
                      <button type="button" data-action="resend-invite" 
                              data-headmaster-id="<%= headmaster.id %>" 
                              data-headmaster-email="<%= h(headmaster.email&.to_s || '') %>">Resend invite</button>
                    </li>
                    <li>
                      <button type="button" data-action="deactivate-headmaster" 
                              data-headmaster-id="<%= headmaster.id %>" 
                              data-headmaster-name="<%= h([headmaster.first_name, headmaster.last_name].compact.join(' ') || headmaster.email) %>"
                              data-headmaster-is-locked="<%= headmaster.locked_at.present? ? 'true' : 'false' %>">
                        <%= headmaster.locked_at.present? ? 'Activate' : 'Deactivate' %>
                      </button>
                    </li>
                  </ul>
                </details>
              </div>
            </td>
          </tr>
        <% end %>
        <% if @records.empty? %>
          <tr>
            <td colspan="7" class="text-center" style="padding: 40px; color: var(--content-secondary);">No headmasters yet</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</section>

<div class="schools-modal" id="add-headmaster-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="add-headmaster-title">
    <header class="schools-modal__header">
      <h3 id="add-headmaster-title">Add headmaster</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="add-headmaster-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <form class="schools-modal__form headmaster-form" id="add-headmaster-form">
      <label>
        <span>School<sup style="color: var(--content-secondary);">*</sup></span>
        <select name="headmaster[school_id]" id="add-headmaster-school" required>
          <option value="">Choose the school</option>
          <% School.all.each do |school| %>
            <option value="<%= school.id %>"><%= school.name %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Headmaster name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="headmaster[first_name]" id="add-headmaster-first-name" placeholder="First name" required>
      </label>
      <label>
        <span>Last name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="headmaster[last_name]" id="add-headmaster-last-name" placeholder="Last name" required>
      </label>
      <label>
        <span>Email<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="email" name="headmaster[email]" id="add-headmaster-email" placeholder="sekretariat@milanowek.pl" required>
      </label>
      <label>
        <span>Phone</span>
        <input type="text" name="headmaster[metadata][phone]" id="add-headmaster-phone" placeholder="+48 XXX XXX XXX">
      </label>
      <div class="schools-modal__actions">
        <button type="submit" class="schools-modal__primary">Add</button>
        <button type="button" class="schools-modal__secondary" data-close-modal="add-headmaster-modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="schools-modal" id="edit-headmaster-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="edit-headmaster-title">
    <header class="schools-modal__header">
      <h3 id="edit-headmaster-title">Edit headmaster</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="edit-headmaster-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <form class="schools-modal__form headmaster-form" id="edit-headmaster-form">
      <input type="hidden" id="edit-headmaster-id" value="">
      <label>
        <span>School<sup style="color: var(--content-secondary);">*</sup></span>
        <select name="headmaster[school_id]" id="edit-headmaster-school" required>
          <option value="">Choose the school</option>
          <% School.all.each do |school| %>
            <option value="<%= school.id %>"><%= school.name %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Headmaster name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="headmaster[first_name]" id="edit-headmaster-first-name" placeholder="First name" required>
      </label>
      <label>
        <span>Last name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="headmaster[last_name]" id="edit-headmaster-last-name" placeholder="Last name" required>
      </label>
      <label>
        <span>Email<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="email" name="headmaster[email]" id="edit-headmaster-email" placeholder="sekretariat@milanowek.pl" required>
      </label>
      <label>
        <span>Phone</span>
        <input type="text" name="headmaster[metadata][phone]" id="edit-headmaster-phone" placeholder="+48 XXX XXX XXX">
      </label>
      <div class="schools-modal__actions">
        <button type="submit" class="schools-modal__primary" id="edit-headmaster-save-btn">Save</button>
        <button type="button" class="schools-modal__secondary" data-close-modal="edit-headmaster-modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="schools-modal" id="deactivate-headmaster-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="deactivate-headmaster-title">
    <header class="schools-modal__header">
      <h3 id="deactivate-headmaster-title">Deactivate headmaster</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="deactivate-headmaster-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <div class="schools-modal__body">
      <p id="deactivate-headmaster-message">Are you sure you want to deactivate <strong data-deactivate-name>this headmaster</strong>? They will lose access immediately.</p>
    </div>
    <div class="schools-modal__actions">
      <button type="button" id="deactivate-headmaster-confirm-btn" class="schools-modal__primary schools-modal__primary--danger">Deactivate</button>
      <button type="button" class="schools-modal__secondary" data-close-modal="deactivate-headmaster-modal">Cancel</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle headmaster menu positioning
    function setupHeadmasterMenus() {
      const menus = document.querySelectorAll('.headmasters-menu');
      const tbody = document.querySelector('.headmasters-table tbody');
      if (!tbody) return;

      menus.forEach((menu) => {
        const summary = menu.querySelector('summary');
        if (!summary) return;

        // Listen for toggle event (fires when details opens/closes)
        menu.addEventListener('toggle', function() {
          if (menu.open) {
            // Close other menus first
            menus.forEach(m => {
              if (m !== menu && m.open) {
                m.open = false;
              }
            });

            // Wait for menu to render, then check position
            requestAnimationFrame(() => {
              const summaryRect = summary.getBoundingClientRect();
              const ul = menu.querySelector('ul');
              if (!ul) return;

              const ulHeight = ul.offsetHeight || 150;
              const spaceBelow = window.innerHeight - summaryRect.bottom;
              const spaceAbove = summaryRect.top;
              const row = menu.closest('tr');
              const rows = Array.from(tbody.querySelectorAll('tr'));
              const rowIndex = rows.indexOf(row);
              const totalRows = rows.length;

              // Position menu using fixed positioning
              // Set very high z-index to ensure popup is always on top
              // Use transform to create new stacking context above table
              ul.style.position = 'fixed';
              ul.style.zIndex = '999999';
              ul.style.isolation = 'isolate';
              ul.style.transform = 'translateZ(0)';
              ul.style.willChange = 'transform';
              
              if (totalRows === 1) {
                // Single row - open downward
                menu.removeAttribute('data-menu-align');
                ul.style.top = (summaryRect.bottom + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.bottom = 'auto';
              } else if (spaceBelow < ulHeight + 20 && spaceAbove > ulHeight + 20 && rowIndex >= totalRows - 2) {
                // Open upward
                menu.setAttribute('data-menu-align', 'top');
                ul.style.bottom = (window.innerHeight - summaryRect.top + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.top = 'auto';
              } else {
                // Open downward
                menu.removeAttribute('data-menu-align');
                ul.style.top = (summaryRect.bottom + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.bottom = 'auto';
              }
            });
          }
        });

        // Prevent clicks inside menu from closing it
        const ul = menu.querySelector('ul');
        if (ul) {
          ul.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      });

      // Close menu when clicking outside (but don't interfere with existing handlers)
      let clickHandler = function(e) {
        if (!e.target.closest('.headmasters-menu')) {
          menus.forEach(m => {
            if (m.open) {
              m.open = false;
            }
          });
        }
      };
      
      // Use capture phase to run before other handlers
      document.addEventListener('click', clickHandler, true);
    }

    setupHeadmasterMenus();

    // Modal handlers
    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-open-modal');
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.setAttribute('aria-hidden', 'false');
          modal.classList.add('is-open');
        }
      });
    });

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-close-modal');
        const modal = document.getElementById(modalId);
        if (modal) {
          // Remove focus from any element inside modal before hiding it
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) {
            focusedElement.blur();
          }
          
          // Reset deactivate modal state when closing
          if (modalId === 'deactivate-headmaster-modal') {
            const confirmBtn = document.getElementById('deactivate-headmaster-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Deactivate'; // Reset to default
            }
            deactivateHeadmasterId = null;
          }
          
          // Set aria-hidden and remove class
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Close on overlay click
    document.querySelectorAll('.schools-modal__overlay').forEach(overlay => {
      overlay.addEventListener('click', function() {
        const modal = this.closest('.schools-modal');
        if (modal) {
          // Remove focus from any element inside modal before hiding it
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) {
            focusedElement.blur();
          }
          
          // Reset deactivate modal state when closing via overlay
          if (modal.id === 'deactivate-headmaster-modal') {
            const confirmBtn = document.getElementById('deactivate-headmaster-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Deactivate'; // Reset to default
            }
            deactivateHeadmasterId = null;
          }
          
          // Set aria-hidden and remove class
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Step 2: Edit headmaster button handler
    document.querySelectorAll('[data-action="edit-headmaster"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modal = document.getElementById('edit-headmaster-modal');
        if (!modal) {
          console.error('Edit headmaster modal not found');
          return;
        }

        // Get headmaster data from data attributes
        const headmasterId = btn.getAttribute('data-headmaster-id');
        const firstName = btn.getAttribute('data-headmaster-first-name') || '';
        const lastName = btn.getAttribute('data-headmaster-last-name') || '';
        const schoolId = btn.getAttribute('data-headmaster-school-id') || '';
        const email = btn.getAttribute('data-headmaster-email') || '';
        const phone = btn.getAttribute('data-headmaster-phone') || '';

        // Set form values
        const idField = document.getElementById('edit-headmaster-id');
        if (idField) idField.value = headmasterId || '';

        const schoolField = document.getElementById('edit-headmaster-school');
        if (schoolField) schoolField.value = schoolId;

        const firstNameField = document.getElementById('edit-headmaster-first-name');
        if (firstNameField) firstNameField.value = firstName;

        const lastNameField = document.getElementById('edit-headmaster-last-name');
        if (lastNameField) lastNameField.value = lastName;

        const emailField = document.getElementById('edit-headmaster-email');
        if (emailField) emailField.value = email;

        const phoneField = document.getElementById('edit-headmaster-phone');
        if (phoneField) phoneField.value = phone;

        // Enable Save button
        const saveBtn = document.getElementById('edit-headmaster-save-btn');
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.removeAttribute('aria-disabled');
          saveBtn.classList.remove('is-disabled');
        }

        // Listen for changes in form fields
        const form = document.getElementById('edit-headmaster-form');
        if (form) {
          const formInputs = form.querySelectorAll('input, select');
          formInputs.forEach(input => {
            input.addEventListener('input', () => {
              if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.removeAttribute('aria-disabled');
                saveBtn.classList.remove('is-disabled');
              }
            });
            input.addEventListener('change', () => {
              if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.removeAttribute('aria-disabled');
                saveBtn.classList.remove('is-disabled');
              }
            });
          });
        }

        // Open modal
        modal.setAttribute('aria-hidden', 'false');
        modal.classList.add('is-open');
      });
    });

    // Step 3: Form submission handlers using API
    if (typeof window.ApiClient === 'undefined') {
      console.error('ApiClient not available. Make sure api_client.js is loaded.');
    } else {
      const api = new window.ApiClient();

      // Add headmaster form submission
      const addForm = document.getElementById('add-headmaster-form');
      if (addForm) {
        addForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = addForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Adding...';

          try {
            const formData = new FormData(addForm);
            const data = {
              headmaster: {
                school_id: formData.get('headmaster[school_id]'),
                first_name: formData.get('headmaster[first_name]'),
                last_name: formData.get('headmaster[last_name]'),
                email: formData.get('headmaster[email]'),
                metadata: {
                  phone: formData.get('headmaster[metadata][phone]') || ''
                }
              }
            };

            const result = await api.post('/headmasters', data);
            
            if (result.success) {
              // Close modal
              const modal = document.getElementById('add-headmaster-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              // Reload page to show new headmaster
              window.location.reload();
            } else {
              console.error('API error:', result.error);
              alert('Error: ' + String(result.error || 'Failed to create headmaster'));
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Edit headmaster form submission
      const editForm = document.getElementById('edit-headmaster-form');
      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = editForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          const headmasterIdField = document.getElementById('edit-headmaster-id');
          
          if (!headmasterIdField || !headmasterIdField.value) {
            alert('Error: Headmaster ID is missing');
            return;
          }
          
          const headmasterId = headmasterIdField.value;
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';

          try {
            const formData = new FormData(editForm);
            const data = {
              headmaster: {
                school_id: formData.get('headmaster[school_id]'),
                first_name: formData.get('headmaster[first_name]'),
                last_name: formData.get('headmaster[last_name]'),
                email: formData.get('headmaster[email]'),
                metadata: {
                  phone: formData.get('headmaster[metadata][phone]') || ''
                }
              }
            };

            const result = await api.patch(`/headmasters/${headmasterId}`, data);
            
            if (result.success) {
              // Close modal
              const modal = document.getElementById('edit-headmaster-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              // Reload page to show updated headmaster
              window.location.reload();
            } else {
              console.error('API error:', result.error);
              alert('Error: ' + String(result.error || 'Failed to update headmaster'));
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Resend invite handler
      document.querySelectorAll('[data-action="resend-invite"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const headmasterId = btn.getAttribute('data-headmaster-id');
          
          if (!headmasterId) {
            console.error('Error: Headmaster ID is missing');
            return;
          }
          
          const originalText = btn.textContent;
          btn.disabled = true;
          btn.textContent = 'Sending...';
          
          try {
            const result = await api.post(`/headmasters/${headmasterId}/resend_invite`, {});
            
            if (result.success) {
              // Show success feedback
              btn.textContent = 'Sent!';
              btn.style.color = 'var(--state-success)';
              
              // Reset after 2 seconds
              setTimeout(() => {
                btn.disabled = false;
                btn.textContent = originalText;
                btn.style.color = '';
              }, 2000);
            } else {
              console.error('Error:', result.error || 'Failed to resend invite');
              btn.disabled = false;
              btn.textContent = originalText;
            }
          } catch (error) {
            console.error('Resend invite error:', error);
            btn.disabled = false;
            btn.textContent = originalText;
          }
        });
      });

      // Deactivate headmaster handler
      let deactivateHeadmasterId = null;
      document.querySelectorAll('[data-action="deactivate-headmaster"]').forEach(btn => {
        btn.addEventListener('click', () => {
          deactivateHeadmasterId = btn.getAttribute('data-headmaster-id');
          const name = btn.getAttribute('data-headmaster-name') || '';
          const isLocked = btn.getAttribute('data-headmaster-is-locked') === 'true';
          
          const deactivateNameEl = document.querySelector('[data-deactivate-name]');
          if (deactivateNameEl) {
            deactivateNameEl.textContent = name;
          }
          
          // Reset and update modal title and message based on status
          const modalTitle = document.getElementById('deactivate-headmaster-title');
          const modalMessage = document.getElementById('deactivate-headmaster-message');
          const confirmBtn = document.getElementById('deactivate-headmaster-confirm-btn');
          
          // Always reset button state first
          if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.removeAttribute('aria-disabled');
          }
          
          if (isLocked) {
            if (modalTitle) modalTitle.textContent = 'Activate headmaster';
            if (modalMessage) modalMessage.textContent = `Are you sure you want to activate ${name}? They will regain access immediately.`;
            if (confirmBtn) {
              confirmBtn.textContent = 'Activate';
              confirmBtn.classList.remove('schools-modal__primary--danger');
            }
          } else {
            if (modalTitle) modalTitle.textContent = 'Deactivate headmaster';
            if (modalMessage) modalMessage.textContent = `Are you sure you want to deactivate ${name}? They will lose access immediately.`;
            if (confirmBtn) {
              confirmBtn.textContent = 'Deactivate';
              confirmBtn.classList.add('schools-modal__primary--danger');
            }
          }
          
          const deactivateModal = document.getElementById('deactivate-headmaster-modal');
          if (deactivateModal) {
            deactivateModal.setAttribute('aria-hidden', 'false');
            deactivateModal.classList.add('is-open');
          }
        });
      });

      // Deactivate headmaster confirm
      const deactivateBtn = document.getElementById('deactivate-headmaster-confirm-btn');
      if (deactivateBtn) {
        deactivateBtn.addEventListener('click', async () => {
          if (!deactivateHeadmasterId) return;
          
          const originalText = deactivateBtn.textContent;
          deactivateBtn.disabled = true;
          deactivateBtn.textContent = 'Processing...';

          try {
            const result = await api.post(`/headmasters/${deactivateHeadmasterId}/lock`, {});
            
            if (result.success) {
              // Find and update the row in DOM
              const rows = document.querySelectorAll('.headmasters-table tbody tr');
              rows.forEach(row => {
                const btn = row.querySelector(`[data-headmaster-id="${deactivateHeadmasterId}"]`);
                if (btn) {
                  const isLocked = btn.getAttribute('data-headmaster-is-locked') === 'true';
                  const newLockedStatus = !isLocked;
                  
                  // Update status cell (6th column)
                  const statusCell = row.querySelector('td:nth-child(6)');
                  if (statusCell) {
                    const statusBadge = statusCell.querySelector('span');
                    if (statusBadge) {
                      if (newLockedStatus) {
                        statusBadge.textContent = 'Inactive';
                        statusBadge.style.color = 'var(--state-error)';
                      } else {
                        statusBadge.textContent = 'Active';
                        statusBadge.style.color = 'var(--state-success)';
                      }
                    }
                  }
                  
                  // Update deactivate button text
                  const deactivateBtnInRow = row.querySelector('[data-action="deactivate-headmaster"]');
                  if (deactivateBtnInRow) {
                    deactivateBtnInRow.textContent = newLockedStatus ? 'Activate' : 'Deactivate';
                    deactivateBtnInRow.setAttribute('data-headmaster-is-locked', newLockedStatus ? 'true' : 'false');
                  }
                }
              });
              
              // Close modal and reset button state
              const modal = document.getElementById('deactivate-headmaster-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              
              // Reset button state
              deactivateBtn.disabled = false;
              deactivateBtn.textContent = 'Deactivate'; // Reset to default
              deactivateHeadmasterId = null;
            } else {
              alert('Error: ' + String(result.error || 'Failed to update headmaster status'));
              deactivateBtn.disabled = false;
              deactivateBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Deactivate error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            deactivateBtn.disabled = false;
            deactivateBtn.textContent = originalText;
          }
        });
      }
    }

    // Step 4: Search/filter functionality
    const searchInput = document.getElementById('headmasters-search-input');
    const headmastersTable = document.querySelector('.headmasters-table tbody');
    
    if (searchInput && headmastersTable) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const rows = headmastersTable.querySelectorAll('tr');
        
        rows.forEach(row => {
          // Skip empty row message
          if (row.querySelector('td[colspan]')) {
            row.style.display = '';
            return;
          }
          
          // Get text content from relevant cells
          const cells = row.querySelectorAll('td');
          if (cells.length < 6) return;
          
          const nameCell = cells[0];
          const schoolCell = cells[1];
          const emailCell = cells[2];
          const phoneCell = cells[3];
          
          // Get text content
          const nameText = nameCell.textContent.toLowerCase();
          const schoolText = schoolCell.textContent.toLowerCase();
          const emailText = emailCell.textContent.toLowerCase();
          const phoneText = phoneCell.textContent.toLowerCase();
          
          // Check if search term matches any of the fields
          const matches = 
            nameText.includes(searchTerm) ||
            schoolText.includes(searchTerm) ||
            emailText.includes(searchTerm) ||
            phoneText.includes(searchTerm);
          
          // Show/hide row based on match
          row.style.display = matches ? '' : 'none';
        });
        
        // Show/hide empty message based on visible rows
        const visibleRows = Array.from(rows).filter(row => {
          return row.style.display !== 'none' && !row.querySelector('td[colspan]');
        });
        
        const emptyRow = headmastersTable.querySelector('tr td[colspan]');
        if (emptyRow) {
          const emptyRowElement = emptyRow.closest('tr');
          if (emptyRowElement) {
            emptyRowElement.style.display = visibleRows.length === 0 ? '' : 'none';
          }
        }
      });
    }
  });
</script>

