<% content_for :page_title, "Contents" %>

<section aria-label="New content">
  <header class="schools-page__header">
    <h2 style="margin: 0; font-size: 24px; font-weight: 600;">
      New Content
    </h2>
    <div style="display: flex; gap: 12px;">
      <%= link_to admin_resource_collection_path(resource: 'contents'), class: "schools-page__add", style: "text-decoration: none; background: var(--surface-secondary); color: var(--content-primary);" do %>
        Cancel
      <% end %>
    </div>
  </header>

  <div class="schools-card" style="margin-top: 24px;">
    <%= form_with model: @record, url: admin_create_resource_path(resource: 'contents'), method: :post, local: true, multipart: true, id: 'content-form' do |f| %>
      <% if @record.errors.any? %>
        <div style="padding: 16px; margin: 24px; background: var(--surface-error); border-radius: 8px; color: var(--content-error);">
          <strong>Errors:</strong>
          <ul style="margin: 8px 0 0 0; padding-left: 20px;">
            <% @record.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <table class="schools-page__table">
        <tbody>
          <tr>
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Content Type:
            </td>
            <td class="left">
              <%= f.select :content_type, options_for_select([
                ['Video', 'video'],
                ['Infographic', 'infographic'],
                ['Quiz', 'quiz'],
                ['PDF', 'pdf'],
                ['Webinar', 'webinar'],
                ['Asset', 'asset']
              ]), {}, { required: true, id: 'content-type-select', style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" } %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Select content type first - form fields will change based on selection</small>
            </td>
          </tr>

          <tr>
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Title:
            </td>
            <td class="left">
              <%= f.text_field :title, required: true, style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
            </td>
          </tr>

          <tr>
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Learning Module:
            </td>
            <td class="left">
              <%= f.collection_select :learning_module_id, LearningModule.includes(unit: :subject).order('subjects.order_index ASC, units.order_index ASC, learning_modules.order_index ASC'), :id, :title_with_unit_and_subject, { prompt: 'Select learning module', required: true }, { style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" } %>
            </td>
          </tr>

          <!-- Video-specific fields -->
          <tr class="content-type-fields" data-content-type="video">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              YouTube URL:
            </td>
            <td class="left">
              <%= f.text_field :youtube_url, placeholder: "https://youtube.com/watch?v=...", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
            </td>
          </tr>

          <tr class="content-type-fields" data-content-type="video">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Duration (seconds):
            </td>
            <td class="left">
              <%= f.number_field :duration_sec, min: 0, style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
            </td>
          </tr>

          <tr class="content-type-fields" data-content-type="video">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Video File:
            </td>
            <td class="left">
              <%= f.file_field :file, accept: "video/*", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Upload video file (alternative to YouTube URL)</small>
            </td>
          </tr>

          <tr class="content-type-fields" data-content-type="video">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Poster:
            </td>
            <td class="left">
              <%= f.file_field :poster, accept: "image/*", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Upload poster image</small>
            </td>
          </tr>

          <tr class="content-type-fields" data-content-type="video">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Subtitles:
            </td>
            <td class="left">
              <%= f.file_field :subtitles, accept: ".srt,.vtt", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Upload subtitles file (.srt or .vtt)</small>
            </td>
          </tr>

          <tr class="content-type-fields" data-content-type="video">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Subtitles Language:
            </td>
            <td class="left">
              <%= f.text_field :payload_subtitles_lang, value: @record.payload&.dig('subtitles_lang') || 'pl', placeholder: "pl", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Language code (e.g., 'pl', 'en')</small>
            </td>
          </tr>

          <!-- Infographic-specific fields -->
          <tr class="content-type-fields" data-content-type="infographic">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Infographic File:
            </td>
            <td class="left">
              <%= f.file_field :file, accept: "image/*,.svg,.pdf", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Upload infographic (SVG, PNG, PDF)</small>
            </td>
          </tr>

          <!-- Quiz-specific fields -->
          <tr class="content-type-fields" data-content-type="quiz">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Quiz Payload (JSON):
            </td>
            <td class="left">
              <%= f.text_area :payload_json, value: '', rows: 15, placeholder: '{\n  "questions": [\n    {\n      "id": "q1",\n      "type": "single",\n      "text": "Question text?",\n      "options": [\n        { "id": "a", "text": "Option A" },\n        { "id": "b", "text": "Option B" }\n      ],\n      "correct": ["a"],\n      "points": 1\n    }\n  ],\n  "pass_threshold": 80\n}', style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 13px; width: 100%; max-width: 800px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace; line-height: 1.5; white-space: pre; overflow-wrap: normal; overflow-x: auto;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">
                JSON structure: <code style="font-size: 11px;">{"questions": [{"id": "q1", "type": "single", "text": "...", "options": [...], "correct": [...], "points": 1}], "pass_threshold": 80}</code>
              </small>
            </td>
          </tr>

          <!-- PDF-specific fields -->
          <tr class="content-type-fields" data-content-type="pdf">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              PDF File:
            </td>
            <td class="left">
              <%= f.file_field :file, accept: ".pdf", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Upload PDF file</small>
            </td>
          </tr>

          <!-- Webinar-specific fields (similar to video) -->
          <tr class="content-type-fields" data-content-type="webinar">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Webinar URL:
            </td>
            <td class="left">
              <%= f.text_field :youtube_url, placeholder: "https://...", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
            </td>
          </tr>

          <tr class="content-type-fields" data-content-type="webinar">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Duration (seconds):
            </td>
            <td class="left">
              <%= f.number_field :duration_sec, min: 0, style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
            </td>
          </tr>

          <!-- Asset-specific fields -->
          <tr class="content-type-fields" data-content-type="asset">
            <td class="left" style="font-weight: 500; color: var(--content-secondary);">
              Asset File:
            </td>
            <td class="left">
              <%= f.file_field :file, accept: "*/*", style: "padding: 8px 12px; background: var(--surface-primary); border: 1px solid var(--border-primary); border-radius: 4px; color: var(--content-primary); font-size: 14px; width: 100%; max-width: 300px;" %>
              <small style="color: var(--content-secondary); font-size: 12px; display: block; margin-top: 4px;">Upload any file type</small>
            </td>
          </tr>
        </tbody>
      </table>

      <div style="padding: 24px; display: flex; gap: 12px; border-top: 1px solid var(--border-primary);">
        <%= f.submit "Create", class: "schools-page__add", style: "cursor: pointer; border: none;" %>
        <%= link_to "Cancel", admin_resource_collection_path(resource: 'contents'), class: "schools-page__add", style: "text-decoration: none; background: var(--surface-secondary); color: var(--content-primary); text-align: center;" %>
      </div>
    <% end %>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const contentTypeSelect = document.getElementById('content-type-select');
    const contentForm = document.getElementById('content-form');
    const contentTypeFields = document.querySelectorAll('.content-type-fields');

    function toggleFieldsForContentType(contentType) {
      contentTypeFields.forEach(row => {
        const rowContentType = row.getAttribute('data-content-type');
        if (rowContentType === contentType) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
          // Clear values when hiding fields
          const inputs = row.querySelectorAll('input, textarea, select');
          inputs.forEach(input => {
            if (input.type !== 'file') {
              input.value = '';
            } else {
              input.value = '';
            }
          });
        }
      });
    }

    // Initial state - hide all type-specific fields
    toggleFieldsForContentType('');

    // Listen for content type changes
    if (contentTypeSelect) {
      contentTypeSelect.addEventListener('change', function() {
        toggleFieldsForContentType(this.value);
      });
    }

    // Auto-format JSON on blur for quiz payload (when field becomes visible)
    function setupJsonFormatting() {
      const payloadJsonField = document.querySelector('textarea[name="content[payload_json]"]');
      if (payloadJsonField && !payloadJsonField.dataset.formatterAttached) {
        payloadJsonField.dataset.formatterAttached = 'true';
        payloadJsonField.addEventListener('blur', function() {
          const value = this.value.trim();
          if (value) {
            try {
              const parsed = JSON.parse(value);
              // Format JSON with pretty printing
              this.value = JSON.stringify(parsed, null, 2);
            } catch (e) {
              // Invalid JSON - don't format, let validation catch it
            }
          }
        });
      }
    }

    // Setup formatting when quiz type is selected
    if (contentTypeSelect) {
      contentTypeSelect.addEventListener('change', function() {
        setTimeout(setupJsonFormatting, 100); // Small delay to ensure field is visible
      });
    }
    setupJsonFormatting(); // Also setup for initial state

    // Function to show error messages
    function showErrorMessage(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger';
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '80px';
      alertDiv.style.right = '20px';
      alertDiv.style.zIndex = '10000';
      alertDiv.style.padding = '16px 24px';
      alertDiv.style.borderRadius = '8px';
      alertDiv.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
      alertDiv.style.maxWidth = '500px';
      alertDiv.style.wordWrap = 'break-word';
      alertDiv.style.backgroundColor = 'var(--surface-error, #f8d7da)';
      alertDiv.style.color = 'var(--content-error, #721c24)';
      alertDiv.style.border = '1px solid var(--border-error, #f5c6cb)';
      alertDiv.innerHTML = '<strong style="display: block; margin-bottom: 8px;">Błąd walidacji JSON:</strong>' + message;
      
      document.body.appendChild(alertDiv);
      
      // Focus on the JSON field
      const payloadJsonField = document.querySelector('textarea[name="content[payload_json]"]');
      if (payloadJsonField) {
        payloadJsonField.focus();
        payloadJsonField.style.borderColor = 'var(--content-error, #dc3545)';
        payloadJsonField.style.borderWidth = '2px';
        
        // Reset border after user starts typing
        payloadJsonField.addEventListener('input', function() {
          this.style.borderColor = '';
          this.style.borderWidth = '';
        }, { once: true });
      }
      
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
          alertDiv.remove();
        }, 300);
      }, 8000); // Show for 8 seconds (longer for JSON errors)
    }

    // Handle form submission - convert payload_json to payload
    if (contentForm) {
      contentForm.addEventListener('submit', function(e) {
        const contentType = contentTypeSelect?.value;
        const payloadJsonField = document.querySelector('textarea[name="content[payload_json]"]');
        
        if (contentType === 'quiz' && payloadJsonField) {
          try {
            const jsonValue = payloadJsonField.value.trim();
            if (jsonValue) {
              const parsed = JSON.parse(jsonValue);
              // Create hidden input for payload
              let payloadInput = document.querySelector('input[name="content[payload]"]');
              if (!payloadInput) {
                payloadInput = document.createElement('input');
                payloadInput.type = 'hidden';
                payloadInput.name = 'content[payload]';
                contentForm.appendChild(payloadInput);
              }
              payloadInput.value = JSON.stringify(parsed);
            }
          } catch (error) {
            e.preventDefault();
            // Extract a more user-friendly error message
            let errorMessage = error.message;
            if (errorMessage.includes('position')) {
              // Parse position info for better UX
              const positionMatch = errorMessage.match(/position (\d+)/);
              if (positionMatch) {
                const position = parseInt(positionMatch[1]);
                const lines = payloadJsonField.value.split('\n');
                let currentPos = 0;
                let lineNum = 1;
                for (let i = 0; i < lines.length; i++) {
                  if (currentPos + lines[i].length >= position) {
                    lineNum = i + 1;
                    break;
                  }
                  currentPos += lines[i].length + 1; // +1 for newline
                }
                errorMessage = `Błąd w linii ${lineNum}: ${errorMessage.replace(/Expected.*?in JSON at position \d+.*?/, '').trim() || 'Nieprawidłowa składnia JSON'}`;
              }
            }
            showErrorMessage(errorMessage);
            return false;
          }
        } else if (contentType === 'video') {
          // Handle video payload (subtitles_lang)
          const subtitlesLangField = document.querySelector('input[name="content[payload_subtitles_lang]"]');
          if (subtitlesLangField && subtitlesLangField.value) {
            let payloadInput = document.querySelector('input[name="content[payload]"]');
            if (!payloadInput) {
              payloadInput = document.createElement('input');
              payloadInput.type = 'hidden';
              payloadInput.name = 'content[payload]';
              contentForm.appendChild(payloadInput);
            }
            payloadInput.value = JSON.stringify({ subtitles_lang: subtitlesLangField.value });
          }
        }
      });
    }
  });
</script>
