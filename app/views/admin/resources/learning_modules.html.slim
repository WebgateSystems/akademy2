- content_for :page_title, t('admin.resources.learning_modules.list')

section aria-label=(t('admin.resources.learning_modules.list'))
  header.schools-page__header
    label.schools-search.schools-search--half
      span.visually-hidden = t('common.search')
      input type="search" placeholder="#{t('common.search')}..." id="learning-modules-search-input"
      = image_tag "icons/social/S/search.svg", alt: "", "aria-hidden": "true"
    = link_to admin_new_resource_path(resource: 'learning_modules'), class: "schools-page__add", style: "text-decoration: none;" do
      = t('admin.resources.learning_modules.add')
  .schools-page__controls
  .schools-card
    table.schools-page__table
      thead
        tr
          th.left scope="col" Lp.
          th.left scope="col" = t('admin.resources.learning_modules.form.title')
          th.left scope="col" = t('admin.resources.learning_modules.form.unit')
          th.left scope="col" = t('admin.resources.subjects.form.title')
          th.left scope="col" = t('admin.resources.learning_modules.form.published')
          th.left scope="col" = t('admin.resources.learning_modules.form.single_flow')
          th.right scope="col" = t('common.actions')
      tbody#learning-modules-tbody
        - @records.each do |module_record|
          tr.sortable-row data-learning-module-id=module_record.id draggable="true"
            td.sortable-handle style="cursor: move; user-select: none;"
              span.order-index = module_record.order_index
            td
              strong = module_record.title
            td = module_record.unit&.title || '—'
            td = module_record.unit&.subject&.title || '—'
            td
              - if module_record.published?
                span style="color: var(--content-success);" = "✓ #{t('admin.resources.learning_modules.form.published')}"
              - else
                span style="color: var(--content-secondary);" —
            td
              - if module_record.single_flow?
                span style="color: var(--content-primary);" ✓
              - else
                span style="color: var(--content-secondary);" —
            td.schools-page__actions
              = link_to admin_resource_path(resource: 'learning_modules', id: module_record.id), "aria-label": t('common.view'), class: 'learning_module-action--show' do
                = image_tag "icons/social/S/search.svg", alt: ""
              = link_to admin_edit_resource_path(resource: 'learning_modules', id: module_record.id), "aria-label": t('common.edit'), class: 'learning_module-action--edit' do
                = image_tag "icons/social/S/edit.svg", alt: ""
              button.learning_module-action--delete type="button" aria-label=(t('common.delete')) data-action="delete-learning-module" data-learning-module-id=module_record.id data-learning-module-title=h(module_record.title&.to_s || '')
                = image_tag "icons/social/S/delete.svg", alt: ""
        - if @records.empty?
          tr
            td.text-center colspan="7" style="padding: 40px; color: var(--content-secondary);" Brak modułów

.schools-modal#delete-learning-module-modal aria-hidden="true"
  .schools-modal__overlay
  .schools-modal__dialog role="dialog" aria-modal="true" aria-labelledby="delete-learning-module-modal-title"
    header.schools-modal__header
      h3#delete-learning-module-modal-title = t('admin.resources.learning_modules.delete')
      button.schools-modal__close type="button" aria-label=(t('common.close')) data-close-modal="delete-learning-module-modal"
        = image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true
    .schools-modal__body
      p
        = t('admin.resources.learning_modules.delete_confirm')
        |  
        strong data-learning-module-delete-title
        | ?
        |  
        = t('admin.resources.learning_modules.delete_warning')
    .schools-modal__actions
      button#delete-learning-module-confirm-btn.schools-modal__primary.schools-modal__primary--danger type="button" = t('common.delete')
      button.schools-modal__secondary type="button" data-close-modal="delete-learning-module-modal" = t('common.cancel')

javascript:
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('learning-modules-search-input');
    const tbody = document.getElementById('learning-modules-tbody');
    const MSG_DELETING = '#{j t('admin.resources.learning_modules.js.deleting')}';
    const MSG_DELETE_ERROR = '#{j t('admin.resources.learning_modules.js.error_delete')}';

    if (searchInput && tbody) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          if (row.querySelector('td[colspan]')) { row.style.display = ''; return; }
          const cells = row.querySelectorAll('td');
          if (cells.length < 7) return;
          const titleText = cells[1].textContent.toLowerCase();
          const unitText = cells[2].textContent.toLowerCase();
          const subjectText = cells[3].textContent.toLowerCase();
          row.style.display = (titleText.includes(searchTerm) || unitText.includes(searchTerm) || subjectText.includes(searchTerm)) ? '' : 'none';
        });
      });
    }

    let deleteModuleId = null;
    document.querySelectorAll('[data-action="delete-learning-module"]').forEach(btn => {
      btn.addEventListener('click', () => {
        deleteModuleId = btn.getAttribute('data-learning-module-id');
        const title = btn.getAttribute('data-learning-module-title') || '';
        const deleteTitleEl = document.querySelector('[data-learning-module-delete-title]');
        if (deleteTitleEl) deleteTitleEl.textContent = title;
        const modal = document.getElementById('delete-learning-module-modal');
        if (modal) { modal.setAttribute('aria-hidden', 'false'); modal.classList.add('is-open'); }
      });
    });

    document.querySelectorAll('[data-close-modal="delete-learning-module-modal"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modal = document.getElementById('delete-learning-module-modal');
        if (modal) { modal.setAttribute('aria-hidden', 'true'); modal.classList.remove('is-open'); }
      });
    });

    const overlay = document.querySelector('#delete-learning-module-modal .schools-modal__overlay');
    if (overlay) {
      overlay.addEventListener('click', function() {
        const modal = document.getElementById('delete-learning-module-modal');
        if (modal) { modal.setAttribute('aria-hidden', 'true'); modal.classList.remove('is-open'); }
      });
    }

    const deleteBtn = document.getElementById('delete-learning-module-confirm-btn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', async () => {
        if (!deleteModuleId) return;
        const originalText = deleteBtn.textContent;
        deleteBtn.disabled = true;
        deleteBtn.textContent = MSG_DELETING;
        try {
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
          const formData = new URLSearchParams();
          formData.append('_method', 'delete');
          formData.append('authenticity_token', csrfToken);
          const response = await fetch(`/admin/learning_modules/${deleteModuleId}`, {
            method: 'POST', headers: { 'X-CSRF-Token': csrfToken, 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString(), credentials: 'same-origin'
          });
          const modal = document.getElementById('delete-learning-module-modal');
          if (modal) { modal.setAttribute('aria-hidden', 'true'); modal.classList.remove('is-open'); }
          if (response.status === 303 || response.status === 302 || response.ok) { window.location.reload(); }
          else { alert(MSG_DELETE_ERROR); deleteBtn.disabled = false; deleteBtn.textContent = originalText; }
        } catch (error) {
          alert(MSG_DELETE_ERROR + ': ' + error.message);
          deleteBtn.disabled = false;
          deleteBtn.textContent = originalText;
        }
      });
    }
  });

