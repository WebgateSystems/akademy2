<% content_for :page_title, "Activity log" %>

<section class="activity-log" aria-label="Activity log">
  <div class="activity-log__filters">
    <div class="activity-filter activity-filter--date">
      <label class="activity-filter__label" for="activity-date-from">From</label>
      <div class="activity-date-picker" data-date-role="from">
        <input id="activity-date-from" class="activity-date-picker__display" type="text" aria-label="From date" placeholder="DD.MM.YYYY HH:MM">
        <input class="activity-date-picker__native" type="datetime-local" aria-hidden="true" tabindex="-1">
        <button class="activity-date-picker__clear" type="button" aria-label="Clear from date">
          <%= image_tag "icons/social/XS/Close.svg", alt: "" %>
        </button>
        <button class="activity-date-picker__calendar" type="button" aria-label="Select from date">
          <%= image_tag "icons/social/M/calendar.svg", alt: "", "data-theme-icon": true %>
        </button>
      </div>
    </div>
    <div class="activity-filter activity-filter--date">
      <label class="activity-filter__label" for="activity-date-to">To</label>
      <div class="activity-date-picker" data-date-role="to">
        <input id="activity-date-to" class="activity-date-picker__display" type="text" aria-label="To date" placeholder="DD.MM.YYYY HH:MM">
        <input class="activity-date-picker__native" type="datetime-local" aria-hidden="true" tabindex="-1">
        <button class="activity-date-picker__clear" type="button" aria-label="Clear to date">
          <%= image_tag "icons/social/XS/Close.svg", alt: "" %>
        </button>
        <button class="activity-date-picker__calendar" type="button" aria-label="Select to date">
          <%= image_tag "icons/social/M/calendar.svg", alt: "", "data-theme-icon": true %>
        </button>
      </div>
    </div>
  </div>

  <div class="activity-log__table">
    <div class="activity-log__head">
      <span>Date</span>
      <span>Source</span>
      <span>Action</span>
      <span>Subject</span>
      <span>Subject ID</span>
    </div>
    <div class="activity-log__body" id="activity-log-body">
      <!-- Events will be loaded via API -->
    </div>
    <div id="activity-loading-indicator" class="activity-loading" style="display: none; padding: 20px; text-align: center;">
      <div class="spinner" style="display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--content-primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
      <span style="margin-left: 12px; color: var(--content-secondary);">Loading events...</span>
    </div>
    <div id="activity-empty-message" class="activity-log__empty" style="display: none;">
      <p>No activity logged yet</p>
    </div>
    <div id="activity-error-message" class="activity-log__empty" style="display: none; color: var(--state-error);">
      <p id="activity-error-text">Error loading events</p>
    </div>
  </div>
</section>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Infinite scroll implementation
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let allEvents = [];
    const perPage = 20;
    const body = document.getElementById('activity-log-body');
    const loadingIndicator = document.getElementById('activity-loading-indicator');
    const emptyMessage = document.getElementById('activity-empty-message');
    const errorMessage = document.getElementById('activity-error-message');
    const errorText = document.getElementById('activity-error-text');
    const dateFromInput = document.getElementById('activity-date-from');
    const dateToInput = document.getElementById('activity-date-to');

    if (typeof window.ApiClient === 'undefined') {
      console.error('ApiClient not available. Make sure api_client.js is loaded.');
      return;
    }

    const api = new window.ApiClient();

    // Function to format date for display
    function formatDate(dateString) {
      if (!dateString) return '—';
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return {
        date: `${day}.${month}.${year}`,
        time: `${hours}:${minutes}:${seconds}`
      };
    }

    // Function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Function to render an event entry
    function renderEventEntry(event) {
      const attrs = event.attributes || event;
      const occurredAt = attrs.occurred_at || attrs.created_at;
      const dateFormatted = formatDate(occurredAt);
      const userName = attrs.user_name || '—';
      const eventType = attrs.event_type || '—';
      const subjectType = attrs.subject_type || '—';
      const subjectId = attrs.subject_id || attrs.id || '—';
      const subjectOwnerId = attrs.subject_owner_id;
      const eventData = attrs.data || {};
      const eventId = event.id || attrs.id;

      const details = document.createElement('details');
      details.className = 'activity-entry';

      const summary = document.createElement('summary');
      
      // Date cell
      const dateCell = document.createElement('span');
      dateCell.className = 'activity-cell activity-cell--date';
      const chevron = document.createElement('img');
      chevron.src = '<%= asset_path("icons/social/XS/dropdown.svg") %>';
      chevron.className = 'activity-entry__chevron';
      chevron.alt = '';
      chevron.width = '8';
      chevron.height = '8';
      chevron.setAttribute('aria-hidden', 'true');
      
      const datetimeSpan = document.createElement('span');
      datetimeSpan.className = 'activity-entry__datetime';
      const dateSpan = document.createElement('span');
      dateSpan.textContent = dateFormatted.date;
      const timeSpan = document.createElement('span');
      timeSpan.textContent = dateFormatted.time;
      datetimeSpan.appendChild(dateSpan);
      datetimeSpan.appendChild(timeSpan);
      
      dateCell.appendChild(chevron);
      dateCell.appendChild(datetimeSpan);
      
      // Other cells
      const userCell = document.createElement('span');
      userCell.className = 'activity-cell';
      userCell.textContent = userName;
      
      const actionCell = document.createElement('span');
      actionCell.className = 'activity-cell';
      actionCell.textContent = eventType;
      
      const subjectCell = document.createElement('span');
      subjectCell.className = 'activity-cell';
      subjectCell.textContent = subjectType;
      
      const subjectIdCell = document.createElement('span');
      subjectIdCell.className = 'activity-cell';
      subjectIdCell.textContent = subjectId;
      
      summary.appendChild(dateCell);
      summary.appendChild(userCell);
      summary.appendChild(actionCell);
      summary.appendChild(subjectCell);
      summary.appendChild(subjectIdCell);
      
      // Details section
      const detailsDiv = document.createElement('div');
      detailsDiv.className = 'activity-entry__details';
      
      const dl = document.createElement('dl');
      
      // Date
      const dateDiv = document.createElement('div');
      const dateDt = document.createElement('dt');
      dateDt.textContent = 'Date:';
      const dateDd = document.createElement('dd');
      dateDd.innerHTML = `${dateFormatted.date} &nbsp; ${dateFormatted.time}`;
      dateDiv.appendChild(dateDt);
      dateDiv.appendChild(dateDd);
      
      // Source
      const sourceDiv = document.createElement('div');
      const sourceDt = document.createElement('dt');
      sourceDt.textContent = 'Source:';
      const sourceDd = document.createElement('dd');
      sourceDd.textContent = userName;
      sourceDiv.appendChild(sourceDt);
      sourceDiv.appendChild(sourceDd);
      
      // Action
      const actionDiv = document.createElement('div');
      const actionDt = document.createElement('dt');
      actionDt.textContent = 'Action:';
      const actionDd = document.createElement('dd');
      actionDd.textContent = eventType;
      actionDiv.appendChild(actionDt);
      actionDiv.appendChild(actionDd);
      
      // Subject
      const subjectDiv = document.createElement('div');
      const subjectDt = document.createElement('dt');
      subjectDt.textContent = 'Subject:';
      const subjectDd = document.createElement('dd');
      subjectDd.textContent = subjectType;
      subjectDiv.appendChild(subjectDt);
      subjectDiv.appendChild(subjectDd);
      
      // Subject ID
      const subjectIdDiv = document.createElement('div');
      const subjectIdDt = document.createElement('dt');
      subjectIdDt.textContent = 'Subject ID:';
      const subjectIdDd = document.createElement('dd');
      const subjectIdValue = document.createElement('span');
      subjectIdValue.className = 'activity-entry__value';
      subjectIdValue.textContent = subjectId;
      subjectIdDd.appendChild(subjectIdValue);
      
      if (subjectId && subjectId !== '—') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'activity-copy-btn';
        copyBtn.type = 'button';
        copyBtn.setAttribute('aria-label', 'Copy Subject ID');
        copyBtn.setAttribute('data-copy-value', subjectId);
        
        const copyIcon = document.createElement('img');
        copyIcon.src = '<%= asset_path("icons/social/XS/copy.svg") %>';
        copyIcon.className = 'activity-copy-btn__icon activity-copy-btn__icon--copy';
        copyIcon.alt = '';
        
        const successIcon = document.createElement('svg');
        successIcon.className = 'activity-copy-btn__icon activity-copy-btn__icon--success';
        successIcon.setAttribute('viewBox', '0 0 16 16');
        successIcon.setAttribute('aria-hidden', 'true');
        successIcon.setAttribute('focusable', 'false');
        const path = document.createElement('path');
        path.setAttribute('d', 'M3 8.5l3 3L13 5');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'currentColor');
        path.setAttribute('stroke-width', '1.6');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        successIcon.appendChild(path);
        
        copyBtn.appendChild(copyIcon);
        copyBtn.appendChild(successIcon);
        subjectIdDd.appendChild(copyBtn);
      }
      
      subjectIdDiv.appendChild(subjectIdDt);
      subjectIdDiv.appendChild(subjectIdDd);
      
      dl.appendChild(dateDiv);
      dl.appendChild(sourceDiv);
      dl.appendChild(actionDiv);
      dl.appendChild(subjectDiv);
      dl.appendChild(subjectIdDiv);
      
      // Subject owner ID
      if (subjectOwnerId) {
        const ownerIdDiv = document.createElement('div');
        const ownerIdDt = document.createElement('dt');
        ownerIdDt.textContent = 'Subject owner ID:';
        const ownerIdDd = document.createElement('dd');
        const ownerIdValue = document.createElement('span');
        ownerIdValue.className = 'activity-entry__value';
        ownerIdValue.textContent = subjectOwnerId;
        ownerIdDd.appendChild(ownerIdValue);
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'activity-copy-btn';
        copyBtn.type = 'button';
        copyBtn.setAttribute('aria-label', 'Copy Subject owner ID');
        copyBtn.setAttribute('data-copy-value', subjectOwnerId);
        
        const copyIcon = document.createElement('img');
        copyIcon.src = '<%= asset_path("icons/social/XS/copy.svg") %>';
        copyIcon.className = 'activity-copy-btn__icon activity-copy-btn__icon--copy';
        copyIcon.alt = '';
        
        const successIcon = document.createElement('svg');
        successIcon.className = 'activity-copy-btn__icon activity-copy-btn__icon--success';
        successIcon.setAttribute('viewBox', '0 0 16 16');
        successIcon.setAttribute('aria-hidden', 'true');
        successIcon.setAttribute('focusable', 'false');
        const path = document.createElement('path');
        path.setAttribute('d', 'M3 8.5l3 3L13 5');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'currentColor');
        path.setAttribute('stroke-width', '1.6');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        successIcon.appendChild(path);
        
        copyBtn.appendChild(copyIcon);
        copyBtn.appendChild(successIcon);
        ownerIdDd.appendChild(copyBtn);
        
        ownerIdDiv.appendChild(ownerIdDt);
        ownerIdDiv.appendChild(ownerIdDd);
        dl.appendChild(ownerIdDiv);
      }
      
      // JSON details
      if (eventData && Object.keys(eventData).length > 0) {
        const jsonDiv = document.createElement('div');
        jsonDiv.className = 'activity-entry__json';
        
        const jsonHeader = document.createElement('div');
        jsonHeader.className = 'activity-entry__json-header';
        const jsonHeaderSpan = document.createElement('span');
        jsonHeaderSpan.textContent = 'Details:';
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'activity-copy-btn';
        copyBtn.type = 'button';
        copyBtn.setAttribute('aria-label', 'Copy details');
        copyBtn.setAttribute('data-copy-json', 'true');
        
        const copyIcon = document.createElement('img');
        copyIcon.src = '<%= asset_path("icons/social/XS/copy.svg") %>';
        copyIcon.className = 'activity-copy-btn__icon activity-copy-btn__icon--copy';
        copyIcon.alt = '';
        
        const successIcon = document.createElement('svg');
        successIcon.className = 'activity-copy-btn__icon activity-copy-btn__icon--success';
        successIcon.setAttribute('viewBox', '0 0 16 16');
        successIcon.setAttribute('aria-hidden', 'true');
        successIcon.setAttribute('focusable', 'false');
        const path = document.createElement('path');
        path.setAttribute('d', 'M3 8.5l3 3L13 5');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'currentColor');
        path.setAttribute('stroke-width', '1.6');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        successIcon.appendChild(path);
        
        copyBtn.appendChild(copyIcon);
        copyBtn.appendChild(successIcon);
        
        jsonHeader.appendChild(jsonHeaderSpan);
        jsonHeader.appendChild(copyBtn);
        
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(eventData, null, 2);
        
        jsonDiv.appendChild(jsonHeader);
        jsonDiv.appendChild(pre);
        detailsDiv.appendChild(jsonDiv);
      }
      
      detailsDiv.appendChild(dl);
      details.appendChild(summary);
      details.appendChild(detailsDiv);
      
      return details;
    }

    // Function to load events from API
    async function loadEvents(page = 1) {
      if (isLoading || (!hasMore && page > 1)) return;

      isLoading = true;
      loadingIndicator.style.display = 'block';

      try {
        let url = `/events?page=${page}&per_page=${perPage}`;
        
        // Add date filters if provided
        if (dateFromInput && dateFromInput.value) {
          url += `&from=${encodeURIComponent(dateFromInput.value)}`;
        }
        if (dateToInput && dateToInput.value) {
          url += `&to=${encodeURIComponent(dateToInput.value)}`;
        }
        
        const result = await api.get(url);
        
        console.log('API response:', result);
        
        if (result.success && result.data) {
          const responseData = result.data;
          console.log('Response data:', responseData);
          let events = [];
          
          // Extract events array from JSONAPI format
          if (responseData.data && Array.isArray(responseData.data)) {
            events = responseData.data;
          } else if (Array.isArray(responseData)) {
            events = responseData;
          }
          
          console.log('Extracted events:', events);
          const pagination = responseData.pagination || {};

          if (page === 1) {
            allEvents = [];
            body.innerHTML = '';
          }

          allEvents = allEvents.concat(events);

          // Render events
          events.forEach(event => {
            body.appendChild(renderEventEntry(event));
          });

          // Update pagination state
          hasMore = pagination.has_more || false;
          currentPage = page;

          // Show/hide empty message
          if (allEvents.length === 0) {
            emptyMessage.style.display = 'block';
            errorMessage.style.display = 'none';
          } else {
            emptyMessage.style.display = 'none';
            errorMessage.style.display = 'none';
          }

          // Setup copy buttons for new entries
          setupCopyButtons();
        } else {
          console.error('Failed to load events:', result);
          errorText.textContent = result.error || 'Failed to load events. Please check console for details.';
          errorMessage.style.display = 'block';
          if (allEvents.length === 0) {
            emptyMessage.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading events:', error);
        errorText.textContent = `Error: ${error.message || 'Unknown error'}`;
        errorMessage.style.display = 'block';
        if (allEvents.length === 0) {
          emptyMessage.style.display = 'none';
        }
      } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // Infinite scroll handler
    function handleScroll() {
      if (isLoading || !hasMore) return;

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // Load more when user is 200px from bottom
      if (scrollTop + windowHeight >= documentHeight - 200) {
        loadEvents(currentPage + 1);
      }
    }

    // Throttle scroll events
    let scrollTimeout;
    window.addEventListener('scroll', function() {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = setTimeout(handleScroll, 100);
    });

    // Setup copy buttons functionality
    function setupCopyButtons() {
      // Copy value buttons
      document.querySelectorAll('[data-copy-value]').forEach(btn => {
        // Remove existing listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', async function() {
          const value = this.getAttribute('data-copy-value');
          try {
            await navigator.clipboard.writeText(value);
            const copyIcon = this.querySelector('.activity-copy-btn__icon--copy');
            const successIcon = this.querySelector('.activity-copy-btn__icon--success');
            if (copyIcon && successIcon) {
              copyIcon.style.display = 'none';
              successIcon.style.display = 'block';
              setTimeout(() => {
                copyIcon.style.display = 'block';
                successIcon.style.display = 'none';
              }, 2000);
            }
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        });
      });

      // Copy JSON buttons
      document.querySelectorAll('[data-copy-json]').forEach(btn => {
        // Remove existing listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', async function() {
          const pre = this.closest('.activity-entry__json').querySelector('pre');
          if (pre) {
            try {
              await navigator.clipboard.writeText(pre.textContent);
              const copyIcon = this.querySelector('.activity-copy-btn__icon--copy');
              const successIcon = this.querySelector('.activity-copy-btn__icon--success');
              if (copyIcon && successIcon) {
                copyIcon.style.display = 'none';
                successIcon.style.display = 'block';
                setTimeout(() => {
                  copyIcon.style.display = 'block';
                  successIcon.style.display = 'none';
                }, 2000);
              }
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
      });
    }

    // Date filter handlers
    if (dateFromInput) {
      dateFromInput.addEventListener('change', function() {
        currentPage = 1;
        hasMore = true;
        allEvents = [];
        loadEvents(1);
      });
    }

    if (dateToInput) {
      dateToInput.addEventListener('change', function() {
        currentPage = 1;
        hasMore = true;
        allEvents = [];
        loadEvents(1);
      });
    }

    // Load initial events
    loadEvents(1);
  });
</script>
