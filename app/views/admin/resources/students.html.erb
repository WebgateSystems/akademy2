<% content_for :page_title, "Students" %>
<%# Store asset path for JavaScript in a script tag %>
<script>
  window.STUDENTS_ASSET_PATHS = {
    buttonIcon: '<%= asset_path("icons/social/S/button-3.svg") %>'
  };
</script>

<section aria-label="Students list">
  <header class="schools-page__header">
    <label class="schools-search schools-search--half">
      <span class="visually-hidden">Search students</span>
      <input type="search" placeholder="Search student" id="students-search-input">
      <%= image_tag "icons/social/S/search.svg", alt: "", "aria-hidden": "true", "data-theme-icon": true %>
    </label>
    <button class="schools-page__add" type="button" data-open-modal="add-student-modal">Add student</button>
  </header>
  <div class="schools-page__controls"></div>

  <div class="students-panel">
    <table class="students-table">
      <thead class="students-table__head">
        <tr>
          <th scope="col" class="students-table__heading">Student name</th>
          <th scope="col" class="students-table__heading">Birth date</th>
          <th scope="col" class="students-table__heading">Email</th>
          <th scope="col" class="students-table__heading">Phone</th>
          <th scope="col" class="students-table__heading">School</th>
          <th scope="col" class="students-table__heading">Status</th>
          <th scope="col" class="students-table__heading students-table__heading--actions">Actions</th>
        </tr>
      </thead>
      <tbody class="students-table__body" id="students-table-body">
        <!-- Students will be loaded via API -->
      </tbody>
    </table>
    <div id="students-loading-indicator" class="students-loading" style="display: none; padding: 20px; text-align: center;">
      <div class="spinner" style="display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--content-primary); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
      <span style="margin-left: 12px; color: var(--content-secondary);">Loading students...</span>
    </div>
    <div id="students-empty-message" class="text-center" style="padding: 40px; color: var(--content-secondary); display: none;">
      No students yet
    </div>
  </div>
</section>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
    </table>
  </div>
</section>

<div class="schools-modal" id="add-student-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="add-student-title">
    <header class="schools-modal__header">
      <h3 id="add-student-title">Add student</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="add-student-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <form class="schools-modal__form headmaster-form" id="add-student-form">
      <label>
        <span>School<sup style="color: var(--content-secondary);">*</sup></span>
        <select name="student[school_id]" id="add-student-school" required>
          <option value="">Choose the school</option>
          <% School.all.each do |school| %>
            <option value="<%= school.id %>"><%= school.name %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Student name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="student[first_name]" id="add-student-first-name" placeholder="First name" required>
      </label>
      <label>
        <span>Last name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="student[last_name]" id="add-student-last-name" placeholder="Last name" required>
      </label>
      <label>
        <span>Email<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="email" name="student[email]" id="add-student-email" placeholder="student@school.pl" required>
      </label>
      <label>
        <span>Phone</span>
        <input type="text" name="student[metadata][phone]" id="add-student-phone" placeholder="+48 XXX XXX XXX">
      </label>
      <label>
        <span>Birth date</span>
        <input type="date" name="student[metadata][birth_date]" id="add-student-birth-date">
      </label>
      <div class="schools-modal__actions">
        <button type="submit" class="schools-modal__primary">Add</button>
        <button type="button" class="schools-modal__secondary" data-close-modal="add-student-modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="schools-modal" id="edit-student-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="edit-student-title">
    <header class="schools-modal__header">
      <h3 id="edit-student-title">Edit student</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="edit-student-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <form class="schools-modal__form headmaster-form" id="edit-student-form">
      <input type="hidden" id="edit-student-id" value="">
      <label>
        <span>School<sup style="color: var(--content-secondary);">*</sup></span>
        <select name="student[school_id]" id="edit-student-school" required>
          <option value="">Choose the school</option>
          <% School.all.each do |school| %>
            <option value="<%= school.id %>"><%= school.name %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Student name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="student[first_name]" id="edit-student-first-name" placeholder="First name" required>
      </label>
      <label>
        <span>Last name<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="text" name="student[last_name]" id="edit-student-last-name" placeholder="Last name" required>
      </label>
      <label>
        <span>Email<sup style="color: var(--content-secondary);">*</sup></span>
        <input type="email" name="student[email]" id="edit-student-email" placeholder="student@school.pl" required>
      </label>
      <label>
        <span>Phone</span>
        <input type="text" name="student[metadata][phone]" id="edit-student-phone" placeholder="+48 XXX XXX XXX">
      </label>
      <label>
        <span>Birth date</span>
        <input type="date" name="student[metadata][birth_date]" id="edit-student-birth-date">
      </label>
      <div class="schools-modal__actions">
        <button type="submit" class="schools-modal__primary" id="edit-student-save-btn">Save</button>
        <button type="button" class="schools-modal__secondary" data-close-modal="edit-student-modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="schools-modal" id="deactivate-student-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="deactivate-student-title">
    <header class="schools-modal__header">
      <h3 id="deactivate-student-title">Deactivate student</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="deactivate-student-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <div class="schools-modal__body">
      <p id="deactivate-student-message">Are you sure you want to deactivate <strong data-deactivate-name>this student</strong>? They will lose access immediately.</p>
    </div>
    <div class="schools-modal__actions">
      <button type="button" id="deactivate-student-confirm-btn" class="schools-modal__primary schools-modal__primary--danger">Deactivate</button>
      <button type="button" class="schools-modal__secondary" data-close-modal="deactivate-student-modal">Cancel</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Infinite scroll implementation
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    let allStudents = [];
    let filteredStudents = [];
    let isSearching = false;
    let currentSearchTerm = '';
    let searchTimeout = null;
    const perPage = 20;
    const SEARCH_MIN_LENGTH = 3; // Minimum characters to trigger API search
    const tbody = document.getElementById('students-table-body');
    const loadingIndicator = document.getElementById('students-loading-indicator');
    const emptyMessage = document.getElementById('students-empty-message');
    const searchInput = document.getElementById('students-search-input');

    if (typeof window.ApiClient === 'undefined') {
      console.error('ApiClient not available. Make sure api_client.js is loaded.');
      return;
    }

    const api = new window.ApiClient();

    // Function to render a student row
    function renderStudentRow(student) {
      // Handle JSONAPI format: student might be { id, type, attributes: {...} }
      const attrs = student.attributes || student;
      const name = [attrs.first_name, attrs.last_name].filter(Boolean).join(' ') || attrs.email;
      const birthDate = attrs.birth_date || '—';
      const email = attrs.email || '—';
      const phone = attrs.phone || '—';
      const schoolName = attrs.school_name || '—';
      const studentId = student.id || attrs.id;

      const row = document.createElement('tr');
      row.className = 'students-table__row';
      
      // Check if student is locked
      const isLocked = attrs.is_locked || attrs.locked_at;
      
      // Create cells
      const cells = [
        name, birthDate, email, phone, schoolName
      ].map(text => {
        const cell = document.createElement('td');
        cell.className = 'students-table__cell';
        cell.textContent = text;
        return cell;
      });
      
      // Status cell
      const statusCell = document.createElement('td');
      statusCell.className = 'students-table__cell';
      const statusBadge = document.createElement('span');
      if (isLocked) {
        statusBadge.textContent = 'Inactive';
        statusBadge.style.color = 'var(--state-error)';
        statusBadge.style.fontWeight = '500';
      } else {
        statusBadge.textContent = 'Active';
        statusBadge.style.color = 'var(--state-success)';
        statusBadge.style.fontWeight = '500';
      }
      statusCell.appendChild(statusBadge);
      
      // Actions cell
      const actionsCell = document.createElement('td');
      actionsCell.className = 'students-table__cell students-table__cell--actions';
      
      const studentsActionsDiv = document.createElement('div');
      studentsActionsDiv.className = 'students-actions';
      
      const headmastersActionsDiv = document.createElement('div');
      headmastersActionsDiv.className = 'headmasters-actions';
      
      const details = document.createElement('details');
      details.className = 'headmasters-menu';
      
      const summary = document.createElement('summary');
      summary.setAttribute('aria-label', 'Open actions menu');
      const img = document.createElement('img');
      // Get asset path from window variable set by Rails
      const buttonIconPath = (typeof window.STUDENTS_ASSET_PATHS !== 'undefined' && window.STUDENTS_ASSET_PATHS.buttonIcon) || '/assets/icons/social/S/button-3.svg';
      img.src = buttonIconPath;
      img.alt = '';
      img.setAttribute('data-theme-icon', 'true');
      summary.appendChild(img);
      
      const ul = document.createElement('ul');
      
      // Edit button
      const editLi = document.createElement('li');
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.setAttribute('data-action', 'edit-student');
      editBtn.setAttribute('data-student-id', studentId);
      editBtn.setAttribute('data-student-first-name', attrs.first_name || '');
      editBtn.setAttribute('data-student-last-name', attrs.last_name || '');
      editBtn.setAttribute('data-student-school-id', attrs.school_id || '');
      editBtn.setAttribute('data-student-email', attrs.email || '');
      editBtn.setAttribute('data-student-phone', attrs.phone || '');
      editBtn.setAttribute('data-student-birth-date', attrs.birth_date || '');
      editBtn.textContent = 'Edit';
      editLi.appendChild(editBtn);
      
      // Resend invite button
      const resendLi = document.createElement('li');
      const resendBtn = document.createElement('button');
      resendBtn.type = 'button';
      resendBtn.setAttribute('data-action', 'resend-invite');
      resendBtn.setAttribute('data-student-id', studentId);
      resendBtn.setAttribute('data-student-email', attrs.email || '');
      resendBtn.textContent = 'Resend invite';
      resendLi.appendChild(resendBtn);
      
      // Deactivate/Activate button
      const deactivateLi = document.createElement('li');
      const deactivateBtn = document.createElement('button');
      deactivateBtn.type = 'button';
      deactivateBtn.setAttribute('data-action', 'deactivate-student');
      deactivateBtn.setAttribute('data-student-id', studentId);
      deactivateBtn.setAttribute('data-student-name', name);
      deactivateBtn.setAttribute('data-student-is-locked', isLocked ? 'true' : 'false');
      deactivateBtn.textContent = isLocked ? 'Activate' : 'Deactivate';
      deactivateLi.appendChild(deactivateBtn);
      
      ul.appendChild(editLi);
      ul.appendChild(resendLi);
      ul.appendChild(deactivateLi);
      
      details.appendChild(summary);
      details.appendChild(ul);
      headmastersActionsDiv.appendChild(details);
      studentsActionsDiv.appendChild(headmastersActionsDiv);
      actionsCell.appendChild(studentsActionsDiv);
      
      // Append all cells to row
      cells.forEach(cell => row.appendChild(cell));
      row.appendChild(statusCell);
      row.appendChild(actionsCell);
      
      return row;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Function to load students from API
    async function loadStudents(page = 1, searchTerm = '') {
      if (isLoading || (!hasMore && page > 1)) return;

      isLoading = true;
      loadingIndicator.style.display = 'block';

      try {
        let url = `/students?page=${page}&per_page=${perPage}`;
        if (searchTerm && searchTerm.length >= SEARCH_MIN_LENGTH) {
          url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        const result = await api.get(url);
        
        if (result.success && result.data) {
          // JSONAPI::Serializer returns: { data: [{ id, type, attributes: {...} }, ...], pagination: {...} }
          // result.data is the whole response object
          const responseData = result.data;
          let students = [];
          
          // Extract students array from JSONAPI format
          if (responseData.data && Array.isArray(responseData.data)) {
            students = responseData.data;
          } else if (Array.isArray(responseData)) {
            // Fallback: if it's already an array
            students = responseData;
          }
          
          const pagination = responseData.pagination || {};

          if (page === 1) {
            allStudents = [];
            tbody.innerHTML = '';
          }

          allStudents = allStudents.concat(students);
          filteredStudents = allStudents;

          // Render students
          students.forEach(student => {
            tbody.appendChild(renderStudentRow(student));
          });

          // Update pagination state
          hasMore = pagination.has_more || false;
          currentPage = page;

          // Show/hide empty message
          if (allStudents.length === 0) {
            emptyMessage.style.display = 'block';
          } else {
            emptyMessage.style.display = 'none';
          }

          // Re-setup menus for new rows
          setupStudentMenus();
          // Re-setup event handlers for dynamically added buttons
          setupEditStudentHandler();
          setupResendInviteHandler();
          setupDeactivateStudentHandler();
        } else {
          console.error('Failed to load students:', result.error);
        }
      } catch (error) {
        console.error('Error loading students:', error);
      } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
      }
    }

    // Infinite scroll handler
    function handleScroll() {
      if (isLoading || !hasMore) return;
      
      // Don't load more if searching locally (short search term)
      if (isSearching && currentSearchTerm.length < SEARCH_MIN_LENGTH) {
        return;
      }

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;

      // Load more when user is 200px from bottom
      if (scrollTop + windowHeight >= documentHeight - 200) {
        loadStudents(currentPage + 1, currentSearchTerm);
      }
    }

    // Throttle scroll events
    let scrollTimeout;
    window.addEventListener('scroll', function() {
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      scrollTimeout = setTimeout(handleScroll, 100);
    });

    // Search/filter functionality
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        currentSearchTerm = searchTerm;
        
        // Clear previous timeout
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        // If search is empty, reset to show all loaded students
        if (!searchTerm) {
          isSearching = false;
          currentPage = 1;
          hasMore = true;
          allStudents = [];
          tbody.innerHTML = '';
          loadStudents(1);
          return;
        }

        // If search term is long enough, search via API
        if (searchTerm.length >= SEARCH_MIN_LENGTH) {
          isSearching = true;
          // Debounce API calls
          searchTimeout = setTimeout(() => {
            currentPage = 1;
            hasMore = true;
            allStudents = [];
            tbody.innerHTML = '';
            loadStudents(1, searchTerm);
          }, 300); // Wait 300ms after user stops typing
        } else {
          // For short search terms, filter locally from loaded students
          isSearching = true;
          const searchTermLower = searchTerm.toLowerCase();
          
          filteredStudents = allStudents.filter(student => {
            const attrs = student.attributes || student;
            const name = [attrs.first_name, attrs.last_name].filter(Boolean).join(' ').toLowerCase() || (attrs.email || '').toLowerCase();
            const birthDate = (attrs.birth_date || '').toLowerCase();
            const email = (attrs.email || '').toLowerCase();
            const phone = (attrs.phone || '').toLowerCase();
            const schoolName = (attrs.school_name || '').toLowerCase();
            const isLocked = attrs.is_locked || attrs.locked_at;
            const status = isLocked ? 'inactive' : 'active';

            return name.includes(searchTermLower) ||
                   birthDate.includes(searchTermLower) ||
                   email.includes(searchTermLower) ||
                   phone.includes(searchTermLower) ||
                   schoolName.includes(searchTermLower) ||
                   status.includes(searchTermLower);
          });

          // Re-render filtered students
          tbody.innerHTML = '';
          filteredStudents.forEach(student => {
            tbody.appendChild(renderStudentRow(student));
          });

          // Show/hide empty message
          if (filteredStudents.length === 0) {
            emptyMessage.style.display = 'block';
          } else {
            emptyMessage.style.display = 'none';
          }

          setupStudentMenus();
        }
      });
    }

    // Load initial students
    loadStudents(1);

    // Handle student menu positioning (same as headmasters)
    function setupStudentMenus() {
      const menus = document.querySelectorAll('.headmasters-menu');
      const tbody = document.querySelector('.students-table__body');
      if (!tbody) return;

      menus.forEach((menu) => {
        const summary = menu.querySelector('summary');
        if (!summary) return;

        menu.addEventListener('toggle', function() {
          if (menu.open) {
            menus.forEach(m => {
              if (m !== menu && m.open) {
                m.open = false;
              }
            });

            requestAnimationFrame(() => {
              const summaryRect = summary.getBoundingClientRect();
              const ul = menu.querySelector('ul');
              if (!ul) return;

              const ulHeight = ul.offsetHeight || 150;
              const spaceBelow = window.innerHeight - summaryRect.bottom;
              const spaceAbove = summaryRect.top;
              const row = menu.closest('tr');
              const rows = Array.from(tbody.querySelectorAll('tr'));
              const rowIndex = rows.indexOf(row);
              const totalRows = rows.length;

              ul.style.position = 'fixed';
              ul.style.zIndex = '999999';
              ul.style.isolation = 'isolate';
              ul.style.transform = 'translateZ(0)';
              ul.style.willChange = 'transform';
              
              if (totalRows === 1) {
                menu.removeAttribute('data-menu-align');
                ul.style.top = (summaryRect.bottom + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.bottom = 'auto';
              } else if (spaceBelow < ulHeight + 20 && spaceAbove > ulHeight + 20 && rowIndex >= totalRows - 2) {
                menu.setAttribute('data-menu-align', 'top');
                ul.style.bottom = (window.innerHeight - summaryRect.top + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.top = 'auto';
              } else {
                menu.removeAttribute('data-menu-align');
                ul.style.top = (summaryRect.bottom + 10) + 'px';
                ul.style.right = (window.innerWidth - summaryRect.right) + 'px';
                ul.style.bottom = 'auto';
              }
            });
          } else {
            const ul = menu.querySelector('ul');
            if (ul) {
              ul.style.position = '';
              ul.style.top = '';
              ul.style.bottom = '';
              ul.style.right = '';
              ul.style.zIndex = '';
              ul.style.transform = '';
              ul.style.willChange = '';
            }
          }
        });

        const ul = menu.querySelector('ul');
        if (ul) {
          ul.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      });

      let clickHandler = function(e) {
        if (!e.target.closest('.headmasters-menu')) {
          menus.forEach(m => {
            if (m.open) {
              m.open = false;
            }
          });
        }
      };
      
      document.addEventListener('click', clickHandler, true);
    }

    setupStudentMenus();

    // Modal handlers
    document.querySelectorAll('[data-open-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-open-modal');
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.setAttribute('aria-hidden', 'false');
          modal.classList.add('is-open');
        }
      });
    });

    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modalId = btn.getAttribute('data-close-modal');
        const modal = document.getElementById(modalId);
        if (modal) {
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) {
            focusedElement.blur();
          }
          
          // Reset deactivate modal state when closing
          if (modalId === 'deactivate-student-modal') {
            const confirmBtn = document.getElementById('deactivate-student-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Deactivate'; // Reset to default
            }
            deactivateStudentId = null;
          }
          
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    document.querySelectorAll('.schools-modal__overlay').forEach(overlay => {
      overlay.addEventListener('click', function() {
        const modal = this.closest('.schools-modal');
        if (modal) {
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) {
            focusedElement.blur();
          }
          
          // Reset deactivate modal state when closing via overlay
          if (modal.id === 'deactivate-student-modal') {
            const confirmBtn = document.getElementById('deactivate-student-confirm-btn');
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.removeAttribute('aria-disabled');
              confirmBtn.textContent = 'Deactivate'; // Reset to default
            }
            deactivateStudentId = null;
          }
          
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Edit student button handler - using event delegation for dynamically added buttons
    function setupEditStudentHandler() {
      // Use capture phase to catch events before they bubble
      if (tbody) {
        tbody.removeEventListener('click', handleEditStudentClick, true);
        tbody.addEventListener('click', handleEditStudentClick, true);
      }
    }

    async function handleEditStudentClick(e) {
      // Check if clicked element or its parent is the edit button
      const btn = e.target.closest('[data-action="edit-student"]');
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const modal = document.getElementById('edit-student-modal');
      if (!modal) {
        console.error('Edit student modal not found');
        return;
      }

      const studentId = btn.getAttribute('data-student-id');
      if (!studentId) {
        console.error('Student ID not found');
        return;
      }

      // Get initial values from data attributes (for quick display)
      const firstName = btn.getAttribute('data-student-first-name') || '';
      const lastName = btn.getAttribute('data-student-last-name') || '';
      const schoolId = btn.getAttribute('data-student-school-id') || '';
      const email = btn.getAttribute('data-student-email') || '';
      const phone = btn.getAttribute('data-student-phone') || '';
      const birthDate = btn.getAttribute('data-student-birth-date') || '';

      // Set basic fields immediately
      const idField = document.getElementById('edit-student-id');
      if (idField) idField.value = studentId || '';

      const firstNameField = document.getElementById('edit-student-first-name');
      if (firstNameField) firstNameField.value = firstName;

      const lastNameField = document.getElementById('edit-student-last-name');
      if (lastNameField) lastNameField.value = lastName;

      const emailField = document.getElementById('edit-student-email');
      if (emailField) emailField.value = email;

      const phoneField = document.getElementById('edit-student-phone');
      if (phoneField) phoneField.value = phone;

      // Set birth date from button attribute
      const birthDateField = document.getElementById('edit-student-birth-date');
      if (birthDateField && birthDate && birthDate.trim() !== '') {
        const parts = birthDate.split('.');
        if (parts.length === 3) {
          const [day, month, year] = parts;
          birthDateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
      }

      // Open modal immediately
      modal.setAttribute('aria-hidden', 'false');
      modal.classList.add('is-open');

      // Fetch full student data from API to ensure we have the correct school_id
      try {
        const result = await api.get(`/students/${studentId}`);
        const schoolField = document.getElementById('edit-student-school');
        
        if (result.success && result.data && schoolField) {
          // Handle JSONAPI format: result.data might be { data: { id, type, attributes: {...} } }
          let studentData = null;
          let apiSchoolId = null;
          
          if (result.data.data && result.data.data.attributes) {
            // JSONAPI format: { data: { data: { attributes: {...} } } }
            studentData = result.data.data.attributes;
            apiSchoolId = studentData.school_id;
          } else if (result.data.attributes) {
            // JSONAPI format: { data: { attributes: {...} } }
            studentData = result.data.attributes;
            apiSchoolId = studentData.school_id;
          } else if (result.data.school_id !== undefined) {
            // Direct format: { data: { school_id: ... } }
            studentData = result.data;
            apiSchoolId = studentData.school_id;
          }
          
          // Set school_id from API response
          if (apiSchoolId) {
            const schoolIdStr = String(apiSchoolId).trim();
            
            // Remove selected attribute from all options first
            Array.from(schoolField.options).forEach(opt => {
              opt.removeAttribute('selected');
              opt.selected = false;
            });
            
            // Find and select the matching option
            const matchingOption = Array.from(schoolField.options).find(opt => {
              return String(opt.value).trim() === schoolIdStr;
            });
            
            if (matchingOption) {
              matchingOption.selected = true;
              matchingOption.setAttribute('selected', 'selected');
              schoolField.value = schoolIdStr;
            }
          } else if (schoolId) {
            // Fallback to button value if API doesn't have school_id
            const schoolIdStr = String(schoolId).trim();
            Array.from(schoolField.options).forEach(opt => {
              opt.removeAttribute('selected');
              opt.selected = false;
            });
            const matchingOption = Array.from(schoolField.options).find(opt => {
              return String(opt.value).trim() === schoolIdStr;
            });
            if (matchingOption) {
              matchingOption.selected = true;
              matchingOption.setAttribute('selected', 'selected');
              schoolField.value = schoolIdStr;
            }
          }
          
          // Update birth date if available from API
          if (studentData && studentData.birth_date) {
            const birthDateField = document.getElementById('edit-student-birth-date');
            if (birthDateField) {
              const parts = studentData.birth_date.split('.');
              if (parts.length === 3) {
                const [day, month, year] = parts;
                birthDateField.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
              }
            }
          }
        } else if (schoolField && schoolId) {
          // Fallback to button value if API response is not successful
          schoolField.value = schoolId;
        }
      } catch (error) {
        console.error('Error fetching student data:', error);
        // Fallback to button values if API call fails
        const schoolField = document.getElementById('edit-student-school');
        if (schoolField && schoolId) {
          schoolField.value = schoolId;
        }
      }

      const saveBtn = document.getElementById('edit-student-save-btn');
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.removeAttribute('aria-disabled');
        saveBtn.classList.remove('is-disabled');
      }

      // Remove old listeners to avoid duplicates
      const form = document.getElementById('edit-student-form');
      if (form) {
        const formInputs = form.querySelectorAll('input, select');
        const enableSaveBtn = () => {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.removeAttribute('aria-disabled');
            saveBtn.classList.remove('is-disabled');
          }
        };
        
        // Remove old listeners by cloning and replacing
        formInputs.forEach(input => {
          const newInput = input.cloneNode(true);
          input.parentNode.replaceChild(newInput, input);
          newInput.addEventListener('input', enableSaveBtn);
          newInput.addEventListener('change', enableSaveBtn);
        });
      }

      // Close the menu
      const menu = btn.closest('.headmasters-menu');
      if (menu) menu.open = false;
    }

    setupEditStudentHandler();

    // Form submission handlers using API
    if (typeof window.ApiClient === 'undefined') {
      console.error('ApiClient not available. Make sure api_client.js is loaded.');
    } else {
      const api = new window.ApiClient();

      // Add student form submission
      const addForm = document.getElementById('add-student-form');
      if (addForm) {
        addForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = addForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'Adding...';

          try {
            const formData = new FormData(addForm);
            
            // Convert date from YYYY-MM-DD to DD.MM.YYYY format
            const birthDateRaw = formData.get('student[metadata][birth_date]') || '';
            let birthDate = '';
            if (birthDateRaw) {
              const dateParts = birthDateRaw.split('-');
              if (dateParts.length === 3) {
                const [year, month, day] = dateParts;
                birthDate = `${day}.${month}.${year}`;
              }
            }
            
            const data = {
              student: {
                school_id: formData.get('student[school_id]'),
                first_name: formData.get('student[first_name]'),
                last_name: formData.get('student[last_name]'),
                email: formData.get('student[email]'),
                metadata: {
                  phone: formData.get('student[metadata][phone]') || '',
                  birth_date: birthDate
                }
              }
            };

            const result = await api.post('/students', data);
            
            if (result.success) {
              const modal = document.getElementById('add-student-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              // Reload students list
              currentPage = 1;
              hasMore = true;
              allStudents = [];
              currentSearchTerm = '';
              searchInput.value = '';
              loadStudents(1);
            } else {
              console.error('API error:', result.error);
              alert('Error: ' + String(result.error || 'Failed to create student'));
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Edit student form submission
      const editForm = document.getElementById('edit-student-form');
      if (editForm) {
        editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = editForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          const studentIdField = document.getElementById('edit-student-id');
          
          if (!studentIdField || !studentIdField.value) {
            alert('Error: Student ID is missing');
            return;
          }
          
          const studentId = studentIdField.value;
          
          submitBtn.disabled = true;
          submitBtn.textContent = 'Saving...';

          try {
            const formData = new FormData(editForm);
            
            // Convert date from YYYY-MM-DD to DD.MM.YYYY format
            const birthDateRaw = formData.get('student[metadata][birth_date]') || '';
            let birthDate = '';
            if (birthDateRaw) {
              const dateParts = birthDateRaw.split('-');
              if (dateParts.length === 3) {
                const [year, month, day] = dateParts;
                birthDate = `${day}.${month}.${year}`;
              }
            }
            
            const data = {
              student: {
                school_id: formData.get('student[school_id]'),
                first_name: formData.get('student[first_name]'),
                last_name: formData.get('student[last_name]'),
                email: formData.get('student[email]'),
                metadata: {
                  phone: formData.get('student[metadata][phone]') || '',
                  birth_date: birthDate
                }
              }
            };

            const result = await api.patch(`/students/${studentId}`, data);
            
            if (result.success) {
              const modal = document.getElementById('edit-student-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              // Reload students list
              currentPage = 1;
              hasMore = true;
              allStudents = [];
              currentSearchTerm = '';
              searchInput.value = '';
              loadStudents(1);
            } else {
              console.error('API error:', result.error);
              alert('Error: ' + String(result.error || 'Failed to update student'));
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Form submission error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
      }

      // Resend invite handler - using event delegation
      function setupResendInviteHandler() {
        tbody.removeEventListener('click', handleResendInviteClick, true);
        tbody.addEventListener('click', handleResendInviteClick, true);
      }

      async function handleResendInviteClick(e) {
        const btn = e.target.closest('[data-action="resend-invite"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        const studentId = btn.getAttribute('data-student-id');
        
        if (!studentId) {
          console.error('Error: Student ID is missing');
          return;
        }
        
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        
        try {
          const result = await api.post(`/students/${studentId}/resend_invite`, {});
          
          if (result.success) {
            btn.textContent = 'Sent!';
            btn.style.color = 'var(--state-success)';
            
            // Close the menu
            const menu = btn.closest('.headmasters-menu');
            if (menu) menu.open = false;
            
            setTimeout(() => {
              btn.disabled = false;
              btn.textContent = originalText;
              btn.style.color = '';
            }, 2000);
          } else {
            console.error('Error:', result.error || 'Failed to resend invite');
            btn.disabled = false;
            btn.textContent = originalText;
          }
        } catch (error) {
          console.error('Resend invite error:', error);
          btn.disabled = false;
          btn.textContent = originalText;
        }
      }

      setupResendInviteHandler();

      // Deactivate student handler - using event delegation
      let deactivateStudentId = null;
      
      function setupDeactivateStudentHandler() {
        tbody.removeEventListener('click', handleDeactivateStudentClick, true);
        tbody.addEventListener('click', handleDeactivateStudentClick, true);
      }

      function handleDeactivateStudentClick(e) {
        const btn = e.target.closest('[data-action="deactivate-student"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        deactivateStudentId = btn.getAttribute('data-student-id');
        const name = btn.getAttribute('data-student-name') || '';
        const isLocked = btn.getAttribute('data-student-is-locked') === 'true';
        
        const deactivateNameEl = document.querySelector('[data-deactivate-name]');
        if (deactivateNameEl) {
          deactivateNameEl.textContent = name;
        }
        
        // Reset and update modal title and message based on status
        const modalTitle = document.getElementById('deactivate-student-title');
        const modalMessage = document.getElementById('deactivate-student-message');
        const confirmBtn = document.getElementById('deactivate-student-confirm-btn');
        
        // Always reset button state first
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.removeAttribute('aria-disabled');
        }
        
        if (isLocked) {
          if (modalTitle) modalTitle.textContent = 'Activate student';
          if (modalMessage) modalMessage.textContent = `Are you sure you want to activate ${name}? They will regain access immediately.`;
          if (confirmBtn) {
            confirmBtn.textContent = 'Activate';
            confirmBtn.classList.remove('schools-modal__primary--danger');
          }
        } else {
          if (modalTitle) modalTitle.textContent = 'Deactivate student';
          if (modalMessage) modalMessage.textContent = `Are you sure you want to deactivate ${name}? They will lose access immediately.`;
          if (confirmBtn) {
            confirmBtn.textContent = 'Deactivate';
            confirmBtn.classList.add('schools-modal__primary--danger');
          }
        }
        
        // Close the menu
        const menu = btn.closest('.headmasters-menu');
        if (menu) menu.open = false;
        
        const deactivateModal = document.getElementById('deactivate-student-modal');
        if (deactivateModal) {
          deactivateModal.setAttribute('aria-hidden', 'false');
          deactivateModal.classList.add('is-open');
        }
      }

      setupDeactivateStudentHandler();

      // Deactivate student confirm
      const deactivateBtn = document.getElementById('deactivate-student-confirm-btn');
      if (deactivateBtn) {
        deactivateBtn.addEventListener('click', async () => {
          if (!deactivateStudentId) return;
          
          const originalText = deactivateBtn.textContent;
          deactivateBtn.disabled = true;
          deactivateBtn.textContent = 'Processing...';

          try {
            const result = await api.post(`/students/${deactivateStudentId}/lock`, {});
            
            if (result.success) {
              const modal = document.getElementById('deactivate-student-modal');
              if (modal) {
                const focusedElement = modal.querySelector(':focus');
                if (focusedElement) focusedElement.blur();
                modal.setAttribute('aria-hidden', 'true');
                modal.classList.remove('is-open');
              }
              
              // Find the button that triggered this action to get current locked status
              const triggerBtn = Array.from(document.querySelectorAll('[data-action="deactivate-student"]'))
                .find(btn => btn.getAttribute('data-student-id') === deactivateStudentId);
              
              if (triggerBtn) {
                const wasLocked = triggerBtn.getAttribute('data-student-is-locked') === 'true';
                const newLockedStatus = !wasLocked;
                
                // Find and update the row in DOM
                const row = triggerBtn.closest('tr');
                if (row) {
                  // Update status cell (6th column - after name, birth date, email, phone, school)
                  const statusCell = row.querySelector('td:nth-child(6)');
                  if (statusCell) {
                    const statusBadge = statusCell.querySelector('span');
                    if (statusBadge) {
                      if (newLockedStatus) {
                        statusBadge.textContent = 'Inactive';
                        statusBadge.style.color = 'var(--state-error)';
                      } else {
                        statusBadge.textContent = 'Active';
                        statusBadge.style.color = 'var(--state-success)';
                      }
                    }
                  }
                  
                  // Update deactivate button text and data attribute
                  triggerBtn.textContent = newLockedStatus ? 'Activate' : 'Deactivate';
                  triggerBtn.setAttribute('data-student-is-locked', newLockedStatus ? 'true' : 'false');
                }
                
                // Update student in local data
                const studentIndex = allStudents.findIndex(t => {
                  const attrs = t.attributes || t;
                  const id = t.id || attrs.id;
                  return id === deactivateStudentId;
                });
                
                if (studentIndex !== -1) {
                  const student = allStudents[studentIndex];
                  const attrs = student.attributes || student;
                  
                  // Update locked status in local data
                  if (student.attributes) {
                    student.attributes.is_locked = newLockedStatus;
                    student.attributes.locked_at = newLockedStatus ? new Date().toISOString() : null;
                  } else if (attrs) {
                    attrs.is_locked = newLockedStatus;
                    attrs.locked_at = newLockedStatus ? new Date().toISOString() : null;
                  }
                }
              } else {
                // If button not found, reload from API
                currentPage = 1;
                hasMore = true;
                allStudents = [];
                currentSearchTerm = '';
                if (searchInput) searchInput.value = '';
                loadStudents(1);
              }
            } else {
              alert('Error: ' + String(result.error || 'Failed to update student status'));
              deactivateBtn.disabled = false;
              deactivateBtn.textContent = originalText;
            }
          } catch (error) {
            console.error('Deactivate error:', error);
            alert('Error: ' + String(error.message || 'Unknown error'));
            deactivateBtn.disabled = false;
            deactivateBtn.textContent = originalText;
          }
        });
      }
    }
  });
</script>

