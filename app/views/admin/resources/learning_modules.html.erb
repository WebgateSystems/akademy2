<% content_for :page_title, "Moduły" %>

<section aria-label="Lista modułów">
  <header class="schools-page__header">
    <label class="schools-search schools-search--half">
      <span class="visually-hidden">Szukaj modułów</span>
      <input type="search" placeholder="Szukaj..." id="learning-modules-search-input">
      <%= image_tag "icons/social/S/search.svg", alt: "", "aria-hidden": "true" %>
    </label>
    <%= link_to admin_new_resource_path(resource: 'learning_modules'), class: "schools-page__add", style: "text-decoration: none;" do %>
      Dodaj moduł
    <% end %>
  </header>
  <div class="schools-page__controls"></div>
  <div class="schools-card">
    <table class="schools-page__table">
      <thead>
        <tr>
          <th scope="col" class="left">Lp.</th>
          <th scope="col" class="left">Tytuł</th>
          <th scope="col" class="left">Jednostka</th>
          <th scope="col" class="left">Przedmiot</th>
          <th scope="col" class="left">Opublikowany</th>
          <th scope="col" class="left">Pojedynczy przepływ</th>
          <th scope="col" class="right">Akcje</th>
        </tr>
      </thead>
      <tbody id="learning-modules-tbody">
        <% @records.each do |module_record| %>
          <tr data-learning-module-id="<%= module_record.id %>" draggable="true" class="sortable-row">
            <td class="sortable-handle" style="cursor: move; user-select: none;">
              <span class="order-index"><%= module_record.order_index %></span>
            </td>
            <td>
              <strong><%= module_record.title %></strong>
            </td>
            <td>
              <%= module_record.unit&.title || '—' %>
            </td>
            <td>
              <%= module_record.unit&.subject&.title || '—' %>
            </td>
            <td>
              <% if module_record.published? %>
                <span style="color: var(--content-success);">✓ Opublikowany</span>
              <% else %>
                <span style="color: var(--content-secondary);">—</span>
              <% end %>
            </td>
            <td>
              <% if module_record.single_flow? %>
                <span style="color: var(--content-primary);">✓</span>
              <% else %>
                <span style="color: var(--content-secondary);">—</span>
              <% end %>
            </td>
            <td class="schools-page__actions">
              <%= link_to admin_resource_path(resource: 'learning_modules', id: module_record.id), "aria-label": "Pokaż moduł" do %>
                <%= image_tag "icons/social/S/search.svg", alt: "" %>
              <% end %>
              <%= link_to admin_edit_resource_path(resource: 'learning_modules', id: module_record.id), "aria-label": "Edytuj moduł" do %>
                <%= image_tag "icons/social/S/edit.svg", alt: "" %>
              <% end %>
              <button type="button" aria-label="Usuń moduł" data-action="delete-learning-module" data-learning-module-id="<%= module_record.id %>" data-learning-module-title="<%= h(module_record.title&.to_s || '') %>">
                <%= image_tag "icons/social/S/delete.svg", alt: "" %>
              </button>
            </td>
          </tr>
        <% end %>
        <% if @records.empty? %>
          <tr>
            <td colspan="7" class="text-center" style="padding: 40px; color: var(--content-secondary);">No learning modules yet</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</section>

<div class="schools-modal" id="delete-learning-module-modal" aria-hidden="true">
  <div class="schools-modal__overlay"></div>
  <div class="schools-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="delete-learning-module-modal-title">
    <header class="schools-modal__header">
      <h3 id="delete-learning-module-modal-title">Delete learning module</h3>
      <button class="schools-modal__close" type="button" aria-label="Close modal" data-close-modal="delete-learning-module-modal">
        <%= image_tag "icons/social/S/close.svg", alt: "", "data-theme-icon": true %>
      </button>
    </header>
    <div class="schools-modal__body">
      <p>Are you sure you want to delete <strong data-learning-module-delete-title>this learning module</strong>? This action cannot be undone.</p>
    </div>
    <div class="schools-modal__actions">
      <button type="button" id="delete-learning-module-confirm-btn" class="schools-modal__primary schools-modal__primary--danger">Delete</button>
      <button type="button" class="schools-modal__secondary" data-close-modal="delete-learning-module-modal">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Search functionality and delete handler
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('learning-modules-search-input');
    const learningModulesTable = document.getElementById('learning-modules-tbody');
    
    if (searchInput && learningModulesTable) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const rows = learningModulesTable.querySelectorAll('tr');
        
        rows.forEach(row => {
          // Skip empty row message
          if (row.querySelector('td[colspan]')) {
            row.style.display = '';
            return;
          }
          
          // Get text content from relevant cells
          const cells = row.querySelectorAll('td');
          if (cells.length < 7) return;
          
          const titleCell = cells[1];
          const unitCell = cells[2];
          const subjectCell = cells[3];
          
          // Get text content
          const titleText = titleCell.textContent.toLowerCase();
          const unitText = unitCell.textContent.toLowerCase();
          const subjectText = subjectCell.textContent.toLowerCase();
          
          // Check if search term matches
          const matches = titleText.includes(searchTerm) || unitText.includes(searchTerm) || subjectText.includes(searchTerm);
          
          // Show/hide row based on match
          row.style.display = matches ? '' : 'none';
        });
        
        // Show/hide empty message based on visible rows
        const visibleRows = Array.from(rows).filter(row => {
          return row.style.display !== 'none' && !row.querySelector('td[colspan]');
        });
        
        const emptyRow = learningModulesTable.querySelector('tr td[colspan]');
        if (emptyRow) {
          const emptyRowElement = emptyRow.closest('tr');
          if (emptyRowElement) {
            emptyRowElement.style.display = visibleRows.length === 0 ? '' : 'none';
          }
        }
      });
    }

    // Delete learning module handler
    let deleteLearningModuleId = null;

    document.querySelectorAll('[data-action="delete-learning-module"]').forEach(btn => {
      btn.addEventListener('click', () => {
        deleteLearningModuleId = btn.getAttribute('data-learning-module-id');
        const title = btn.getAttribute('data-learning-module-title') || '';
        const deleteTitleEl = document.querySelector('[data-learning-module-delete-title]');
        if (deleteTitleEl) {
          deleteTitleEl.textContent = title;
        }
        
        const deleteModal = document.getElementById('delete-learning-module-modal');
        if (deleteModal) {
          deleteModal.setAttribute('aria-hidden', 'false');
          deleteModal.classList.add('is-open');
        }
      });
    });

    // Close modal handlers
    document.querySelectorAll('[data-close-modal="delete-learning-module-modal"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const modal = document.getElementById('delete-learning-module-modal');
        if (modal) {
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) focusedElement.blur();
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    });

    // Close on overlay click
    const overlay = document.querySelector('#delete-learning-module-modal .schools-modal__overlay');
    if (overlay) {
      overlay.addEventListener('click', function() {
        const modal = document.getElementById('delete-learning-module-modal');
        if (modal) {
          const focusedElement = modal.querySelector(':focus');
          if (focusedElement) focusedElement.blur();
          modal.setAttribute('aria-hidden', 'true');
          modal.classList.remove('is-open');
        }
      });
    }

    // Delete learning module confirm button
    const deleteBtn = document.getElementById('delete-learning-module-confirm-btn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', async () => {
        if (!deleteLearningModuleId) return;
        
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'Deleting...';

        try {
          // Get CSRF token from meta tag
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          if (!csrfToken) {
            throw new Error('CSRF token not found');
          }

          const url = `/admin/learning_modules/${deleteLearningModuleId}`;
          
          // Rails expects CSRF token in both header and body for DELETE requests
          const formData = new URLSearchParams();
          formData.append('_method', 'delete');
          formData.append('authenticity_token', csrfToken);
          
          // Use fetch with proper CSRF token in both header and body
          const response = await fetch(url, {
            method: 'POST', // Use POST because Rails uses _method override for DELETE
            headers: {
              'X-CSRF-Token': csrfToken,
              'Accept': 'text/html',
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString(),
            credentials: 'same-origin'
          });

          // Close modal first
          const modal = document.getElementById('delete-learning-module-modal');
          if (modal) {
            const focusedElement = modal.querySelector(':focus');
            if (focusedElement) focusedElement.blur();
            modal.setAttribute('aria-hidden', 'true');
            modal.classList.remove('is-open');
          }

          // Rails redirects on destroy (302/303) - follow redirect
          if (response.status === 303 || response.status === 302) {
            const redirectUrl = response.headers.get('Location') || '/admin/learning_modules';
            window.location.href = redirectUrl;
          } else if (response.ok) {
            // Success - reload
            window.location.reload();
          } else {
            // Error - try to get message from response
            let errorMessage = 'Nie można usunąć modułu edukacyjnego';
            try {
              const text = await response.text();
              if (text) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const alertElement = doc.querySelector('.alert-danger');
                if (alertElement) {
                  errorMessage = alertElement.textContent.trim();
                }
              }
            } catch (e) {
              console.error('Error parsing response:', e);
            }
            
            alert(errorMessage);
            deleteBtn.disabled = false;
            deleteBtn.textContent = 'Delete';
          }
        } catch (error) {
          console.error('Delete error:', error);
          
          // Close modal even on error
          const modal = document.getElementById('delete-learning-module-modal');
          if (modal) {
            const focusedElement = modal.querySelector(':focus');
            if (focusedElement) focusedElement.blur();
            modal.setAttribute('aria-hidden', 'true');
            modal.classList.remove('is-open');
          }
          
          alert('Error: ' + String(error.message || 'Unknown error'));
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'Delete';
        }
      });
    }
  });
</script>

