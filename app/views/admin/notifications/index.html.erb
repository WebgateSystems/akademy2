<% content_for :page_title, "Notifications center" %>

<section class="notifications-board" aria-label="Notifications timeline">
  <div class="notifications-board__filters">
    <label>
      <span>Type</span>
      <select id="notification-type-filter">
        <option value="all" <%= 'selected' if @type_filter == 'all' %>>All types</option>
        <option value="teacher_awaiting_approval" <%= 'selected' if @type_filter == 'teacher_awaiting_approval' %>>Teacher invitations</option>
        <option value="student_awaiting_approval" <%= 'selected' if @type_filter == 'student_awaiting_approval' %>>Student invitations</option>
        <option value="report_ready" <%= 'selected' if @type_filter == 'report_ready' %>>Reports</option>
        <option value="reminder" <%= 'selected' if @type_filter == 'reminder' %>>Reminders</option>
        <option value="alert" <%= 'selected' if @type_filter == 'alert' %>>Alerts</option>
      </select>
    </label>
    <label>
      <span>Status</span>
      <select id="notification-status-filter">
        <option value="unread" <%= 'selected' if @status_filter == 'unread' %>>Unread</option>
        <option value="archived" <%= 'selected' if @status_filter == 'archived' %>>Archived</option>
      </select>
    </label>
  </div>

  <div class="notifications-board__list" id="notifications-list">
    <% if @notifications.any? %>
      <% @notifications.each do |notification| %>
        <article class="notification-card" data-notification-type="<%= notification[:type] %>" data-notification-id="<%= notification[:id] %>">
          <header class="notification-card__header">
            <div>
              <h3><%= notification[:title] %></h3>
              <p><%= notification[:message] %></p>
            </div>
            <span class="notification-card__badge"><%= notification[:time_ago] %> ago</span>
          </header>
          <div class="notification-card__actions">
            <% notification[:actions].each do |action| %>
              <% if action[:url] %>
                <%= link_to action[:label], action[:url], class: "notification-card__action #{'notification-card__action--primary' if action[:primary]}" %>
              <% elsif action[:action] %>
                <button class="notification-card__action" type="button" data-action="<%= action[:action] %>" <%= "data-notification-id=#{action[:data][:notification_id]}" if action[:data]&.dig(:notification_id) %>>
                  <%= action[:label] %>
                </button>
              <% end %>
            <% end %>
          </div>
        </article>
      <% end %>
    <% else %>
      <div class="notifications-empty">
        <p>No notifications</p>
      </div>
    <% end %>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const typeFilter = document.getElementById('notification-type-filter');
    const statusFilter = document.getElementById('notification-status-filter');
    const notificationsList = document.getElementById('notifications-list');
    const notificationCards = notificationsList.querySelectorAll('.notification-card');

    function filterNotifications() {
      const selectedType = typeFilter.value;
      const selectedStatus = statusFilter.value;

      notificationCards.forEach(card => {
        const cardType = card.getAttribute('data-notification-type');
        let showCard = true;

        if (selectedType !== 'all' && cardType !== selectedType) {
          showCard = false;
        }

        // For now, we only show unread notifications
        // In the future, we can add archived status tracking
        if (selectedStatus === 'archived') {
          showCard = false;
        }

        card.style.display = showCard ? '' : 'none';
      });
    }

    if (typeFilter) {
      typeFilter.addEventListener('change', function() {
        // Reload page with new type filter
        const selectedType = this.value;
        const url = new URL(window.location);
        url.searchParams.set('type', selectedType);
        window.location.href = url.toString();
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener('change', function() {
        // Reload page with new status filter
        const selectedStatus = this.value;
        const url = new URL(window.location);
        url.searchParams.set('status', selectedStatus);
        window.location.href = url.toString();
      });
    }

    // Handle "Mark as read" actions
    notificationsList.addEventListener('click', async function(e) {
      const button = e.target.closest('[data-action="mark_read"]');
      if (!button) return;

      const notificationId = button.getAttribute('data-notification-id');
      const card = button.closest('.notification-card');
      
      if (!notificationId || !card) return;

      // Disable button during request
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Processing...';

      try {
        // Use form submission for admin panel (no API client needed)
        const formData = new FormData();
        formData.append('notification_id', notificationId);
        formData.append('authenticity_token', document.querySelector('meta[name="csrf-token"]').content);

        const response = await fetch('/admin/notifications/mark_as_read', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        const result = await response.json();

        if (result.success) {
          // Hide the notification card
          card.style.display = 'none';
          
          // Update notification counter in header
          const headerCounter = document.querySelector('.dashboard-top-actions .notification-counter');
          if (headerCounter) {
            const currentCount = parseInt(headerCounter.textContent) || 0;
            const newCount = Math.max(0, currentCount - 1);
            if (newCount > 0) {
              headerCounter.textContent = newCount;
              headerCounter.style.display = '';
            } else {
              headerCounter.style.display = 'none';
            }
          }
        } else {
          alert('Error: ' + (result.error || 'Failed to mark notification as read'));
          button.disabled = false;
          button.textContent = originalText;
        }
      } catch (error) {
        console.error('Failed to mark notification as read:', error);
        alert('Error: ' + (error.message || 'Unknown error'));
        button.disabled = false;
        button.textContent = originalText;
      }
    });
  });
</script>

